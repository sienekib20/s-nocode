class _hydrometer{constructor(e="NOVO*",t=5e3,o=-1,n="1",r="",a="",i="FUNCIONA",s="",d="",l="15",c="",u="2021-08-01",m="2021-08-01",E=0,y=1,R="",p=1,h="",g="",S=0,T=1){this.id=e,this.companyid=t,this.dependencyid=o,this.hydrometerid=n,this.contractid=r,this.customerid=a,this.functionalstatus=i,this.brand=s,this.hydrometertype=d,this.diameter=l,this.classification=c,this.manufacturedate=u,this.installationdate=m,this.installationrecord=E,this.hydrometerstatus=y,this.cilserie=R,this.cilsequencenumber=p,this.cil=h,this.companyname=g,this.statususer=S,this.status=T}}class _hydrometerRecord{constructor(e=0,t=-1,o="NOVA*",n="",r="",a="",i="2021-08-01",s=0,d=0,l="2021-08-01",c=0,u=0,m=0,E=0,y=0){this.companyid=e,this.dependencyid=t,this.hydrometerrecordid=o,this.hydrometerid=n,this.contractid=r,this.customerid=a,this.recorddate=i,this.recordvalue=s,this.amount=d,this.beforerecorddate=l,this.beforerecordvalue=c,this.days=u,this.cmd=m,this.customerportalstatus=E,this.statususer=y}}class _consumptionEstimated{constructor(e=0,t=-1,o="NOVA*",n="",r="",a="2021-08-01",i="2021-08-31",s=0,d=0,l=0,c=0){this.companyid=e,this.dependencyid=t,this.estimatedid=o,this.contractid=n,this.customerid=r,this.estimateddate1=a,this.estimateddate2=i,this.amount=s,this.days=d,this.cmd=l,this.statususer=c}}var HYDROMETER_NEW=new _hydrometer,CONSUMPTION_ESTIMATED_DEFAULT=[];function hydrometerRegisterOnLoad(){checkUserStatusAfterExecute(function(){fillSelectHydrometerFunctionalStatus("selHydroRegHydrometerFunctionalStatus"),fillSelectHydrometerDiameter("selHydroRegDiameter"),fillSelectConsumerTypeAqua("selHydroRegConsumerType"),fillSelectCustomerType("selHydroRegCustomerType"),fillSelectProvince("selHydroRegProvince",1,SYSTEM_USER_STATUS.provinceId),fillSelectMunicipality("selHydroRegMunicipality",SYSTEM_USER_STATUS.provinceId,-1)})}function hydrometerNewHydrometer(e){showParts("divHydroDetail"),hydrometerGetHydrometerDetails(-1,e)}function hydrometerGetHydrometerDetails(e,t=null){const o=document.getElementById("lbHydroRegHeader"),n=document.getElementById("txtHydroRegHydrometerId"),r=document.getElementById("selHydroRegHydrometerFunctionalStatus"),a=document.getElementById("selHydroRegBrand"),i=document.getElementById("selHydroRegHydrometerType"),s=document.getElementById("selHydroRegDiameter"),d=document.getElementById("txtHydroRegClassification"),l=document.getElementById("txtHydroRegManufactureDate"),c=document.getElementById("txtHydroRegInstallationDate"),u=document.getElementById("txtHydroRegInstallationRecord"),m=document.getElementById("selHydroRegHydrometerStatus"),E=document.getElementById("txtHydroRegContractId"),y=document.getElementById("txtHydroRegContractDate"),R=document.getElementById("selHydroRegConsumerType"),p=document.getElementById("txtHydroRegCIL"),h=document.getElementById("txtHydroRegCustomerID"),g=document.getElementById("selHydroRegCustomerType"),S=document.getElementById("txtHydroRegCompanyName"),T=document.getElementById("txtHydroRegCompanyTaxId"),f=document.getElementById("selHydroRegMunicipality"),H=document.getElementById("txtHydroRegComuna"),C=document.getElementById("txtHydroRegNeiborhood"),I=document.getElementById("txtHydroRegStreet"),L=document.getElementById("txtHydroRegBlock"),v=document.getElementById("txtHydroRegBuidNumber"),N=document.getElementById("txtHydroRegPostalCode"),b=document.getElementById("lbHydroRegUpdateBy");if(showParts("btHydroDetSave",!0),hideParts("btHydroDetCancel"),HYDROMETER_NEW=new _hydrometer,-1==e){var D=new Date;HYDROMETER_NEW.id="NOVO*",o.innerHTML="NOVO CONTADOR",n.value="",r.value="FUNCIONA",s.value="15",d.value="",l.value=setLocalDate(D,10),c.value=setLocalDate(D,10),u.value=0,m.value=1,E.value=t.contractid,y.value=setLocalDate(t.contractdate,10),R.value=t.consumertype,p.value=t.cil,h.value=t.customerid,g.value=t.customertype,S.value=t.companyname,T.value=t.customertaxid,f.value=t.billingmunicipality,H.value=t.billingcomuna,C.value=t.billingneiborhood,I.value=t.billingstreetname,L.value=t.billingblock,v.value=t.billingbuildingnumber,N.value=t.billingpostalcode,b.innerHTML="Data de actualizaçao: "+setLocalDate(D,16)}else{o.innerHTML="DETALHES DO CONTADOR";var _=SYSTEM_USER_STATUS.companyId,M=new XMLHttpRequest,O="action=getHydrometerDetails&companyId="+_+"&hydrometerId="+e,w=URL_SA_HYDROMETER_X;M.open("POST",w,!0),M.setRequestHeader("Content-type","application/x-www-form-urlencoded"),M.onreadystatechange=function(){if(4==M.readyState&&200==M.status){var e=JSON.parse(this.responseText);HYDROMETER_NEW.id=e.id,n.value=e.hydrometerid,r.value=e.functionalstatus,a.value=e.brand,i.value=e.hydrometertype,s.value=e.diameter,d.value=e.classification,l.value=setLocalDate(e.manufacturedate,10),c.value=setLocalDate(e.installationdate,10),u.value=e.installationrecord,m.value=e.hydrometerstatus,E.value=e.contractid,y.value=setLocalDate(e.contractdate,10),R.value=e.consumertype,p.value=e.cil,h.value=e.customerid,g.value=e.customertype,S.value=e.companyname,T.value=e.customertaxid,f.value=e.billingmunicipality,H.value=e.billingcomuna,C.value=e.billingneiborhood,I.value=e.billingstreetname,L.value=e.billingblock,v.value=e.billingbuildingnumber,N.value=e.billingpostalcode,b.innerHTML="Cadastrado por "+getOperatorName(e.operatorEntry,e.entryuser)+" em "+setLocalDate(e.entrydate,16)+". <br>Actualizado por "+getOperatorName(e.operatorName,e.statususer)+" em "+setLocalDate(e.statusdate,16);var t=e.hydrometerstatus;1!=t&&hideParts("btHydroDetSave"),checkPermission("3202")&&3!=t&&showParts("btHydroDetCancel",!0)}},M.send(O)}setAutoCompleteToFiel("txtHydroRegHydrometerId",60,1),setAutoCompleteToFiel("txtHydroRegClassification",62,1),fillSelecthydrometrBrand("selHydroRegBrand"),dispatchOnInputChange()}function hydrometerRegisterSave(e){var t=!1,o="";if(HYDROMETER_NEW.companyid=SYSTEM_USER_STATUS.companyId,HYDROMETER_NEW.dependencyid=SYSTEM_USER_STATUS.workplaceId,HYDROMETER_NEW.hydrometerid=reviewString(document.getElementById("txtHydroRegHydrometerId")).toUpperCase(),HYDROMETER_NEW.contractid=getElementValue("txtHydroRegContractId"),HYDROMETER_NEW.customerid=getElementValue("txtHydroRegCustomerID"),HYDROMETER_NEW.functionalstatus=getElementValue("selHydroRegHydrometerFunctionalStatus"),HYDROMETER_NEW.brand=getElementValue("selHydroRegBrand"),HYDROMETER_NEW.hydrometertype=getElementValue("selHydroRegHydrometerType"),HYDROMETER_NEW.diameter=getElementValue("selHydroRegDiameter"),HYDROMETER_NEW.classification=reviewString(document.getElementById("txtHydroRegClassification")).toUpperCase(),HYDROMETER_NEW.manufacturedate=getElementValue("txtHydroRegManufactureDate"),HYDROMETER_NEW.installationdate=getElementValue("txtHydroRegInstallationDate"),HYDROMETER_NEW.installationrecord=Number(getElementValue("txtHydroRegInstallationRecord")),HYDROMETER_NEW.hydrometerstatus=1,HYDROMETER_NEW.statususer=SYSTEM_USER_STATUS.userId,""==HYDROMETER_NEW.hydrometerid&&(t=!0,o+="Deve indicar número do contador. <br>"),""==HYDROMETER_NEW.contractid&&(t=!0,o+="Deve indicar o número do Contrato. <br>"),""==HYDROMETER_NEW.customerid&&(t=!0,o+="Deve indicar o número do cliente. <br>"),validateDate(new Date(HYDROMETER_NEW.manufacturedate))||(t=!0,o+="Data de fabrico fora do formato. <br>"),validateDate(new Date(HYDROMETER_NEW.installationdate))||(t=!0,o+="Data de instalação fora do formato. <br>"),isNaN(HYDROMETER_NEW.installationrecord)?(t=!0,o+="Leitura de instalação deve ser númerica. <br>"):HYDROMETER_NEW.installationrecord<0&&(t=!0,o+="Leitura de instalação deve ser superior a zero. <br>"),1==ST_SA_WAITING_SERVER&&(t=!0,o+="Aguardando resposta do servidor. <br>"),t)return alert(o),!1;showNotification(),ST_SA_WAITING_SERVER=1;var n=new XMLHttpRequest,r="action=saveHydrometerRegister&hydrometerInfo="+JSON.stringify(HYDROMETER_NEW),a=URL_SA_HYDROMETER_X;n.open("POST",a,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==this.readyState&&200==this.status){ST_SA_WAITING_SERVER=0;var t=JSON.parse(n.responseText);1==t.status?(showNotification(t.msg,1),"HYDROLIS"==e&&hydrometerListDetails(HYDROMETER_NEW.customerid),hideParts("divHydroDetail")):showNotification(t.msg,0)}},n.send(r)}function hydrometerListOnLoad(){try{showNotification(),checkUserStatusAfterExecute(function(){setLinkRequestStatus(),fillSelectDependencyFull("selHydroLisDependency",-1,1),fillSelectConsumerTypeAqua("selHydroLisConsumerType",-1),fillSelectHydrometerFunctionalStatus("selHydroLisFunctionalStatus",-1),fillSelectMunicipality("selHydroLisMunicipality",SYSTEM_USER_STATUS.provinceId,-1,-1),fillSelectNeiborhood("selHydroLisNeiborhood",3,-1),setTriggerButtonByText("txtHydroLisInitialDate","btHydroLisViewAll"),setTriggerButtonByText("txtHydroLisEndDate","btHydroLisViewAll"),document.getElementById("chbHydroLisShowDate").onclick=function(){setEnableDisableByCheckBox(this.id,"txtHydroLisInitialDate","txtHydroLisEndDate")},checkPermission("3201")?showParts("btHydroLisNewContract",!0):hideParts("btHydroLisNewContract");var e=sessionStorage.getItem("contract_to_hydrometer");if(null!=e&&""!=e){var t=document.getElementById("btHydroLisPending");showParts(t.id,!0),t.onclick=function(){hydrometerNewHydrometer(JSON.parse(e)),hideParts(t.id)},sessionStorage.setItem("customer_to_contract","")}hydrometerListDetails(),hideNotification()})}catch(e){showNotification(e.message,0)}}function hydrometerListDetails(e=-1,t=-1){try{var o={};if(o.companyId=SYSTEM_USER_STATUS.companyId,o.dependencyId=getElementValue("selHydroLisDependency"),o.dependencyId<=0&&Number(SYSTEM_USER_STATUS.billingprofile)<BILLING_PROFILE_PARTNER_INDEX)return showNotification("Seleccionar uma filial.",0),!1;o.filterByDate=getElementChecked("chbHydroLisShowDate"),o.initialDate=getElementValue("txtHydroLisInitialDate"),o.endDate=getElementValue("txtHydroLisEndDate"),o.consumertype=getElementValue("selHydroLisConsumerType"),o.functionalStatus=getElementValue("selHydroLisFunctionalStatus"),o.municipalityId=getElementValue("selHydroLisMunicipality"),o.neiborhood=getElementValue("selHydroLisNeiborhood"),o.customerid=e,o.userId=t,o.onlynumber=1,o.startIdx=0,o.endIdx=0,showNotification();var n=new XMLHttpRequest,r="action=getHydrometerListDetails&filterInfo="+JSON.stringify(o),a=URL_SA_HYDROMETER_X;n.open("POST",a,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==n.readyState&&200==n.status){var e=JSON.parse(this.responseText).n;e<=0?showNotification("Não encontrado.",0):hideDivFilter();var t=document.getElementById("numResultPageNumber"),r=document.getElementById("numResultItems");function a(){var n=Number(t.value),a=Number(r.value),i=(n-1)*a,s=i+a;s>e&&(s=e),o.totalItems=e,o.startIdx=i,o.endIdx=s,o.onlynumber=0,hydrometerListFilter(o)}t.value=1,setResultTotalPages(t.id,r.id,e),t.onchange=function(){a()},r.onchange=function(){setResultTotalPages(t.id,r.id,e),a()},a()}},n.send(r)}catch(e){showNotification(e.message,0)}}function hydrometerListFilter(e){try{showNotification();var t=new XMLHttpRequest,o="action=getHydrometerListDetails&filterInfo="+JSON.stringify(e),n=URL_SA_HYDROMETER_X;t.open("POST",n,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){if(4==t.readyState&&200==t.status){try{var o=JSON.parse(this.responseText)}catch(e){showHttpResponseText(t)}var n={},r={},a={};setElementInnerHtml("lbResultOnList",e.endIdx+" / "+e.totalItems);let h=document.getElementById("tblHydroLisListTable");h.innerHTML="";for(var i=e.startIdx,s=0;s<o.length;s++){var d=o[s];let e=JSON.parse(d);var l=CONSUMER_TYPE_AQUA[Number(e.consumertype)],c=e.functionalstatus,u=e.billingneiborhood,m=getOperatorName(e.operatorName,e.statususer);addAmountResume(n,l,1),addAmountResume(r,c,1),addAmountResume(a,u,1),i+=1;let t=h.insertRow(-1);t.id="trHydroList"+e.hydrometerid,t.setAttribute("class","borderGray"+setSelectedRowBackground("SELECTED_ROW_HYDROMETER_LIST",t.id));let p=t.insertCell(-1);p.setAttribute("class","colRowNumber"),p.innerHTML=i;let g=t.insertCell(-1);g.setAttribute("class","colProductId"),g.innerHTML=e.hydrometerid;let S=t.insertCell(-1);S.setAttribute("class","colProductId"),S.innerHTML=setLocalDate(e.installationdate,10),t.insertCell(-1).innerHTML=e.brand;let T=t.insertCell(-1);T.setAttribute("class","colProductId"),T.innerHTML=e.hydrometertype;let f=t.insertCell(-1);f.setAttribute("class","colProductId"),f.innerHTML=e.diameter,t.insertCell(-1).innerHTML=c;let H=t.insertCell(-1);H.setAttribute("class","colProductId"),H.innerHTML=setLocalDate(e.lastrecord,10),t.insertCell(-1).innerHTML=l;let C=t.insertCell(-1);C.setAttribute("class","colProductId"),C.innerHTML=e.contractid,t.insertCell(-1).innerHTML=e.companyname+" ["+e.customerid+"]",t.insertCell(-1).innerHTML=e.billingMunicipality,t.insertCell(-1).innerHTML=u;var E="black",y="c ",R=e.hydrometerstatus;2==R?y="textUpperUcase textBold":3==R&&(E="red");let I=t.insertCell(-1);I.setAttribute("class",y),I.innerHTML=1==e.hydrometerstatus?"Activo":"Anulado",I.style.color=E;let L=t.insertCell(-1);L.setAttribute("class","colProductId"),L.innerHTML=setLocalDate(e.statusdate,16);let v=t.insertCell(-1);v.setAttribute("class","colProductId"),v.innerHTML=m;let N=t.insertCell(-1);N.setAttribute("class","noPrint");let b=document.createElement("button");b.type="button",b.setAttribute("class","labelDetail");const D=e.hydrometerid;b.onclick=function(){hydrometerEditHydrometer(D),setSelectedRowOnClick(t,"SELECTED_ROW_HYDROMETER_LIST")},N.appendChild(b);let _=document.createElement("button");if(_.setAttribute("class","labelPrint"),_.type="button",_.onclick=function(){setSelectedRowOnClick(t,"SELECTED_ROW_HYDROMETER_LIST"),sessionStorage.setItem("hydrometer_to_print",JSON.stringify(e)),window.open("printHydrometerLayoutA4.php")},N.appendChild(_),checkPermission("3210")){let o=document.createElement("button");o.innerHTML="Leitura",o.type="button",o.onclick=function(){setSelectedRowOnClick(t,"SELECTED_ROW_HYDROMETER_LIST"),sessionStorage.setItem("hydrometer_to_record",JSON.stringify(e)),window.location.assign("HydrometerRecordList.php")},N.appendChild(o)}}var p=document.getElementById("tblHydroLisResumeTable");for(var d in p.innerHTML="",i=0,n)i+=1,resume(p,i,"Tipo de consumidor",n,d,"Contadores");for(var d in i=0,r)i+=1,resume(p,i,"Estado da funcional",r,d,"Contadores");for(var d in i=0,a)i+=1,resume(p,i,"Bairro",a,d,"Contadores");hideNotification()}},t.send(o)}catch(e){showNotification(e.message,0)}}function hydrometerEditHydrometer(e){showParts("divHydroDetail"),hydrometerGetHydrometerDetails(e)}function hydrometerCancelhydrometer(){showConfirm("Tem a certeza que deseja APAGAR este contador? <br>Esta acção não vai apagar as leituras anteriores.",function(){showNotification();var e=HYDROMETER_NEW.id,t=SYSTEM_USER_STATUS.userId,o=new XMLHttpRequest,n="action=cancelStatusHydrometer&hydrometerId="+e+"&userId="+t,r=URL_SA_HYDROMETER_X;o.open("POST",r,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(o.responseText);1==e.status?(showNotification(e.msg,1),hydrometerListDetails(),hideParts("divHydroDetail")):showNotification(e.msg,0)}},o.send(n)})}function hydrometerSearchOnLoad(e){checkUserStatusAfterExecute(function(){setWaterLinkStatus(),fillSelectConsumerTypeAqua("selHydroSearConsumerType",-1),fillSelectNeiborhood("selHydroSearNeiborhood",3,-1),setTriggerButtonByText("txtHydroSearSearchHydrometer","btHydroSearSearch"),setSessionResultSearch("txtHydroSearSearchHydrometer"),setSessionResultSearch("numHydroSearSearchLimit"),contractAutocompleteList("txtHydroSearSearchHydrometer",e)})}function hydrometerRecordNewRecord(e){if(3==e.waterlinkstatus)return alert("Ligação de água suspensa. Não poderá lançar leituras."),!1;showParts("divHydroRecordDetail"),hydrometerRecordGetRecordDetails(-1,e)}function hydrometerRecordRegisterOnLoad(){checkUserStatusAfterExecute(function(){fillSelectHydrometerRecordStatus("selHydroRecRegRecordStatus"),fillSelectHydrometerFunctionalStatus("selHydroRecRegHydrometerFunctionalStatus"),fillSelectProvince("selHydroRecRegProvince",1,SYSTEM_USER_STATUS.provinceId),fillSelectMunicipality("selHydroRecRegMunicipality",SYSTEM_USER_STATUS.provinceId,-1),document.getElementById("txtHydroRecRegRecordDate").oninput=function(){hydrometerRecordRecordOnChange()},document.getElementById("txtHydroRecRegRecordValue").onchange=function(){hydrometerRecordRecordOnChange()},document.getElementById("txtHydroRecRegLastRecordDate").oninput=function(){hydrometerRecordRecordOnChange()},document.getElementById("txtHydroRecRegLastRecordValue").onchange=function(){hydrometerRecordRecordOnChange()}})}function hydrometerRecordGetRecordDetails(e,t=null){const o=document.getElementById("lbHydroRecRegHeader"),n=document.getElementById("txtHydroRecRegRecordId"),r=document.getElementById("txtHydroRecRegRecordDate"),a=document.getElementById("txtHydroRecRegRecordValue"),i=document.getElementById("txtHydroRecRegAmount"),s=document.getElementById("txtHydroRecRegLastRecordDate"),d=document.getElementById("txtHydroRecRegLastRecordValue"),l=document.getElementById("txtHydroRecRegDays"),c=document.getElementById("txtHydroRecRegCMD"),u=document.getElementById("selHydroRecRegRecordStatus"),m=document.getElementById("txtHydroRecRegHydrometerId"),E=document.getElementById("selHydroRecRegHydrometerFunctionalStatus"),y=document.getElementById("txtHydroRecRegContractId"),R=document.getElementById("txtHydroRecRegCIL"),p=document.getElementById("txtHydroRecRegCustomerID"),h=document.getElementById("txtHydroRecRegCompanyName"),g=document.getElementById("selHydroRecRegMunicipality"),S=document.getElementById("txtHydroRecRegComuna"),T=document.getElementById("txtHydroRecRegNeiborhood"),f=document.getElementById("txtHydroRecRegStreet"),H=document.getElementById("txtHydroRecRegBlock"),C=document.getElementById("txtHydroRecRegBuidNumber"),I=document.getElementById("txtHydroRecRegPostalCode"),L=document.getElementById("lbHydroRecRegUpdateBy");if(showParts("btHydroRecDetSave",!0),hideParts("btHydroRecDetCancel"),-1==e){var v=new Date;o.innerHTML="NOVA LEITURA";var N=new Date(t.lastrecorddate),b=N.getFullYear(),D=N.getMonth()+1;D>=12&&(b+=1,D=0),N.setFullYear(b),N.setMonth(D),n.value="NOVA*",r.value=setLocalDate(N,10),r.disabled="",a.value=0,i.value=0,s.value=setLocalDate(t.lastrecorddate,10),d.value=Number(t.lastrecordvalue).toFixed(2),l.value=0,c.value=0,u.value=1,m.value=t.hydrometerid,E.value=t.functionalstatus,y.value=t.contractid,R.value=t.cil,p.value=t.customerid,h.value=t.companyname,g.value=t.billingmunicipality,S.value=t.billingcomuna,T.value=t.billingneiborhood,f.value=t.billingstreetname,H.value=t.billingblock,C.value=t.billingbuildingnumber,I.value=t.billingpostalcode,L.innerHTML="Data de actualizaçao: "+setLocalDate(v,16),hydrometerRecordGetRecordHistoric(t.contractid)}else{o.innerHTML="DETALHES DA LEITURA",checkPermission("3212")?r.disabled="":r.disabled="true";var _=SYSTEM_USER_STATUS.companyId,M=new XMLHttpRequest,O="action=getHydrometerRecordDetails&companyId="+_+"&recordId="+e,w=URL_SA_HYDROMETER_X;M.open("POST",w,!0),M.setRequestHeader("Content-type","application/x-www-form-urlencoded"),M.onreadystatechange=function(){if(4==M.readyState&&200==M.status){try{var e=JSON.parse(this.responseText)}catch(e){showHttpResponseText(M)}n.value=e.id,r.value=setLocalDate(e.recorddate,10),a.value=Number(e.recordvalue).toFixed(2),i.value=Number(e.amount).toFixed(2),s.value=setLocalDate(e.beforerecorddate,10),d.value=Number(e.beforerecordvalue).toFixed(2),l.value=e.days,c.value=Number(e.cmd).toFixed(2),u.value=e.recordstatus,m.value=e.hydrometerid,E.value=e.functionalstatus,y.value=e.contractid,R.value=e.cil,p.value=e.customerid,h.value=e.companyname,g.value=e.billingmunicipality,S.value=e.billingcomuna,T.value=e.billingneiborhood,f.value=e.billingstreetname,H.value=e.billingblock,C.value=e.billingbuildingnumber,I.value=e.billingpostalcode,L.innerHTML="Cadastrado por "+getOperatorName(e.operatorEntry,e.entryuser)+" em "+setLocalDate(e.entrydate,16)+". <br>Actualizado por "+getOperatorName(e.operatorName,e.statususer)+" em "+setLocalDate(e.statusdate,16),hydrometerRecordGetRecordHistoric(e.contractid,e.id),1!=e.recordstatus&&hideParts("btHydroRecDetSave"),checkPermission("3202")&&showParts("btHydroRecDetCancel",!0)}},M.send(O)}checkPermission("3212")?(s.disabled="",d.disabled=""):(s.disabled="true",d.disabled="true"),r.focus(),dispatchOnInputChange()}function hydrometerRecordGetRecordHistoric(e,t=-1){var o=SYSTEM_USER_STATUS.companyId,n=new XMLHttpRequest,r="action=getHydrometerRecordHistoric&companyId="+o+"&contractid="+e,a=URL_SA_HYDROMETER_X;n.open("POST",a,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==n.readyState&&200==n.status){try{var e=JSON.parse(this.responseText)}catch(e){showHttpResponseText(n)}let a=document.getElementById("tblHydroRecRegHistoric");a.innerHTML="";for(var o=0;o<e.length;o++){var r=e[o];let n=JSON.parse(r),i=a.insertRow(-1);i.setAttribute("class","borderGray"),n.id==t&&(i.style.fontWeight="bold");let s=i.insertCell(-1);s.setAttribute("class","colProductId"),s.innerHTML=setLocalDate(n.recorddate,10);let d=i.insertCell(-1);d.setAttribute("class","colProductId"),d.innerHTML=formatNumber(n.recordvalue);let l=i.insertCell(-1);l.setAttribute("class","colProductId"),l.innerHTML=formatNumber(n.amount)}}},n.send(r)}function hydrometerRecordRecordOnChange(){var e=Number(getElementValue("txtHydroRecRegRecordValue")),t=Number(getElementValue("txtHydroRecRegLastRecordValue")),o=Number(dateDiffDays(getElementValue("txtHydroRecRegRecordDate"),getElementValue("txtHydroRecRegLastRecordDate")));(isNaN(e)||e<=0)&&showNotification("Deve indicar uma leitura válida",0),(isNaN(t)||t<0)&&showNotification("Deve indicar a leitura anterior válida",0),(isNaN(o)||o<=0)&&showNotification("Data de leitura ou data de leitura anterior inválida",0);var n=Number(e-t),r=n/o*1e3;setElementValue("txtHydroRecRegAmount",n.toFixed(2)),setElementValue("txtHydroRecRegDays",o),setElementValue("txtHydroRecRegCMD",r.toFixed(4))}function hydrometerRecordRegisterSave(e){var t=!1,o="",n=new _hydrometerRecord;if(n.companyid=SYSTEM_USER_STATUS.companyId,n.dependencyid=SYSTEM_USER_STATUS.workplaceId,n.hydrometerrecordid=getElementValue("txtHydroRecRegRecordId"),n.hydrometerid=getElementValue("txtHydroRecRegHydrometerId"),n.contractid=getElementValue("txtHydroRecRegContractId"),n.customerid=getElementValue("txtHydroRecRegCustomerID"),n.recorddate=getElementValue("txtHydroRecRegRecordDate"),n.recordvalue=getElementValue("txtHydroRecRegRecordValue"),n.amount=getElementValue("txtHydroRecRegAmount"),n.beforerecorddate=getElementValue("txtHydroRecRegLastRecordDate"),n.beforerecordvalue=getElementValue("txtHydroRecRegLastRecordValue"),n.days=getElementValue("txtHydroRecRegDays"),n.cmd=getElementValue("txtHydroRecRegCMD"),n.statususer=SYSTEM_USER_STATUS.userId,validateDate(new Date(n.recorddate))||(t=!0,o+="Data de leitura fora do formato. <br>"),Number(n.amount)<=0&&(t=!0,o+="A data da leitura deve ser superior a data da leitura anterior. <br>"),Number(n.cmd)<=0&&(t=!0,o+="A leitura deve ser superior a leitura anterior. <br>"),""==n.hydrometerid&&(t=!0,o+="Deve indicar número do contador. <br>"),""==n.contractid&&(t=!0,o+="Deve indicar o número do Contrato. <br>"),""==n.customerid&&(t=!0,o+="Deve indicar o número do cliente. <br>"),1==ST_SA_WAITING_SERVER&&(t=!0,o+="Aguardando resposta do servidor. <br>"),t)return alert(o),!1;showNotification(),ST_SA_WAITING_SERVER=1;var r=new XMLHttpRequest,a="action=saveHydrometerRecordRegister&hydrometerRecordInfo="+JSON.stringify(n),i=URL_SA_HYDROMETER_X;r.open("POST",i,!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.onreadystatechange=function(){if(4==this.readyState&&200==this.status){ST_SA_WAITING_SERVER=0;try{var t=JSON.parse(r.responseText)}catch(e){return showHttpResponseText(r),!1}1==t.status?(showNotification(t.msg,1),"HYDRORECLIS"==e&&hydrometerRecordListDetails(n.customerid),hideParts("divHydroRecordDetail")):showNotification(t.msg,0)}},r.send(a)}function hydrometerRecordListOnLoad(){try{showNotification(),checkUserStatusAfterExecute(function(){setLinkRequestStatus(),fillSelectDependencyFull("selHydroRecLisDependency",-1,1),fillSelectConsumerTypeAqua("selHydroRecLisConsumerType",-1),fillSelectMunicipality("selHydroRecLisMunicipality",SYSTEM_USER_STATUS.provinceId,-1,-1),fillSelectNeiborhood("selHydroRecLisNeiborhood",3,-1),setTriggerButtonByText("txtHydroRecLisInitialDate","btHydroRecLisViewAll"),setTriggerButtonByText("txtHydroRecLisEndDate","btHydroRecLisViewAll"),document.getElementById("chbHydroRecLisShowDate").onclick=function(){setEnableDisableByCheckBox(this.id,"txtHydroRecLisInitialDate","txtHydroRecLisEndDate")},checkPermission("3210")?showParts("btHydroRecLisNewContract",!0):hideParts("btHydroRecLisNewContract");var e=sessionStorage.getItem("hydrometer_to_record");if(null!=e&&""!=e){var t=document.getElementById("btHydroRecLisPending");showParts(t.id,!0),t.onclick=function(){var o=JSON.parse(e);hydrometerRecordNewRecord(o),hydrometerRecordListDetails(o.customerid),hideParts(t.id)},sessionStorage.setItem("hydrometer_to_record","")}hydrometerRecordListDetails(),hideNotification()})}catch(e){showNotification(e.message,0)}}function hydrometerRecordListDetails(e=-1,t=-1){try{if(1==ST_SA_LISTING_SERVER)return showNotification("Procurando...",1),!1;var o={};if(o.companyId=SYSTEM_USER_STATUS.companyId,o.dependencyId=getElementValue("selHydroRecLisDependency"),o.dependencyId<=0&&Number(SYSTEM_USER_STATUS.billingprofile)<BILLING_PROFILE_PARTNER_INDEX)return showNotification("Seleccionar uma filial.",0),!1;o.filterByDate=getElementChecked("chbHydroRecLisShowDate"),o.initialDate=getElementValue("txtHydroRecLisInitialDate"),o.endDate=getElementValue("txtHydroRecLisEndDate"),o.consumertype=getElementValue("selHydroRecLisConsumerType"),o.municipalityId=getElementValue("selHydroRecLisMunicipality"),o.neiborhood=getElementValue("selHydroRecLisNeiborhood"),o.customerid=e,o.userId=t,o.onlynumber=1,o.startIdx=0,o.endIdx=0,showNotification(),ST_SA_LISTING_SERVER=1;var n=new XMLHttpRequest,r="action=getHydrometerRecordListDetails&filterInfo="+JSON.stringify(o),a=URL_SA_HYDROMETER_X;n.open("POST",a,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==n.readyState&&200==n.status){ST_SA_LISTING_SERVER=0;try{var e=JSON.parse(this.responseText)}catch(e){return showHttpResponseText(n),!1}var t=e.n;t<=0?showNotification("Não encontrado.",0):hideDivFilter(),cleanElement("tblHydroRecLisListTable");var r=document.getElementById("numResultPageNumber"),a=document.getElementById("numResultItems");function i(){var e=Number(r.value),n=Number(a.value),i=(e-1)*n,s=i+n;s>t&&(s=t),o.onlynumber=0,o.totalItems=t,o.startIdx=i,o.endIdx=s,hydrometerRecordListDetailsResult(o)}r.value=1,setResultTotalPages(r.id,a.id,t),r.onchange=function(){i()},a.onchange=function(){setResultTotalPages(r.id,a.id,t),i()},i()}},n.send(r)}catch(e){showNotification(e.message,0)}}function hydrometerRecordListDetailsResult(e){showNotification();var t=new XMLHttpRequest,o="action=getHydrometerRecordListDetails&filterInfo="+JSON.stringify(e),n=URL_SA_HYDROMETER_X;t.open("POST",n,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){if(4==t.readyState&&200==t.status){ST_SA_LISTING_SERVER=0;try{var o=JSON.parse(this.responseText)}catch(e){return showHttpResponseText(t),!1}var n={},r={};setElementInnerHtml("lbResultOnList",e.endIdx+" / "+e.totalItems);let R=document.getElementById("tblHydroRecLisListTable");R.innerHTML="";for(var a=e.startIdx,i=0;i<o.length;i++){var s=o[i];let e=JSON.parse(s);var d=CONSUMER_TYPE_AQUA[Number(e.consumertype)],l=e.billingneiborhood;-2==e.statususer&&(e.operatorName="Cliente / Portal");var c=getOperatorName(e.operatorName,e.statususer);addAmountResume(n,d,1),addAmountResume(r,l,1),a+=1;let t=R.insertRow(-1);t.id="trHydroRecList"+e.id,t.setAttribute("class","borderGray"+setSelectedRowBackground("SELECTED_ROW_HYDROMETER_RECORD_LIST",t.id));let y=t.insertCell(-1);y.setAttribute("class","colRowNumber"),y.innerHTML=a;let p=t.insertCell(-1);p.setAttribute("class","colProductId"),p.innerHTML=e.id;let h=t.insertCell(-1);h.setAttribute("class","colProductId"),h.innerHTML=setLocalDate(e.recorddate,10);let g=t.insertCell(-1);g.setAttribute("class","colProductId"),g.innerHTML=e.recordvalue;let S=t.insertCell(-1);S.setAttribute("class","colProductId"),S.innerHTML=e.amount;let T=t.insertCell(-1);T.setAttribute("class","colProductId"),T.innerHTML=e.days;let f=t.insertCell(-1);f.setAttribute("class","colProductId"),f.innerHTML=formatNumber(e.cmd);let H=t.insertCell(-1);H.setAttribute("class","colProductId"),H.innerHTML=e.hydrometerid;let C=t.insertCell(-1);C.setAttribute("class","colProductId"),C.innerHTML=e.contractid,t.insertCell(-1).innerHTML=e.cil,t.insertCell(-1).innerHTML=e.companyname+" ["+e.customerid+"]",t.insertCell(-1).innerHTML=e.billingMunicipality,t.insertCell(-1).innerHTML=l;var u="black",m="c ",E=e.recordstatus;2==E?m="textUpperUcase textBold":3==E&&(u="red");let I=t.insertCell(-1);I.setAttribute("class",m),I.innerHTML=HYDROMETER_RECORD_STATUS[Number(e.recordstatus)],I.style.color=u;let L=t.insertCell(-1);L.setAttribute("class","colProductId"),L.innerHTML=setLocalDate(e.statusdate,16);let v=t.insertCell(-1);v.setAttribute("class","colProductId"),v.innerHTML=c;let N=t.insertCell(-1);N.setAttribute("class","noPrint");let b=document.createElement("button");b.type="button",b.setAttribute("class","labelDetail");const D=e.id;if(b.onclick=function(){hydrometerRecordEditRecord(D),setSelectedRowOnClick(t,"SELECTED_ROW_HYDROMETER_RECORD_LIST")},N.appendChild(b),1==e.recordstatus){if(checkPermission("0202")){let o=document.createElement("button");o.type="button",o.innerHTML="Facturar",o.setAttribute("class","labelSale"),o.onclick=function(){setSelectedRowOnClick(t,"SELECTED_ROW_HYDROMETER_RECORD_LIST"),sessionStorage.setItem("hydrometerRecordDetail",JSON.stringify(e)),window.location.assign("SaleInvoiceConsumption.php?invoicetype=2")},N.appendChild(o)}if(checkPermission("0202")){let o=document.createElement("button");o.type="button",o.innerHTML="Dívida",o.onclick=function(){setSelectedRowOnClick(t,"SELECTED_ROW_HYDROMETER_RECORD_LIST"),sessionStorage.setItem("customerid",JSON.stringify(e)),window.location.assign("SaleReportInvoiceMissingPayment.php")},N.appendChild(o)}}}var y=document.getElementById("tblHydroRecLisResumeTable");for(var s in y.innerHTML="",a=0,n)a+=1,resume(y,a,"Tipo de consumidor",n,s,"Contadores");for(var s in a=0,r)a+=1,resume(y,a,"Bairro",r,s,"Contadores");hideNotification()}},t.send(o)}function hydrometerRecordEditRecord(e){showParts("divHydroRecordDetail"),hydrometerRecordGetRecordDetails(e)}function hydrometerRecordCancelRecord(){showConfirm("Tem a certeza que deseja apagar esta leitura?",function(){showNotification();var e=getElementValue("txtHydroRecRegRecordId"),t=SYSTEM_USER_STATUS.userId,o=new XMLHttpRequest,n="action=deleteHydrometerRecord&recordId="+e+"&userId="+t,r=URL_SA_HYDROMETER_X;o.open("POST",r,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(o.responseText);1==e.status?(showNotification(e.msg,1),hydrometerRecordListDetails(),hideParts("divHydroRecordDetail")):showNotification(e.msg,0)}},o.send(n)})}function consumptionEstimatedGroupOnLoad(){checkUserStatusAfterExecute(function(){fillSelectMonth("selConsuEstGroMonth",1,(new Date).getMonth()+1),fillSelectDependencyFull("selConsuEstGroDependency",-1,1),fillSelectConsumerTypeAqua("selConsuEstGroConsumerType"),fillSelectMunicipality("selConsuEstGroMunicipality",SYSTEM_USER_STATUS.provinceId,-1),fillSelectNeiborhood("selConsuEstGroNeiborhood",3,-1)})}function consumptionEstimatedGroupShow(){showParts("divConsumptionEstimatedGroup"),consumptionEstimatedGroupMonthChange()}function consumptionEstimatedGroupMonthChange(){var e=Number(getElementValue("numConsuEstGroYear")),t=Number(getElementValue("selConsuEstGroMonth"));consumptionEstimatedGroupGetContracts(),setElementInnerHtml("lbConsuEstGroDays",daysInMonth(t,e)),consumptionEstimatedGroupGetCMD(),setElementInnerHtml("lbConsuEstGroProcessed","0/0")}var CONSUMPTION_ESTIMATED_GROUP_LINE=[];function consumptionEstimatedGroupGetContracts(){try{var e={};e.companyId=SYSTEM_USER_STATUS.companyId,e.dependencyId=getElementValue("selConsuEstGroDependency"),e.consumertype=getElementValue("selConsuEstGroConsumerType"),e.municipalityId=getElementValue("selConsuEstGroMunicipality"),e.neiborhood=getElementValue("selConsuEstGroNeiborhood"),e.year=getElementValue("numConsuEstGroYear"),e.month=getElementValue("selConsuEstGroMonth"),Number(e.month)<10&&(e.month="0"+e.month.toString()),e.estimateddate1=e.year+"-"+e.month+"-01",showNotification();var t=new XMLHttpRequest,o="action=getConsumptionContractNumber&filterInfo="+JSON.stringify(e),n=URL_SA_HYDROMETER_X;t.open("POST",n,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){if(4==t.readyState&&200==t.status){try{var e=JSON.parse(this.responseText);CONSUMPTION_ESTIMATED_GROUP_LINE=e}catch(e){showHttpResponseText(t),CONSUMPTION_ESTIMATED_GROUP_LINE=[]}setElementInnerHtml("lbConsuEstGroUpdateBy",e.length),hideNotification()}},t.send(o)}catch(e){showNotification(e.message,0)}}function consumptionEstimatedGroupGetCMD(){try{var e={};e.consumertype=getElementValue("selConsuEstGroConsumerType"),showNotification();var t=new XMLHttpRequest,o="action=getConsumptionCMDbyConsumerType&filterInfo="+JSON.stringify(e),n=URL_SA_HYDROMETER_X;t.open("POST",n,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){if(4==t.readyState&&200==t.status){try{var e=Number(this.responseText);setElementValue("txtConsuEstGroCMD",e.toFixed(2));var o=Number(getElementInnerHtml("lbConsuEstGroDays"));setElementValue("txtConsuEstGroAmount",(e*o/1e3).toFixed(2))}catch(e){showHttpResponseText(t)}hideNotification()}},t.send(o)}catch(e){showNotification(e.message,0)}}function consumptionEstimatedGroupSave(e){if(CONSUMPTION_ESTIMATED_GROUP_LINE.length<=0)return alert("Não foram encontrados ligações activas em contratos aprovados para o mês indicado."),!1;if(1==ST_SA_WAITING_SERVER)return alert("Aguardando resposta do servidor."),!1;ST_SA_WAITING_SERVER=1,setElementValue("numConsuEstLisYear",getElementValue("numConsuEstGroYear")),setElementValue("selConsuEstLisMonth",getElementValue("selConsuEstGroMonth"));var t=0;CONSUMPTION_ESTIMATED_GROUP_LINE.forEach(e=>(function(e){t+=1;var o=JSON.parse(e),n=new _consumptionEstimated;n.companyid=SYSTEM_USER_STATUS.companyId,n.dependencyid=SYSTEM_USER_STATUS.workplaceId,n.estimatedid="NOVA*",n.contractid=o.contractid,n.customerid=o.customerid,n.days=getElementInnerHtml("lbConsuEstGroDays");var r=getElementValue("numConsuEstGroYear"),a=getElementValue("selConsuEstGroMonth");Number(a)<10&&(a="0"+a.toString());n.estimateddate1=r+"-"+a+"-01",n.estimateddate2=r+"-"+a+"-"+n.days,n.amount=getElementValue("txtConsuEstGroAmount"),n.cmd=getElementValue("txtConsuEstGroCMD"),n.statususer=SYSTEM_USER_STATUS.userId,consumptionEstimatedRealSave(n,"GROUP",t)})(e))}function consumptionEstimatedListOnLoad(){try{showNotification(),checkUserStatusAfterExecute(function(){setLinkRequestStatus(),consumptionEstimatedDefaultSet(),fillSelectDependencyFull("selConsuEstLisDependency",-1,1),fillSelectMonth("selConsuEstLisMonth",1,(new Date).getMonth()),fillSelectConsumerTypeAqua("selConsuEstLisConsumerType",-1),fillSelectMunicipality("selConsuEstLisMunicipality",SYSTEM_USER_STATUS.provinceId,-1,-1),fillSelectNeiborhood("selConsuEstLisNeiborhood",3,-1),document.getElementById("chbConsuEstLisShowDate").onclick=function(){setEnableDisableByCheckBox(this.id,"numConsuEstLisYear","selConsuEstLisMonth")},checkPermission("3220")?(showParts("btConsuEstLisNewEstimatedGrop",!0),showParts("btConsuEstLisNewEstimatedSingle",!0)):(hideParts("btConsuEstLisNewEstimatedGrop"),hideParts("btConsuEstLisNewEstimatedSingle")),consumptionEstimatedListDetails(),hideNotification()})}catch(e){showNotification(e.message,0)}}function consumptionEstimatedListDetails(e=-1,t=-1){try{var o={};if(o.companyId=SYSTEM_USER_STATUS.companyId,o.dependencyId=getElementValue("selConsuEstLisDependency"),o.dependencyId<=0&&Number(SYSTEM_USER_STATUS.billingprofile)<BILLING_PROFILE_PARTNER_INDEX)return showNotification("Seleccionar uma filial.",0),!1;o.filterByDate=getElementChecked("chbConsuEstLisShowDate");var n=getElementValue("numConsuEstLisYear"),r=getElementValue("selConsuEstLisMonth");Number(r)<10&&(r="0"+r.toString()),o.estimatedDate=n+"-"+r+"-01",o.consumertype=getElementValue("selConsuEstLisConsumerType"),o.municipalityId=getElementValue("selConsuEstLisMunicipality"),o.neiborhood=getElementValue("selConsuEstLisNeiborhood"),o.customerid=e,o.userId=t,o.onlynumber=1,o.startIdx=0,o.endIdx=0,showNotification();var a=new XMLHttpRequest,i="action=getConsumptionEstimatedListDetails&filterInfo="+JSON.stringify(o),s=URL_SA_HYDROMETER_X;a.open("POST",s,!0),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){var e=JSON.parse(this.responseText).n;e<=0?showNotification("Não encontrado.",0):hideDivFilter();var t=document.getElementById("numResultPageNumber"),n=document.getElementById("numResultItems");function r(){var r=Number(t.value),a=Number(n.value),i=(r-1)*a,s=i+a;s>e&&(s=e),o.totalItems=e,o.startIdx=i,o.endIdx=s,o.onlynumber=0,consumptionEstimatedListFilter(o)}t.value=1,setResultTotalPages(t.id,n.id,e),t.onchange=function(){r()},n.onchange=function(){setResultTotalPages(t.id,n.id,e),r()},cleanElement("tblConsuEstLisListTable"),setElementInnerHtml("lbResultOnList",e),r()}},a.send(i)}catch(e){showNotification(e.message,0)}}function consumptionEstimatedListFilter(e){showNotification();var t=new XMLHttpRequest,o="action=getConsumptionEstimatedListDetails&filterInfo="+JSON.stringify(e),n=URL_SA_HYDROMETER_X;t.open("POST",n,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){if(4==t.readyState&&200==t.status){var o=JSON.parse(this.responseText),n={},r={};setElementInnerHtml("lbResultOnList",e.endIdx+" / "+e.totalItems);let t=document.getElementById("tblConsuEstLisListTable");t.innerHTML="";for(var a=e.startIdx,i=0;i<o.length;i++){var s=o[i];let e=JSON.parse(s);var d=CONSUMER_TYPE_AQUA[Number(e.consumertype)],l=e.billingneiborhood,c=getOperatorName(e.operatorName,e.statususer);addAmountResume(n,d,1),addAmountResume(r,l,1),a+=1;let y=t.insertRow(-1);y.id="trConsuEstList"+e.id,y.setAttribute("class","borderGray"+setSelectedRowBackground("SELECTED_ROW_CONSUMPTION_ESTIMATED_LIST",y.id));let R=y.insertCell(-1);R.setAttribute("class","colRowNumber"),R.innerHTML=a;let p=y.insertCell(-1);p.setAttribute("class","colProductId"),p.innerHTML=e.id;let h=y.insertCell(-1);h.setAttribute("class","colProductId"),h.innerHTML=dateYearMonthExtension(e.estimateddate1);let g=y.insertCell(-1);g.setAttribute("class","colProductId"),g.innerHTML=formatNumber(e.amount);let S=y.insertCell(-1);S.setAttribute("class","colProductId"),S.innerHTML=e.days;let T=y.insertCell(-1);T.setAttribute("class","colProductId"),T.innerHTML=formatNumber(e.cmd);let f=y.insertCell(-1);f.setAttribute("class","colProductId"),f.innerHTML=e.contractid,y.insertCell(-1).innerHTML=e.cil,y.insertCell(-1).innerHTML=e.companyname+" ["+e.customerid+"]",y.insertCell(-1).innerHTML=e.billingMunicipality,y.insertCell(-1).innerHTML=l;var u="black",m="c ",E=e.estimatedstatus;2==E?m="textUpperUcase textBold":3==E&&(u="red");let H=y.insertCell(-1);H.setAttribute("class",m),H.innerHTML=HYDROMETER_RECORD_STATUS[Number(e.estimatedstatus)],H.style.color=u;let C=y.insertCell(-1);C.setAttribute("class","colProductId"),C.innerHTML=setLocalDate(e.statusdate,16);let I=y.insertCell(-1);I.setAttribute("class","colProductId"),I.innerHTML=c;let L=y.insertCell(-1);L.setAttribute("class","noPrint");let v=document.createElement("button");v.type="button",v.setAttribute("class","labelDetail");const N=e.id;if(v.onclick=function(){consumptionEstimatedEditEstimated(N),setSelectedRowOnClick(y,"SELECTED_ROW_CONSUMPTION_ESTIMATED_LIST")},L.appendChild(v),1==e.estimatedstatus&&Number(e.amount)>0&&checkPermission("0202")){let t=document.createElement("button");t.type="button",t.innerHTML="Facturar",t.setAttribute("class","labelSale"),t.onclick=function(){setSelectedRowOnClick(y,"SELECTED_ROW_CONSUMPTION_ESTIMATED_LIST"),e.recorddate=e.estimateddate1,sessionStorage.setItem("hydrometerRecordDetail",JSON.stringify(e)),window.location.assign("SaleInvoiceConsumption.php?invoicetype=2")},L.appendChild(t)}if(checkPermission("0202")){let t=document.createElement("button");t.type="button",t.innerHTML="Dívida",t.onclick=function(){setSelectedRowOnClick(y,"SELECTED_ROW_SALE_CONSUMPTION_LIST"),sessionStorage.setItem("customerid",JSON.stringify(e)),window.location.assign("SaleReportInvoiceMissingPayment.php")},L.appendChild(t)}}var y=document.getElementById("tblConsuEstLisResumeTable");for(var s in y.innerHTML="",a=0,n)a+=1,resume(y,a,"Tipo de consumidor",n,s,"Estimativas");for(var s in a=0,r)a+=1,resume(y,a,"Bairro",r,s,"Estimativas");hideNotification()}},t.send(o)}function consumptionEstimatedRegisterOnLoad(){checkUserStatusAfterExecute(function(){fillSelectMonth("selConsuEstRegMonth",1,(new Date).getMonth()+1),fillSelectHydrometerRecordStatus("selConsuEstRegRecordStatus"),fillSelectMunicipality("selConsuEstRegMunicipality",SYSTEM_USER_STATUS.provinceId,-1),document.getElementById("txtConsuEstRegAmount").oninput=function(){consumptionEstimatedOnChange()}})}function consumptionEstimatedNewEstimated(e){if(3==e.waterlinkstatus)return alert("Ligação de água suspensa. Não poderá fazer estimativa."),!1;showParts("divConsumptionEstimatedDetail"),consumptionEstimatedGetEstimatedDetails(-1,e)}function consumptionEstimatedEditEstimated(e){showParts("divConsumptionEstimatedDetail"),consumptionEstimatedGetEstimatedDetails(e)}function consumptionEstimatedGetEstimatedDetails(e,t=null){const o=document.getElementById("lbConsuEstRegHeader"),n=document.getElementById("txtConsuEstRegEstimatedId"),r=document.getElementById("numConsuEstRegYear"),a=document.getElementById("selConsuEstRegMonth"),i=document.getElementById("txtConsuEstRegAmount"),s=document.getElementById("txtConsuEstRegDays"),d=document.getElementById("txtConsuEstRegCMD"),l=document.getElementById("selConsuEstRegRecordStatus"),c=document.getElementById("txtConsuEstRegContractId"),u=document.getElementById("txtConsuEstRegCIL"),m=document.getElementById("txtConsuEstRegCustomerID"),E=document.getElementById("txtConsuEstRegCompanyName"),y=document.getElementById("selConsuEstRegMunicipality"),R=document.getElementById("txtConsuEstRegComuna"),p=document.getElementById("txtConsuEstRegNeiborhood"),h=document.getElementById("txtConsuEstRegStreet"),g=document.getElementById("txtConsuEstRegBlock"),S=document.getElementById("txtConsuEstRegBuidNumber"),T=document.getElementById("txtConsuEstRegPostalCode"),f=document.getElementById("lbConsuEstRegUpdateBy");if(showParts("btConsuEstDetSave",!0),hideParts("btConsuEstDetCancel"),-1==e){var H=new Date;o.innerHTML="NOVA ESTIMATIVA DE CONSUMO",n.value="NOVA*",r.value=H.getFullYear(),a.value=H.getMonth()+1;var C=getConsumptionEstimatedDefault(t.dependencyid,t.consumertype);i.value=C,i.disabled=0==C?"":"true",s.value=0,d.value=0,l.value=1,r.disabled="",a.disabled="",c.value=t.contractid,u.value=t.cil,m.value=t.customerid,E.value=t.companyname,y.value=t.billingmunicipality,R.value=t.billingcomuna,p.value=t.billingneiborhood,h.value=t.billingstreetname,g.value=t.billingblock,S.value=t.billingbuildingnumber,T.value=t.billingpostalcode,f.innerHTML="Data de actualizaçao: "+setLocalDate(H,16),consumptionEstimatedOnChange(),consumptionEstimatedGetHistoric(t.contractid)}else{o.innerHTML="DETALHES DA ESTIMATIVA DE CONSUMO";var I=SYSTEM_USER_STATUS.companyId,L=new XMLHttpRequest,v="action=getConsumptionEstimatedDetails&companyId="+I+"&estimatedId="+e,N=URL_SA_HYDROMETER_X;L.open("POST",N,!0),L.setRequestHeader("Content-type","application/x-www-form-urlencoded"),L.onreadystatechange=function(){if(4==L.readyState&&200==L.status){var e=JSON.parse(this.responseText);n.value=e.id,r.value=setLocalDate(e.estimateddate1).getFullYear(),a.value=setLocalDate(e.estimateddate1).getMonth()+1,i.value=Number(e.amount).toFixed(2),s.value=e.days,d.value=Number(e.cmd).toFixed(2),l.value=e.estimatedstatus,r.disabled="true",a.disabled="true",c.value=e.contractid,u.value=e.cil,m.value=e.customerid,E.value=e.companyname,y.value=e.billingmunicipality,R.value=e.billingcomuna,p.value=e.billingneiborhood,h.value=e.billingstreetname,g.value=e.billingblock,S.value=e.billingbuildingnumber,T.value=e.billingpostalcode,f.innerHTML="Cadastrado por "+getOperatorName(e.operatorEntry,e.entryuser)+" em "+setLocalDate(e.entrydate,16)+". <br>Actualizado por "+getOperatorName(e.operatorName,e.statususer)+" em "+setLocalDate(e.statusdate,16),consumptionEstimatedGetHistoric(e.contractid,e.id);var t=e.estimatedstatus;1!=t&&hideParts("btConsuEstDetSave"),1==t&&checkPermission("3221")&&showParts("btConsuEstDetCancel",!0)}},L.send(v)}}function consumptionEstimatedOnChange(){var e=getElementValue("txtConsuEstRegEstimatedId");if(isNaN(e)){var t=Number(getElementValue("numConsuEstRegYear")),o=Number(getElementValue("selConsuEstRegMonth"));setElementValue("txtConsuEstRegDays",daysInMonth(o,t))}var n=Number(getElementValue("txtConsuEstRegDays")),r=Number(getElementValue("txtConsuEstRegAmount"));(isNaN(r)||r<0)&&showNotification("Deve indicar o volume de consumo",0),(isNaN(n)||n<=0)&&showNotification("Data de leitura ou data de leitura anterior inválida",0),setElementValue("txtConsuEstRegCMD",(r/n*1e3).toFixed(4))}function consumptionEstimatedRegisterSave(e){var t=!1,o="",n=new _consumptionEstimated;n.companyid=SYSTEM_USER_STATUS.companyId,n.dependencyid=SYSTEM_USER_STATUS.workplaceId,n.estimatedid=getElementValue("txtConsuEstRegEstimatedId"),n.contractid=getElementValue("txtConsuEstRegContractId"),n.customerid=getElementValue("txtConsuEstRegCustomerID"),n.days=getElementValue("txtConsuEstRegDays");var r=getElementValue("numConsuEstRegYear"),a=getElementValue("selConsuEstRegMonth");if(Number(a)<10&&(a="0"+a.toString()),n.estimateddate1=r+"-"+a+"-01",n.estimateddate2=r+"-"+a+"-"+n.days,n.amount=getElementValue("txtConsuEstRegAmount"),n.cmd=getElementValue("txtConsuEstRegCMD"),n.statususer=SYSTEM_USER_STATUS.userId,Number(n.days)<=0&&(t=!0,o+="Deve indicar o período de estimação. <br>"),Number(n.cmd)<=0&&(t=!0,o+="A estimativa não deve ser igual ou inferior a zero. <br>"),""==n.contractid&&(t=!0,o+="Deve indicar o número do Contrato. <br>"),""==n.customerid&&(t=!0,o+="Deve indicar o número do cliente. <br>"),1==ST_SA_WAITING_SERVER&&(t=!0,o+="Aguardando resposta do servidor. <br>"),t)return alert(o),!1;ST_SA_WAITING_SERVER=1,consumptionEstimatedRealSave(n,e)}function consumptionEstimatedRealSave(e,t,o=0){showNotification();var n=new XMLHttpRequest,r="action=saveConsumptionEstimatedRegister&consumptionEstimatedInfo="+JSON.stringify(e),a=URL_SA_HYDROMETER_X;n.open("POST",a,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==this.readyState&&200==this.status){ST_SA_WAITING_SERVER=0;try{var r=JSON.parse(n.responseText)}catch(e){showHttpResponseText(n),hideNotification()}1==r.status?"CONSUESTLIS"==t&&(consumptionEstimatedListDetails(e.customerid),hideParts("divConsumptionEstimatedDetail")):showNotification(r.msg,0),"GROUP"==t&&(setElementInnerHtml("lbConsuEstGroProcessed",o+" / "+CONSUMPTION_ESTIMATED_GROUP_LINE.length),o==CONSUMPTION_ESTIMATED_GROUP_LINE.length&&(consumptionEstimatedListDetails(),hideParts("divConsumptionEstimatedGroup")))}},n.send(r)}var HYDROMETER_REGISTER_LINES=[];function hydrometerRegisterLoteOnLoad(e){showNotification(),checkUserStatusAfterExecute(function(){HYDROMETER_REGISTER_LINES=[],"GME"==e?showParts("divHydroRegLoteNUS"):hideParts("divHydroRegLoteNUS"),hideNotification()})}function hydrometerRegisterLoteAddHydrometer(e=0){showNotification();let t=document.getElementById("tblHydroRegLoteMainTable");var o=Number(t.rows.length)+1,n=new _hydrometer;0!=e?n=e:(n.functionalstatus="FUNCIONA",n.brand="AMICO",n.hydrometertype="VOLUMÉTRICO",n.diameter="15",n.manufacturedate=setLocalDate(new Date,10),n.installationdate=setLocalDate(new Date,10)),n.status=1,HYDROMETER_REGISTER_LINES[Number(o-1)]=n;let r=t.insertRow(-1);r.setAttribute("class","borderGray"),r.setAttribute("id","rowHydroRegLote"+o);let a=r.insertCell(-1);a.setAttribute("class","colRowNumber"),a.innerHTML=o;let i=r.insertCell(-1);i.style.width="100px";let s=document.createElement("input");s.setAttribute("class","textUpperUcase"),s.id="txtHydroRegLoteHydrometerId"+o,s.type="text",s.maxlength="95",s.value=n.hydrometerid,s.onchange=function(){hydrometerRegisterLoteOnChange(o,this,"contractid")},i.appendChild(s);let d=r.insertCell(-1);d.style.width="80px";let l=document.createElement("select");l.id="selHydroRegLoteFunctionalStatus"+o,l.onchange=function(){hydrometerRegisterLoteOnChange(o,this,"functionalstatus",!0)},d.appendChild(l),fillSelectHydrometerFunctionalStatus(l.id,1,n.functionalstatus);let c=r.insertCell(-1);c.style.width="60px";let u=document.createElement("select");u.id="selHydroRegLoteBrand"+o,u.onchange=function(){hydrometerRegisterLoteOnChange(o,this,"brand",!0)},c.appendChild(u),fillSelecthydrometrBrand(u.id,1,n.brand);let m=r.insertCell(-1);m.style.width="50px";let E=document.createElement("input");E.setAttribute("class","textUpperUcase"),E.id="txtHydroRegLoteClassification"+o,E.type="text",E.maxlength="95",E.value=n.hydrometertype,E.onchange=function(){hydrometerRegisterLoteOnChange(o,this,"hydrometertype")},m.appendChild(E);let y=r.insertCell(-1);y.style.width="50px";let R=document.createElement("select");R.id="selHydroRegLoteDiameter"+o,R.onchange=function(){hydrometerRegisterLoteOnChange(o,this,"diameter",!0)},y.appendChild(R),fillSelectHydrometerDiameter(R.id,1,n.diameter);let p=r.insertCell(-1);p.style.width="50px";let h=document.createElement("input");h.setAttribute("class","textUpperUcase"),h.id="txtHydroRegLoteClassification"+o,h.type="text",h.maxlength="95",h.value=n.classification,h.onchange=function(){hydrometerRegisterLoteOnChange(o,this,"classification")},p.appendChild(h);let g=r.insertCell(-1);g.style.width="70px";let S=document.createElement("input");S.id="txtHydroRegLoteManufactureDate"+o,S.type="date",S.value=n.manufacturedate,S.onchange=function(){hydrometerRegisterLoteOnChange(o,this,"manufacturedate")},g.appendChild(S);let T=r.insertCell(-1);T.style.width="70px";let f=document.createElement("input");f.id="txtHydroRegLoteInstallationDate"+o,f.type="date",f.value=n.installationdate,f.onchange=function(){hydrometerRegisterLoteOnChange(o,this,"installationdate")},T.appendChild(f);let H=r.insertCell(-1);H.style.width="50px";let C=document.createElement("input");C.setAttribute("class","textUpperUcase"),C.id="txtHydroRegLoteInstallationRecord"+o,C.type="number",C.min="0",C.value=n.installationrecord,C.onchange=function(){hydrometerRegisterLoteOnChange(o,this,"installationrecord")},H.appendChild(C);let I=r.insertCell(-1);I.style.width="50px";let L=document.createElement("input");L.setAttribute("class","textUpperUcase"),L.id="txtHydroRegLoteCilSerie"+o,L.type="text",L.maxlength="95",L.value=n.contractid,L.onchange=function(){hydrometerRegisterLoteOnChange(o,this,"contractid")},I.appendChild(L);let v=r.insertCell(-1);v.style.width="50px";let N=document.createElement("input");N.setAttribute("class","textUpperUcase"),N.id="txtHydroRegLoteCilSerie"+o,N.type="text",N.maxlength="95",N.value=n.cilserie,N.onchange=function(){hydrometerRegisterLoteOnChange(o,this,"cilserie"),n.cil=n.cilserie+n.cilsequencenumber,setElementValue("txtHydroRegLoteCIL"+o,n.cil)},v.appendChild(N);let b=r.insertCell(-1);b.style.width="80px";let D=document.createElement("input");D.setAttribute("class","textUpperUcase"),D.id="txtHydroRegLoteCilSequence"+o,D.type="number",D.min=1,D.value=n.cilsequencenumber,D.onchange=function(){hydrometerRegisterLoteOnChange(o,this,"cilsequencenumber"),n.cil=n.cilserie+n.cilsequencenumber,setElementValue("txtHydroRegLoteCIL"+o,n.cil)},b.appendChild(D);let _=r.insertCell(-1);_.style.width="100px";let M=document.createElement("input");M.setAttribute("class","textUpperUcase"),M.id="txtHydroRegLoteCIL"+o,M.type="text",M.maxlength="95",M.value=n.cil,M.disabled="true",M.onchange=function(){hydrometerRegisterLoteOnChange(o,this,"cil")},_.appendChild(M);let O=r.insertCell(-1);O.style.width="150px";let w=document.createElement("input");w.setAttribute("class","textUpperUcase"),w.id="txtHydroRegLoteCompanyName"+o,w.type="text",w.maxlength="95",w.value=n.companyname,w.onchange=function(){hydrometerRegisterLoteOnChange(o,this,"companyname")},O.appendChild(w);let A=r.insertCell(-1);var x=document.createElement("button");x.setAttribute("class","labelRemove"),x.type="button",x.onclick=function(){HYDROMETER_REGISTER_LINES[Number(o-1)].status=0,r.innerHTML=""},A.appendChild(x),A.style.textAlign="center",A.style.width="10px",hideNotification()}function hydrometerRegisterLoteOnChange(e,t,o,n=!1){var r=t.value;n||(r=reviewString(t).toString().toUpperCase(),t.value=r),HYDROMETER_REGISTER_LINES[Number(e)-1][o]=r}function hydrometerRegisterLoteCleanTable(){HYDROMETER_REGISTER_LINES=[],cleanElement("tblHydroRegLoteMainTable")}function hydrometerRegisterLoteAddHydrometerFromCSV(){document.getElementById("txtHydroRegLoteCSV").value.split("/-.").forEach(e=>(function(e){var t=new _hydrometer,o=e.split(";");t.hydrometerid=o[0].trim().toUpperCase(),t.functionalstatus=o[1].toUpperCase(),t.brand=o[2].toUpperCase(),t.hydrometertype=o[3].toUpperCase(),t.diameter=o[4].toUpperCase().replace(/^\D+/g,""),t.classification=o[5].toUpperCase(),t.manufacturedate=setLocalDate(o[6],10),t.installationdate=setLocalDate(o[7],10),t.installationrecord=o[8].replace(/^\D+/g,""),""==t.installationrecord&&(t.installationrecord=0);t.contractid=o[9].toUpperCase(),t.cil=o[10].toUpperCase();var n=cilToSerieSequence(t.cil);t.cilserie=n.serie,t.cilsequencenumber=n.seq,t.companyname=o[11].toUpperCase(),hydrometerRegisterLoteAddHydrometer(t)})(e))}function hydrometerRegisterLoteSave(e){if(hydrometerRegisterLoteCheckMandatoryField())return!1;if(hydrometerRegisterLoteCheckDucplicateInfo("hydrometerid","contador nº"))return!1;if(1==ST_SA_WAITING_SERVER)return alert("Aguardando resposta do servidor. <br>"),!1;var t=SYSTEM_USER_STATUS.companyId,o=SYSTEM_USER_STATUS.workplaceId;if("GME"==e){if(t=reviewString(document.getElementById("txtHydroRegLoteNUS")),isNaN(t)||""==t)return alert("Deve indicar o código NUS da empresa"),!1;if(o=reviewString(document.getElementById("txtHydroRegLoteDependency")),isNaN(o)||""==o)return alert("Deve indicar a filial de destino."),!1}var n=document.getElementById("divHydroRegLoteResulte");n.innerHTML="",showNotification("Esta operação pode demorar alguns minutos.");for(var r=0;r<HYDROMETER_REGISTER_LINES.length;r++){var a=r+1,i=_hydrometer;(i=HYDROMETER_REGISTER_LINES[r]).companyid=t,i.dependencyid=o,i.statususer=SYSTEM_USER_STATUS.userId,i.updateContractCil=getElementValue("rngHydroRegLoteUpdateContractCil"),1==i.status&&s(i,a)}function s(e,t){ST_SA_WAITING_SERVER=0;var o=new XMLHttpRequest,r="action=saveHydrometerRegisterLote&hydrometerInfo="+JSON.stringify(e),a=URL_SA_HYDROMETER_X;o.open("POST",a,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){if(4==this.readyState&&200==this.status){ST_SA_WAITING_SERVER=0;try{var r=JSON.parse(o.responseText)}catch(e){return showHttpResponseText(o),!1}let a=document.createElement("span");a.innerHTML="Linha "+t+", contador "+e.hydrometerid+", contrato "+e.contractid+", nome "+e.companyname+". Mensagem: "+r.msg,n.appendChild(a),1!=r.status?(document.getElementById("rowHydroRegLote"+t).style.color="red",a.style.color="red"):(document.getElementById("rowHydroRegLote"+t).style.color="gray",e.status=0),hideNotification()}},o.send(r)}}function hydrometerRegisterLoteCheckMandatoryField(){if(HYDROMETER_REGISTER_LINES.length<=0)return alert("Não foram adicionadas linhas."),!1;for(var e=!1,t="",o=0;o<HYDROMETER_REGISTER_LINES.length;o++){var n,r="";if(1==(n=HYDROMETER_REGISTER_LINES[o]).status){""==n.hydrometerid&&(r+="Deve indicar o nº do contador. "),""==n.contractid&&(r+="Deve indicar o contrato. ");var a=new Date(n.manufacturedate);validateDate(a)||(r+="Data de fabrico fora do formato. ");var i=new Date(n.installationdate);validateDate(i)||(r+="Data de instalação fora do formato. "),""!=r&&(e=!0,t+=r="Linha "+Number(o+1)+": "+r+" <br>")}}return e&&alert(t),e}function hydrometerRegisterLoteCheckDucplicateInfo(e,t){if(HYDROMETER_REGISTER_LINES.length<=0)return alert("Não foram adicionadas linhas."),!1;for(var o=!1,n="",r=[],a=0;a<HYDROMETER_REGISTER_LINES.length;a++){var i=HYDROMETER_REGISTER_LINES[a];if(1==i.status&&!r.includes(i[e])){r[a]=i[e];for(var s=0;s<HYDROMETER_REGISTER_LINES.length;s++)if(a!=s){var d=HYDROMETER_REGISTER_LINES[s];1==d.status&&i[e]==d[e]&&(n+="Duplicado "+t+" "+i[e]+" Linhas "+Number(a+1)+" / "+Number(s+1)+" <br>",o=!0)}}}return o&&alert(n),o}var HYDROMETER_RECORD_LINES=[];function hydrometerRecordLoteOnLoad(e){showNotification(),checkUserStatusAfterExecute(function(){HYDROMETER_RECORD_LINES=[],"GME"==e?showParts("divHydroRecLoteNUS"):hideParts("divHydroRecLoteNUS"),hideNotification()})}function hydrometerRecordLoteCleanTable(){HYDROMETER_RECORD_LINES=[],cleanElement("tblHydroRecLoteMainTable")}function hydrometerRecordLoteAddRecord(e=0){showNotification();let t=document.getElementById("tblHydroRecLoteMainTable");var o=Number(t.rows.length)+1,n=new _hydrometerRecord;0!=e?n=e:(n.recorddate=setLocalDate(new Date,10),n.recordvalue=0),n.status=1,HYDROMETER_RECORD_LINES[Number(o-1)]=n;let r=t.insertRow(-1);r.setAttribute("class","borderGray"),r.setAttribute("id","rowHydroRecLote"+o);let a=r.insertCell(-1);a.setAttribute("class","colRowNumber"),a.style.width="10px",a.innerHTML=o;let i=r.insertCell(-1);i.style.width="100px";let s=document.createElement("input");s.setAttribute("class","textUpperUcase"),s.id="txtHydroRecLoteHydrometerId"+o,s.type="text",s.maxlength="95",s.value=n.hydrometerid,s.onchange=function(){hydrometerRecordLoteOnChange(o,this,"hydrometerid")},i.appendChild(s);let d=r.insertCell(-1);d.style.width="50px";let l=document.createElement("input");l.setAttribute("class","textUpperUcase"),l.id="txtHydroRecLoteContractId"+o,l.type="text",l.maxlength="95",l.value=n.contractid,l.onchange=function(){hydrometerRecordLoteOnChange(o,this,"contractid")},d.appendChild(l);let c=r.insertCell(-1);c.style.width="50px";let u=document.createElement("input");u.setAttribute("class","textUpperUcase"),u.id="txtHydroRecLoteCustomerId"+o,u.type="text",u.maxlength="95",u.value=n.customerid,u.onchange=function(){hydrometerRecordLoteOnChange(o,this,"customerid")},c.appendChild(u);let m=r.insertCell(-1);m.style.width="70px";let E=document.createElement("input");E.id="txtHydroRecLoteManufactureDate"+o,E.type="date",E.value=n.recorddate,E.onchange=function(){hydrometerRecordLoteOnChange(o,this,"recorddate")},m.appendChild(E);let y=r.insertCell(-1);y.style.width="50px";let R=document.createElement("input");R.setAttribute("class","textUpperUcase"),R.id="txtHydroRecLoteRecordValue"+o,R.type="number",R.min=0,R.value=n.recordvalue,R.onchange=function(){hydrometerRecordLoteOnChange(o,this,"recordvalue")},y.appendChild(R);let p=r.insertCell(-1);p.style.width="50px";let h=document.createElement("input");h.setAttribute("class","textUpperUcase"),h.id="txtHydroRecLoteBeforeRecValue"+o,h.type="number",h.min=0,h.value=n.beforerecordvalue,h.onchange=function(){hydrometerRecordLoteOnChange(o,this,"beforerecordvalue")},p.appendChild(h);let g=r.insertCell(-1);g.style.width="50px";let S=document.createElement("input");S.setAttribute("class","textUpperUcase"),S.id="txtHydroRecLoteAmount"+o,S.type="number",S.min="0",S.value=n.amount,S.disabled="true",S.onchange=function(){hydrometerRecordLoteOnChange(o,this,"amount")},g.appendChild(S);let T=r.insertCell(-1);T.style.width="70px";let f=document.createElement("input");f.id="txtHydroRecLoteBeforeRecDate"+o,f.type="date",f.value=n.beforerecorddate,f.onchange=function(){hydrometerRecordLoteOnChange(o,this,"beforerecorddate")},T.appendChild(f);let H=r.insertCell(-1);var C=document.createElement("button");C.setAttribute("class","labelRemove"),C.type="button",C.onclick=function(){HYDROMETER_RECORD_LINES[Number(o-1)].status=0,r.innerHTML=""},H.appendChild(C),H.style.textAlign="center",H.style.width="10px",hydrometerRecordLoteOnChange(o,s,"hydrometerid"),hideNotification()}function hydrometerRecordLoteOnChange(e,t,o,n=!1){var r=t.value;n||(r=reviewString(t).toString().toUpperCase(),t.value=r);var a=_hydrometerRecord;(a=HYDROMETER_RECORD_LINES[Number(e)-1])[o]=r,a.amount=Number(a.recordvalue)-Number(a.beforerecordvalue),a.days=Number(dateDiffDays(a.recorddate,a.beforerecorddate)),(isNaN(a.amount)||a.amount<=0)&&showNotification("Deve indicar uma leitura válida",0),(isNaN(a.days)||a.days<=0)&&showNotification("Data de leitura ou data de leitura anterior inválida",0),a.cmd=a.amount/a.days*1e3,setElementValue("txtHydroRecLoteAmount"+e,a.amount)}function hydrometerRecordLoteAddRecordFromCSV(){document.getElementById("txtHydroRecLoteCSV").value.split("/-.").forEach(e=>(function(e){var t=new _hydrometerRecord,o=e.split(";");t.hydrometerid=o[0].trim().toUpperCase(),t.contractid=o[1].toUpperCase(),t.customerid=o[2].toUpperCase(),t.recorddate=setLocalDate(o[3],10),t.recordvalue=Number(o[4]),t.beforerecordvalue=Number(o[5]),t.amount=t.recordvalue-t.beforerecordvalue,t.beforerecorddate=setLocalDate(o[7],10),hydrometerRecordLoteAddRecord(t)})(e))}function hydrometerRecordLoteSave(e){if(hydrometerRecordLoteCheckMandatoryField())return!1;var t=SYSTEM_USER_STATUS.companyId,o=SYSTEM_USER_STATUS.workplaceId;if("GME"==e){if(t=reviewString(document.getElementById("txtHydroRecLoteNUS")),isNaN(t)||""==t)return alert("Deve indicar o código NUS da empresa"),!1;if(o=reviewString(document.getElementById("txtHydroRecLoteDependency")),isNaN(o)||""==o)return alert("Deve indicar a filial de destino."),!1}if(1==ST_SA_WAITING_SERVER)return alert("Aguardando resposta do servidor. <br>"),!1;var n=document.getElementById("divHydroRecLoteResulte");n.innerHTML="",showNotification("Esta operação pode demorar alguns minutos.");for(var r=0;r<HYDROMETER_RECORD_LINES.length;r++){var a=r+1,i=_hydrometerRecord;(i=HYDROMETER_RECORD_LINES[r]).companyid=t,i.dependencyid=o,i.statususer=SYSTEM_USER_STATUS.userId,1==i.status&&s(i,a)}function s(e,t){ST_SA_WAITING_SERVER=1;var o=new XMLHttpRequest,r="action=saveHydrometerRecordLote&hydrometerRecordInfo="+JSON.stringify(e),a=URL_SA_HYDROMETER_X;o.open("POST",a,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){if(4==this.readyState&&200==this.status){ST_SA_WAITING_SERVER=0;try{var r=JSON.parse(o.responseText)}catch(e){return showHttpResponseText(o),!1}let a=document.createElement("span");a.innerHTML="Linha "+t+", contador "+e.hydrometerid+", contrato "+e.contractid+", Clinte "+e.customerid+". Mensagem: "+r.msg,n.appendChild(a),1!=r.status?(document.getElementById("rowHydroRecLote"+t).style.color="red",a.style.color="red"):(document.getElementById("rowHydroRecLote"+t).style.color="gray",e.status=0),hideNotification()}},o.send(r)}}function hydrometerRecordLoteCheckMandatoryField(){if(HYDROMETER_RECORD_LINES.length<=0)return alert("Não foram adicionadas linhas."),!1;for(var e=!1,t="",o=0;o<HYDROMETER_RECORD_LINES.length;o++){var n,r="";if(1==(n=HYDROMETER_RECORD_LINES[o]).status){""==n.hydrometerid&&(r+="Deve indicar o nº do contador. "),""==n.contractid&&(r+="Deve indicar o contrato. ");var a=new Date(n.recorddate);validateDate(a)||(r+="Data de leitura fora do formato. ");var i=new Date(n.beforerecorddate);validateDate(i)||(r+="Data de leitura anterior fora do formato. "),(isNaN(n.days)||n.days<=0)&&(r+="Data de leitura ou data de leitura anterior inválida. "),""!=r&&(e=!0,t+=r="Linha "+Number(o+1)+": "+r+" <br>")}}return e&&alert(t),e}function consuptionEstimatedCancel(){showConfirm("Tem a certeza que deseja apagar esta estimativa?",function(){showNotification();var e=getElementValue("txtConsuEstRegEstimatedId"),t=SYSTEM_USER_STATUS.userId,o=new XMLHttpRequest,n="action=cancelConsumptionEstimated&estimatedId="+e+"&userId="+t,r=URL_SA_HYDROMETER_X;o.open("POST",r,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(o.responseText);1==e.status?(showNotification(e.msg,1),consumptionEstimatedListDetails(getElementValue("txtConsuEstRegCustomerID")),hideParts("divConsumptionEstimatedDetail")):showNotification(e.msg,0)}},o.send(n)})}function consumptionEstimatedDefaultOnLoad(){try{showNotification(),checkUserStatusAfterExecute(function(){setConsumerTypeAqua(),fillSelectDependencyFull("selConsEstDefDependency",-1,1),hideNotification()})}catch(e){showNotification(e.message,0)}}function consumptionEstimatedDefaultList(){var e=document.getElementById("tblConsEstDefListTable");e.innerHTML="";var t={};if(t.companyId=SYSTEM_USER_STATUS.companyId,t.dependencyId=getElementValue("selConsEstDefDependency"),CONSUMPTION_ESTIMATED_DEFAULT=[],t.dependencyId<=0)return alert("Deve indicar uma filial."),!1;showNotification();var o=new XMLHttpRequest,n="action=getConsumptionEstimatedDefaultList&filterInfo="+JSON.stringify(t),r=URL_SA_HYDROMETER_X;o.open("POST",r,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){if(4==o.readyState&&200==o.status){try{var t=JSON.parse(this.responseText)}catch(e){showHttpResponseText(o)}for(var n=0,r=0;r<t.length;r++){var a=t[r];let o=JSON.parse(a);CONSUMPTION_ESTIMATED_DEFAULT[n]=o;var i=CONSUMER_TYPE_AQUA[Number(o.consumertype)];n+=1;let s=e.insertRow(-1);s.id="trConsuEstDefList"+o.id,s.setAttribute("class","borderGray"+setSelectedRowBackground("SELECTED_ROW_CONSUMPTION_ESTIMATED_DEFAULT_LIST",s.id));let d=s.insertCell(-1);d.setAttribute("class","colRowNumber"),d.innerHTML=n,s.insertCell(-1).innerHTML=o.designation+" ["+o.dependencyid+"]",s.insertCell(-1).innerHTML=i;let l=s.insertCell(-1),c=document.createElement("input");c.type="number",c.min=0,c.value=Number(o.consumption),c.step="any";let u=n;c.onchange=function(){consumptionEstimatedDefaultOnChange(u,"consumption",this)},l.appendChild(c)}hideNotification()}},o.send(n)}function consumptionEstimatedDefaultOnChange(e,t,o){var n=Number(o.value);isNaN(n)?(n=0,o.value=0):n<0&&(n=0,o.value=0),CONSUMPTION_ESTIMATED_DEFAULT[Number(e-1)][t]=n}function consumptionEstimatedDefaultSave(){if(CONSUMPTION_ESTIMATED_DEFAULT.length<=0)return alert("Lista vazia."),!1;if(1==ST_SA_WAITING_SERVER)return alert("Aguardando resposta do servidor. <br>"),!1;var e="&consumotionDefaults={",t=0;CONSUMPTION_ESTIMATED_DEFAULT.forEach(o=>(function(o){0!=t&&(e+=",");e+='"'+t+'":'+JSON.stringify(o),t+=1})(o)),e+="}",showNotification(),ST_SA_WAITING_SERVER=1;var o=new XMLHttpRequest,n="action=saveConsumptionEstimatedDefault"+e;e=URL_SA_HYDROMETER_X;o.open("POST",e,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){if(4==o.readyState&&200==o.status){ST_SA_WAITING_SERVER=0;try{var e=JSON.parse(this.responseText)}catch(e){showHttpResponseText(o)}1==e.status?(showNotification(e.msg,1),document.getElementById("selConsEstDefDependency").dispatchEvent(new Event("change"))):showNotification(e.msg,0)}},o.send(n)}function consumptionEstimatedDefaultSet(){var e={};e.companyId=SYSTEM_USER_STATUS.companyId,e.dependencyId=-1,CONSUMPTION_ESTIMATED_DEFAULT=[];var t=new XMLHttpRequest,o="action=getConsumptionEstimatedDefaultList&filterInfo="+JSON.stringify(e),n=URL_SA_HYDROMETER_X;t.open("POST",n,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){if(4==t.readyState&&200==t.status){try{var e=JSON.parse(this.responseText)}catch(e){showHttpResponseText(t)}for(var o=0,n=0;n<e.length;n++){var r=e[n];let t=JSON.parse(r);CONSUMPTION_ESTIMATED_DEFAULT[o]=t,o+=1}}},t.send(o)}function getConsumptionEstimatedDefault(e,t){if(CONSUMPTION_ESTIMATED_DEFAULT.length>0)for(var o=0;o<CONSUMPTION_ESTIMATED_DEFAULT.length;o++){var n=CONSUMPTION_ESTIMATED_DEFAULT[o];if(n.dependencyid==e&&n.consumertype==t)return n.consumption}return 0}function consumptionEstimatedGetHistoric(e,t=-1){var o=SYSTEM_USER_STATUS.companyId,n=new XMLHttpRequest,r="action=getConsumptionEstimatedHistoric&companyId="+o+"&contractid="+e,a=URL_SA_HYDROMETER_X;n.open("POST",a,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==n.readyState&&200==n.status){try{var e=JSON.parse(this.responseText)}catch(e){showHttpResponseText(n)}let a=document.getElementById("tblConsuEstRegHistoric");a.innerHTML="";for(var o=0;o<e.length;o++){var r=e[o];let n=JSON.parse(r),i=a.insertRow(-1);i.setAttribute("class","borderGray"),n.id==t&&(i.style.fontWeight="bold");let s=i.insertCell(-1);s.setAttribute("class","colProductId"),s.innerHTML=setLocalDate(n.entrydate,10);let d=i.insertCell(-1);d.setAttribute("class","colProductId"),d.innerHTML=dateYearMonthExtension(n.estimateddate1);let l=i.insertCell(-1);l.setAttribute("class","colProductId"),l.innerHTML=formatNumber(n.amount)}}},n.send(r)}