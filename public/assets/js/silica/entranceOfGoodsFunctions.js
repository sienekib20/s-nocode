class _entranceOfGoods{constructor(e,t=-1,n=-1,r="GE",o="",i=1,c="",a=1,s=-1,l=-1,u="",d="",E=-1,m=0){this.companyId=e,this.dependencyid=t,this.userId=n,this.invoiceType=r,this.invoiceSerie=o,this.invoiceSequence=i,this.invoiceNumber=c,this.movimentsource=a,this.supplier=s,this.stocksource=l,this.reference=u,this.movimentDate=d,this.stockTarget=E,this.totalItems=m}}class _entranceOfGoodsLine{constructor(e,t="",n="UN",r=-1,o=-1,i=1,c=1,a="",s="",l="",u=0,d=0,E=0,m=0,S=1){this.productID=e,this.productDescription=t,this.productUnit=n,this.productSection=r,this.productIvaCategory=o,this.productStock=i,this.quant=c,this.serialnumber=a,this.lotenumber=s,this.expirationdate=l,this.note=u,this.stockActualMA=d,this.nextStockMA=E,this.diferenceMA=m,this.status=S}}var ENTRANCE_OF_GOODS_NEW=new _entranceOfGoods,ENTRANCE_OF_GOODS_LINE=[],ENTRANCE_SOURCES=[];function setEntranceSource(e){(ENTRANCE_SOURCES=[])[1]="Fornecedor",ENTRANCE_SOURCES[2]="Outro armazém"}function entranceOnLoad(e){showNotification(),checkUserStatusAfterExecute(function(){setDocumentType("");var e=SYSTEM_USER_STATUS.companyId,t=SYSTEM_USER_STATUS.userId;setEntranceSource(""),document.getElementById("selProdEstEntrMovimentSource").onchange=function(){entranceSourceChange(e,t)},document.getElementById("selProdEstEntrStockSource").onchange=function(){entranceSetNew("")},fillSelectEntranceSource("selProdEstEntrMovimentSource"),fillSelectSupplier("selProdEstEntrSupplier",-1),fillSelectProductStock("selProdEstEntrStockSource",-1,-1),fillSelectProductStock("selProdEstEntrStockTarget",-1,1),checkPermission("0301")||hideParts("btProdEstEntrProductRegister"),entranceSetNew(""),productAutocompleteList("txtProdEstEntrProduct"),setTriggerButtonByText("txtProdEstEntrProduct","btProdEstEntrAddProduct"),setTriggerButtonByText("txtProdEstEntrNote","btProdEstENtrAddNote"),hideNotification()})}function entranceSetNew(e){try{showDivFilter(),ENTRANCE_OF_GOODS_LINE=[],(ENTRANCE_OF_GOODS_NEW=new _entranceOfGoods).companyId=SYSTEM_USER_STATUS.companyId,ENTRANCE_OF_GOODS_NEW.dependencyid=SYSTEM_USER_STATUS.workplaceId,ENTRANCE_OF_GOODS_NEW.userId=SYSTEM_USER_STATUS.userId,ENTRANCE_OF_GOODS_NEW.invoiceType="GE",ENTRANCE_OF_GOODS_NEW.invoiceSerie=invoiceDucumentSerie("GE"),ENTRANCE_OF_GOODS_NEW.invoiceNumber="GE 2021/1",ENTRANCE_OF_GOODS_NEW.totalItems=0,document.getElementById("tblProdEstEntrMainTable").innerHTML=""}catch(e){showNotification(e.message,0)}}function entranceNewSupplier(){supplierGetInfo(-1),showParts("divProdEstEntrSupplierRegister")}function entranceNewProduct(){productProdutOpen(-1),showParts("divProdEstEntrProductRegister")}function entranceSourceChange(e,t){var n=document.getElementById("divProdEstEntrSupplier"),r=document.getElementById("selProdEstEntrSupplier"),o=document.getElementById("divProdEstEntrStockSource"),i=document.getElementById("selProdEstEntrStockSource"),c=document.getElementById("divProdEstEntrReference"),a=document.getElementById("txtProdEstEntrReference"),s=document.getElementById("divProdEstEntrMovimentDate"),l=document.getElementById("selProdEstEntrMovimentSource").value;1==l&&(n.style.display="block",o.style.display="none",i.value=-1,c.style.display="block",s.style.display="block"),2==l&&(n.style.display="none",r.value=-1,o.style.display="block",c.style.display="none",a.value="",s.style.display="none"),3==l&&(n.style.display="none",r.value=-1,o.style.display="none",i.value=-1,c.style.display="block",a.value="",s.style.display="block"),entranceSetNew("")}function entranceAddProduct(e=0){try{var t=SYSTEM_USER_STATUS.companyId,n=document.getElementById("selProdEstEntrMovimentSource").value,r=document.getElementById("selProdEstEntrStockSource").value;const u=document.getElementById("txtProdEstEntrProduct"),d=document.getElementById("txtProdEstEntrNote");var o=reviewString(u),i=reviewString(d);if(1==e){if(d.value="",d.focus(),""==i)return showNotification("Por favor, escreva uma nota válida",0),!1}else{if(""==o)return showNotification("Por favor, indicar um código de barra válido",0),u.value="",u.focus(),!1;2==n?-1==r&&showNotification("Deve indicar o estoque / armazém de origem.",0):r=-1}showNotification();var c=SYSTEM_USER_STATUS.workplaceId,a=new XMLHttpRequest,s="action=getProductFullDescription&companyId="+t+"&productId="+o+"&isNote="+e+"&stockId="+r+"&workplaceId="+c,l=URL_SA_PRODUCT_SALE_X;a.open("POST",l,!0),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var t=this.responseText;let N=document.getElementById("tblProdEstEntrMainTable");var r=Number(N.rows.length)+1;if(""==t)return document.getElementById("txtProdEstEntrProduct").focus(),showNotification("Produto / serviço não encontrado",0),!1;var o=JSON.parse(this.responseText);if(c=o.id,0==e){if("P"!=o.producttype||1!=o.productstock)return showNotification("Só pode adicionar produtos com controle de estoque.",0),u.value="",!1;if(entranceCheckItemOnLines(c))return showNotification("Produto já adicionado",0),u.value="",u.focus(),!1}var c=o.id,a=e?i:o.productdescription,s=e?"":o.productunit,l=e?1:o.productsection,d=e?1:o.productivacategory,E=e?0:o.productstock,m=e?0:o.productstockactual;if(2==n&&Number(m)<=0)return showNotification("Produto sem estoque.",0),!1;hideDivFilter();var S=new _entranceOfGoodsLine;S.productID=c,S.productDescription=a,S.productUnit=s,S.productSection=l,S.productIvaCategory=d,S.productStock=E,S.quant=1,S.note=e,S.status=1,ENTRANCE_OF_GOODS_LINE[Number(r-1)]=S;let p=N.insertRow(-1);p.setAttribute("class","borderGray"),p.setAttribute("id","trProdEstEntrLine"+r),e&&(p.style.fontStyle="italic");let T=p.insertCell(p.cells.length);T.setAttribute("class","colRowNumber"),T.innerHTML=r;let _=p.insertCell(p.cells.length);_.setAttribute("class","colProductId"),_.innerHTML=e?"-":c;let v=p.insertCell(p.cells.length);if(v.innerHTML=a,e)v.setAttribute("colSpan","6");else{let e=p.insertCell(p.cells.length);e.setAttribute("class","colSimNao"),e.innerHTML=s;let t=p.insertCell(p.cells.length),o=document.createElement("input");o.id="numProdEstEntrLineQuant"+r,o.type="number",o.min="0.01",2==n&&(o.max=m),o.step="any",o.value=1,o.onchange=function(){entranceRecaculateLine(r)},t.appendChild(o),t.style.textAlign="center",t.style.width="60px";let i=p.insertCell(p.cells.length),c=document.createElement("input");c.id="txtProdEstEntrSerialNumber"+r,c.type="text",c.onchange=function(){entranceRecaculateLine(r)},i.appendChild(c);let a=p.insertCell(p.cells.length),l=document.createElement("input");l.id="txtProdEstEntrLoteNumber"+r,l.type="text",l.onchange=function(){entranceRecaculateLine(r)},a.appendChild(l);let u=p.insertCell(p.cells.length),d=document.createElement("input");d.id="txtProdEstEntrExpirationDate"+r,d.type="date",d.onchange=function(){entranceRecaculateLine(r)},u.appendChild(d)}let f=p.insertCell(p.cells.length),y=document.createElement("button");y.setAttribute("class","labelRemove"),y.type="button",y.onclick=function(){entranceRemoveLine(r)},f.appendChild(y),f.style.textAlign="center",f.style.width="60px",entranceTotalItens(""),hideNotification()}},a.send(s)}catch(e){e.message}}function entranceCheckItemOnLines(e){var t=!1;return ENTRANCE_OF_GOODS_LINE.forEach(n=>(function(n){if(n.productID==e&&1==n.status)return t=!0,!0})(n)),t}function entranceRemoveLine(e){document.getElementById("trProdEstEntrLine"+e).innerHTML="",ENTRANCE_OF_GOODS_LINE[Number(e)-1].status=0,entranceTotalItens("")}function entranceRecaculateLine(e){try{var t=document.getElementById("numProdEstEntrLineQuant"+e),n=t.value;isNaN(n)&&(t.value=1,n=1),n<1&&(t.value=1,n=1);var r=_entranceOfGoodsLine;(r=ENTRANCE_OF_GOODS_LINE[Number(e)-1]).quant=n,r.serialnumber=reviewString(document.getElementById("txtProdEstEntrSerialNumber"+e)),r.lotenumber=reviewString(document.getElementById("txtProdEstEntrLoteNumber"+e)),r.expirationdate=document.getElementById("txtProdEstEntrExpirationDate"+e).value,entranceTotalItens("")}catch(e){showNotification(e.message,0)}}function entranceTotalItens(e){var t=0;ENTRANCE_OF_GOODS_LINE.forEach(e=>(function(e){0!=e.status&&(t+=Number(e.quant))})(e)),ENTRANCE_OF_GOODS_NEW.totalItems=t,document.getElementById("lbProdEstEntrItems").innerHTML=formatNumber(t)}function entranceCanFinishDocument(e){var t=!1,n="";return ENTRANCE_OF_GOODS_NEW.movimentsource=document.getElementById("selProdEstEntrMovimentSource").value,ENTRANCE_OF_GOODS_NEW.supplier=document.getElementById("selProdEstEntrSupplier").value,ENTRANCE_OF_GOODS_NEW.stocksource=document.getElementById("selProdEstEntrStockSource").value,ENTRANCE_OF_GOODS_NEW.reference=reviewString(document.getElementById("txtProdEstEntrReference")),ENTRANCE_OF_GOODS_NEW.movimentDate=document.getElementById("txtProdEstEntrMovimentDate").value,ENTRANCE_OF_GOODS_NEW.stockTarget=document.getElementById("selProdEstEntrStockTarget").value,1==ENTRANCE_OF_GOODS_NEW.movimentsource&&Number(ENTRANCE_OF_GOODS_NEW.supplier)<1&&(t=!0,n="Deve indicar o fornecedor. <br>"),2==ENTRANCE_OF_GOODS_NEW.movimentsource?(Number(ENTRANCE_OF_GOODS_NEW.stocksource)<1&&(t=!0,n+="Deve indicar o armazém de origem. <br>"),ENTRANCE_OF_GOODS_NEW.stocksource==ENTRANCE_OF_GOODS_NEW.stockTarget&&(t=!0,n+="O armazém de entrada deve ser diferente do armazém de origem. <br>")):ENTRANCE_OF_GOODS_NEW.stocksource=-1,Number(ENTRANCE_OF_GOODS_NEW.stockTarget)<1&&(t=!0,n+="Deve indicar o estoque de entrada. <br>"),Number(ENTRANCE_OF_GOODS_LINE.length)<1&&(t=!0,n+="Documento vazio. <br>"),1==ST_SA_WAITING_SERVER&&(t=!0,n+="Aguardando resposta do servidor. <br>"),!t||(alert(n),showDivFilter(),!1)}function entranceFinishDocument(e){try{if(0!=entranceCanFinishDocument("")){showConfirm("Tem a certeza que deseja finalizar esta entrada?",function(){var e="&&newEntranceOfGoods="+JSON.stringify(ENTRANCE_OF_GOODS_NEW);e+="&&entranceLines={";var t=0;ENTRANCE_OF_GOODS_LINE.forEach(n=>(function(n){0!=n.status&&(0!=t&&(e+=","),e+='"'+t+'":'+JSON.stringify(n),t+=1)})(n)),e+="}",showNotification(),ST_SA_WAITING_SERVER=1;var n=new XMLHttpRequest,r="action=saveEntranceNew"+e;e=URL_SA_ENTRANCE_OF_GOODS_X,n.open("POST",e,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==this.readyState&&200==this.status){ST_SA_WAITING_SERVER=0;var e=JSON.parse(n.responseText);if(1==e.status){var t=document.getElementById("lbHearderCompanyName").innerHTML,r=e.invoiceNumber,o=e.in,i=DOCUMENT_TYPE[o.slice(0,2)]+" nº"+o;showPrintOptions(function(){entrancePrintReceipt(r)},function(){entrancePrintA4(r)},function(){var e=document.getElementById("txtPriPrevCustomerEmail").value;entranceSendByEmail(r,t,i,"",e)},function(){var e=document.getElementById("btPriPrevSendWhatsApp").value;entranceSendByWhatsApp(r,i,"",e)},"",""),setTimeout(function(){entranceSetNew(""),hideNotification()},2e3)}else showNotification("Talvés alguma coisa não correu bem...",0)}},n.send(r)})}}catch(e){showNotification(e.message,0)}}function fillSelectEntranceSource(e,t=1){const n=document.getElementById(e);if(!validateUserControl(n))return!1;if(n.innerHTML="",-1==t){var r=document.createElement("option");r.value="-1",r.setAttribute("class","selectPlaceHolder"),r.innerHTML="Seleccionar",n.appendChild(r)}for(var o=1;o<ENTRANCE_SOURCES.length;o++){let e=document.createElement("option");e.value=o,e.innerHTML=ENTRANCE_SOURCES[o],n.appendChild(e)}}function entranceListOnLoad(e){showNotification(),checkUserStatusAfterExecute(function(){setSystemUserBillingProfile(""),setDocumentType(""),setEntranceSource(""),fillSelectProductStock("selProdEstEntrLisStockTarget",-1,-1),setAutoCompleteToFiel("txtProdEstEntrLisDocumentNumber",19,1),setAutoCompleteToFiel("txtProdEstEntrLisSerialNumber",20),setAutoCompleteToFiel("txtProdEstEntrLisLoteNumber",21),setAutoCompleteToFiel("txtEntrDetCancelEntranceReason",22,1),setSessionResultSearch("numProdEstEntrLisResults"),hideNotification()})}function entranceListGet(e=-1,t=-1,n=-1,r=-1,o=-1,i=-1,c=-1){var a=SYSTEM_USER_STATUS.companyId,s=Number(SYSTEM_USER_STATUS.billingprofile)>=BILLING_PROFILE_PARTNER_INDEX?-1:SYSTEM_USER_STATUS.workplaceId,l=Number(document.getElementById("selProdEstEntrLisStockTarget").value);if((isNaN(l)||Number(l)<=0)&&Number(SYSTEM_USER_STATUS.billingprofile)<BILLING_PROFILE_MANAGER_INDEX)return showNotification("Deve seleccionar um estoque.",0),!1;-1!=e&&(e=document.getElementById("txtProdEstEntrLisDocumentNumber").value),-1!=t&&(t=document.getElementById("txtProdEstEntrLisEmissionDate").value),-1!=o&&(o=document.getElementById("txtProdEstEntrLisSerialNumber").value),-1!=i&&(i=document.getElementById("txtProdEstEntrLisLoteNumber").value),showNotification();var u=new XMLHttpRequest,d="action=getEntranceList&companyId="+a+"&dependencyId="+s+"&stockTarget="+l+"&docNumber="+e+"&docDate="+t+"&supplierId="+n+"&operatorId="+r+"&serialNumber="+o+"&loteNumber="+i+"&productId="+c,E=URL_SA_ENTRANCE_OF_GOODS_X;u.open("POST",E,!0),u.setRequestHeader("Content-type","application/x-www-form-urlencoded"),u.onreadystatechange=function(){if(4==u.readyState&&200==u.status){var e=JSON.parse(this.responseText);e.length<=0?showNotification("Não encontrado.",0):hideDivFilter();var t=e.length,n=document.getElementById("numResultPageNumber"),r=document.getElementById("numResultItems");function o(){var o=Number(n.value),i=Number(r.value),c=(o-1)*i,a=c+i;a>t&&(a=t),setElementInnerHtml("lbResultOnList",a+" / "+t);let s=document.getElementById("tblProdEstEntrLisMainTable");s.innerHTML="";for(var l=c,u=c;u<a;u++){var d=e[u];l+=1;let t=JSON.parse(d);const n=t.invoicenumber;let r=s.insertRow(-1);r.id="trProductEntranceList"+n,r.setAttribute("class","borderGray"+setSelectedRowBackground("SELECTED_ROW_PRODUCT_ENTRANCE_LIST",r.id));let o=r.insertCell(-1);o.setAttribute("class","colRowNumber"),o.innerHTML=l,r.insertCell(-1).innerHTML=n;let i=r.insertCell(-1);var E=t.supplierid;E=-1!=E?t.supplierName+" ("+E+")":"",i.innerHTML=E,r.insertCell(-1).innerHTML=t.stockin+" ("+t.stocktarger+")",r.insertCell(-1).innerHTML=getFirtLastName(t.operatorName)+" ("+t.sourceid+")";let c=r.insertCell(-1);c.style.textAlign="center",c.innerHTML=setLocalDate(t.invoicedate,16);let a=r.insertCell(-1);a.style.textAlign="center",a.innerHTML=getDocumentStatus(t.invoicestatus),a.style.color="A"==t.invoicestatus?"red":"black";let m=r.insertCell(-1);m.setAttribute("class","noPrint");let S=document.createElement("button");S.type="button",S.setAttribute("class","labelDetail");const N=t.printnumber;S.onclick=function(){entranceViewDetail(N),setSelectedRowOnClick(r,"SELECTED_ROW_PRODUCT_ENTRANCE_LIST")},m.appendChild(S),m.style.textAlign="center";let p=document.createElement("button");p.setAttribute("class","labelPrint"),p.type="button",p.onclick=function(){var e=document.getElementById("lbHearderCompanyName").innerHTML,n=t.invoicenumber,r=DOCUMENT_TYPE[n.slice(0,2)]+" nº"+n;showPrintOptions(function(){entrancePrintReceipt(N)},function(){entrancePrintA4(N)},function(){var t=document.getElementById("txtPriPrevCustomerEmail").value;entranceSendByEmail(N,e,r,"",t)},function(){var e=document.getElementById("btPriPrevSendWhatsApp").value;entranceSendByWhatsApp(N,r,"",e)},"","")},m.appendChild(p)}hideNotification()}n.value=1,setResultTotalPages(n.id,r.id,t),n.onchange=function(){o()},r.onchange=function(){setResultTotalPages(n.id,r.id,t),o()},o()}},u.send(d)}function entranceViewDetail(e){try{showNotification();const o=document.getElementById("btEntrDetCancelEntrance");o.style.display="none",cleanElement("tblEntrDetMainTable");var t=new XMLHttpRequest,n="action=entranceGetDetail&printNumber="+e,r=URL_SA_ENTRANCE_OF_GOODS_X;t.open("POST",r,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var n=JSON.parse(t.responseText);document.getElementById("lbEntrDetDocumentNumber").innerHTML=n.invoicenumber,document.getElementById("lbEntrDetEntryDate").innerHTML=n.invoicedate,document.getElementById("lbEntrDetEntryUser").innerHTML=getFirtLastName(n.operatorName)+" ("+n.sourceid+")",document.getElementById("lbEntrDetInvoiceStatus").innerHTML=getDocumentStatus(n.invoicestatus),document.getElementById("lbEntrDetInvoiceStatusDate").innerHTML=n.invoiceStatusDate,document.getElementById("lbEntrDetInvoiceStatusReason").innerHTML=n.invoicestatusreason,document.getElementById("lbEntrDetInvoiceStatusUser").innerHTML=getFirtLastName(n.operatorStatusName)+" ("+n.Sourceidstatus+")",document.getElementById("lbEntrDetMovimentSource").innerHTML=ENTRANCE_SOURCES[n.movimentsource],document.getElementById("lbEntrDetSupplier").innerHTML=n.supplierName+" ("+n.supplierid+")",document.getElementById("lbEntrDetReference").innerHTML=n.movimentereference,document.getElementById("lbEntrDetReferenceDate").innerHTML=1==n.movimentsource?n.movimentereferencedate:"",document.getElementById("lbEntrDetStockSource").innerHTML=n.stockout+" ("+n.stocksource+")",document.getElementById("lbEntrDetStockTarget").innerHTML=n.stocktarger+" - "+n.stockin,entranceViewDetailLines(n.invoicenumber,n.invoicestatus),checkPermission("0305")&&"A"!=n.invoicestatus&&(o.style.display="inline"),document.getElementById("btEntrDetPrint").onclick=function(){showPrintOptions(function(){entrancePrintReceipt(e)},function(){entrancePrintA4(e)},function(){},function(){},"","",!0)},document.getElementById("btEntrDetRealCancel").onclick=function(){entranceCancelEntrance(n.invoicenumber)},showParts("divProdEstEntrEntranceDetail"),hideNotification()}},t.send(n)}catch(e){showNotification(e.message,0)}}function entranceViewDetailLines(e,t){showNotification();var n=new XMLHttpRequest,r="action=entranceGetDetailLines&invoiceNumber="+e+"&invoiceStatus="+t,o=URL_SA_ENTRANCE_OF_GOODS_X;n.open("POST",o,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(n.responseText);let r=document.getElementById("tblEntrDetMainTable");r.innerHTML="";var t=0;e.forEach(e=>(function(e){t+=1;let n=JSON.parse(e),o=r.insertRow(-1);o.setAttribute("class","borderGray");let i=o.insertCell(-1);i.setAttribute("class","colRowNumber"),i.innerHTML=t,o.insertCell(-1).innerHTML=n.productId,o.insertCell(-1).innerHTML=n.productDescription,o.insertCell(-1).innerHTML=n.unitOfMeasure,o.insertCell(-1).innerHTML=n.serialnumber,o.insertCell(-1).innerHTML=n.lotenumber,o.insertCell(-1).innerHTML=n.expirationdate,o.insertCell(-1).innerHTML=formatNumber(n.quantity)})(e))}},n.send(r)}function entranceCancelEntrance(e){var t=reviewString(document.getElementById("txtEntrDetCancelEntranceReason")).toUpperCase();if(""==t)return alert("Deve indicar o motivo da anulação."),!1;showConfirm("Tem mesmo a certeza que deseja anular esta guia?",function(){showNotification();var n=SYSTEM_USER_STATUS.userId,r=new XMLHttpRequest,o="action=entranceCancelEntrance&invoiceNumber="+e+"&reason="+t+"&userId="+n,i=URL_SA_ENTRANCE_OF_GOODS_X;r.open("POST",i,!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(r.responseText);1==e.status?(showNotification(e.msg,1),document.getElementById("txtEntrDetCancelEntranceReason").value="",hideParts("divEntrDetCancelEntrance"),hideParts("divProdEstEntrEntranceDetail")):showNotification("Não foi possível cancelar")}},r.send(o)})}