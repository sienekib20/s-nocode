class _invoice{constructor(e=0,t="",n="",i="",o=0,a="FR",r="2021",l="1",c="",s="",u="",m=5,d=0,I=0,N=0,E=0,S=0,p=0,v=0,C=0,h=0,b=0,g=0,y=0,T=1,f="",_=0,L=0,P=0,O=0,V="",A=0,D=0,R=-1,M="",w="",B=0,x=0,G=0,H=0,U=0){this.userId=e,this.customerId=t,this.contractid=n,this.cil=i,this.customerCredit=o,this.invoiceType=a,this.invoiceSerie=r,this.invoiceSequence=l,this.invoiceNumber=c,this.invoiceHash=s,this.orderReference=u,this.shelflife=m,this.totalItems=d,this.subtotalUnitPrice=I,this.subtotalIndirectCost=N,this.subtotalCommercialCost=E,this.subtotalEstimateProfit=S,this.subtotalColaborateComission=p,this.subtotalFund=v,this.subtotalDescount=C,this.subtotalIva=h,this.subtotalIvaWithoutDescount=b,this.totalInvoice=g,this.grosstotal=y,this.taxGroup=T,this.extraNote=f,this.paymentamount=_,this.diference=L,this.change=P,this.balance=O,this.expeditiondate=V,this.sellerUser=A,this.managerUser=D,this.partnershipUser=R,this.WithholdingTaxType=M,this.WithholdingTaxDescription=w,this.WithholdingTaxAmount=B,this.companyId=x,this.dependencyid=G,this.descountStockOnBilling=H,this.justUpdateOrder=U}}class _invoiceImport{constructor(e=0,t=0,n="",i="",o="",a="2021-01-01",r=0,l=0,c=1){this.companyid=e,this.dependencyid=t,this.customertid=n,this.companyname=i,this.invoiceNumber=o,this.invoicedate=a,this.totalinvoice=r,this.userId=l,this.status=c}}class _invoiceLine{constructor(e,t="P",n="",i="",o="UN",a=1,r=1,l=0,c=0,s=0,u=3,m=0,d=0,I="2021-1-1",N="2021-1-1",E=0,S=0,p=0,v=0,C=0,h=0,b=0,g=0,y=0,T=0,f=0,_=0,L=0,P=0,O=0,V=0,A=0,D="M02",R="Transmissão de bens e serviço não sujeita",M=0,w=0,B=1){this.productID=e,this.productType=t,this.productDescription=n,this.productBarCode=i,this.productUnit=o,this.productSection=a,this.productIvaCategory=r,this.productStock=l,this.productWeight=c,this.productNetWeight=s,this.devolutiondays=u,this.productStockActual=m,this.periodicService=d,this.periodicServiceDateBefore=I,this.periodicServiceDate=N,this.quant=E,this.warehousePrice=S,this.indirectCost=p,this.commercialCost=v,this.estimatedProfit=C,this.sellerComission=h,this.managerComission=b,this.fundInvestment=g,this.fundReserve=y,this.fundSocialaction=T,this.priceWithComission=f,this.creditAmount=_,this.descount=L,this.iva=P,this.ivaValue=O,this.ivaWithoutDescountValue=V,this.subtotalLine=A,this.exemptionCode=D,this.exemptionReason=R,this.note=M,this.gmelicense=w,this.status=B}}class _invoiceFund{constructor(e,t,n,i){this.code=e,this.percentSujest=t,this.valueCalc=n,this.statusActual=i}}class _invoicePayment{constructor(e,t,n,i,o,a,r,l){this.mechanism=e,this.banksource=t,this.accountsource=n,this.accounttarget=i,this.tpaterminal=o,this.reference=a,this.date=r,this.amount=l}}class _invoicePaymentSchedule{constructor(e,t,n){this.installment=e,this.installmentDate=t,this.paymentAmount=n}}class _billingSetting{constructor(e=0,t=-1,n="FR",i="PP",o=0,a="Nota",r=5,l=1,c=1,s=0,u=0,m=0){this.companyid=e,this.dependencyid=t,this.saletype=n,this.workingdocumenttype=i,this.opendescount=o,this.extranoteprefix=a,this.shelflifedocument=r,this.checkstockonbilling=l,this.onlybillingproductinstock=c,this.descountstockonbilling=s,this.movimentafterbilling=u,this.validatepaymentreference=m}}var INVOICE_NEW=new _invoice,INVOICE_NEW_TYPE=1,INVOICE_LINES=[],invoiceLine=new _invoiceLine,INVOICE_FUNDS=[],INVOICE_PAYMENTS=[],INVOICE_PAYMENTS_SCHEDULE=[],BILLING_SETTING=new _billingSetting,INVOICE_POS_STATUS=0;function invoiceOnLoad(e,t=10,n="VD"){showNotification(),checkUserStatusAfterExecute(function(){if(invoiceCheckLicenseLimit(),invoiceBillingSettingGet("VD",e),Number(SYSTEM_USER_STATUS.dependecyName)<=0&&(checkPermission("0201")||checkPermission("0202")||checkPermission("0203")||checkPermission("0204")||checkPermission("0207")||checkPermission("0304")||checkPermission("0306"))){var t=document.getElementById("lbVDFactWorkplaceStatus");t.innerHTML="NOTA: ".bold()+"Este utilizador não está associado a nenhúm loca de trabalho. Poderá ter problema em fazer vendas ou gerir estoques.",t.style.animation="blink-text 1.0s step-end infinite"}checkPermission("0301")||hideParts("btVDFactProductRegister"),productAutocompleteList("txtVDFactProduct"),setTriggerButtonByText("txtVDFactProduct","btVDFactAddProduct"),setTriggerButtonByText("txtVDFactNote","btVDFactAddNote"),hideNotification()})}function invoiceSetNew(e,t=10,n="VD"){try{showNotification(),setDocumentType(""),setPaymentMechanism("");var i=SYSTEM_USER_STATUS.companyId,o=SYSTEM_USER_STATUS.taxGroup,a=SYSTEM_USER_STATUS.userId;INVOICE_NEW_TYPE=e;var r=BILLING_SETTING.saletype,l="Nova venda",c="Pagamento",s="FINALIZAR VENDA";2==e?(c="Condições de pagamento",r="FT"):3==e?(r="FT",l="Nova factura",c="Condições de pagamento",s="FINALIZAR FACTURA"):4==e?(r=BILLING_SETTING.workingdocumenttype,l="Nova Consulta",s="FINALIZAR CONSULTA"):5==e&&(r="NE",l="Nova Encomenda",s="FINALIZAR ENCOMENDA");let I=document.getElementById("divButtonsBar");I.innerHTML="";let N=document.createElement("button");N.setAttribute("class","mainButton"),N.type="button",N.innerHTML="POS",N.style.marginLeft="5px",N.onclick=function(){const e=document.getElementById("divProductSearchPOS"),t=document.getElementById("divVDFactDetailsAdd");var n=document.querySelector(":root");0==INVOICE_POS_STATUS?(INVOICE_POS_STATUS=1,this.innerHTML="Fechar POS",hideParts("divMenuPrincipal"),hideParts("divVDFactProductServiceAdd"),t.classList.remove("colDivFormBS"),e.style.width="60%",n.style.setProperty("--forceHide","none"),document.getElementById("btProdProcSearchProductPOS").click()):(INVOICE_POS_STATUS=0,this.innerHTML="POS",showParts("divMenuPrincipal"),showParts("divVDFactProductServiceAdd"),t.classList.add("colDivFormBS"),e.style.width="0px",n.style.setProperty("--forceHide","table-cell"))};var u=sessionStorage.getItem("invoiceWorkingDocumentInvoiceNumber");if(null!=u&&""!=u){const e=document.createElement("button");e.setAttribute("class","mainButton labelNew-RedDard"),e.type="button",e.innerHTML="Pendente",e.style.display="inline",e.style.animation="blink-text 1.0s step-end infinite",e.onclick=function(){var t=sessionStorage.getItem("invoiceWorkingDocumentPrintNumber"),n=sessionStorage.getItem("invoiceWorkingDocumentCustomerId");invoiceSetNewFromProform(u,t,"N",n),e.style.display="none"},sessionStorage.setItem("invoiceWorkingDocumentInvoiceNumber",""),I.appendChild(e)}let E=document.createElement("button");if(E.setAttribute("class","mainButton labelNew-RedDard"),E.type="button",E.innerHTML=l,E.style.marginLeft="5px",E.onclick=function(){p.style.display="inline",invoiceSetNew(e,t,n)},I.appendChild(E),4!=e){let t=document.createElement("button");t.setAttribute("class","mainButton labelSearck-RedDark"),t.type="button",t.innerHTML=5==e?"Procurar Encomendas":"A partir de Consulta",t.onclick=function(){showDivSearcher("divVDFactDocumentSearch","btDocProSearch")},I.appendChild(t)}let S=document.createElement("button");S.id="btVDFactCustomerSearch",S.setAttribute("class","mainButton labelCustomer-RedDark"),S.type="button",S.innerHTML="Cliente Água",S.style.marginLeft="5px",S.onclick=function(){showDivSearcher("divContractSearch","btContrSearSearch")},I.appendChild(S);let p=document.createElement("button");if(p.id="btVDFactCustomerSearch",p.setAttribute("class","mainButton labelCustomer-RedDark"),p.type="button",p.innerHTML="Cliente",p.style.marginLeft="5px",p.onclick=function(){showDivSearcher("divCustomerSearch","btCliProSearch")},I.appendChild(p),4!=e&&5!=e){let e=document.createElement("button");e.setAttribute("class","mainButton labelPayment-RedDark"),e.type="button",e.innerHTML="Retenção na fonte",e.style.marginLeft="5px",e.onclick=function(){showParts("divVDFactWithholdingTax")},checkPermission("0203")&&I.appendChild(e);let t=document.createElement("button");t.setAttribute("class","mainButton labelPayment-RedDark"),t.type="button",t.innerHTML=c,t.style.marginLeft="5px",t.onclick=function(){showDivPayment("divVDFactPayment","VD")},I.appendChild(t)}let v=document.createElement("button");v.setAttribute("class","mainButton labelValidate finishButton"),v.type="button",v.innerHTML=s,v.style.marginLeft="5px",v.onclick=function(){showParts("divVDFactFinish")},I.appendChild(v),1==e?(fillSelectPaymentMechanism("selRecPagPaymentMecanism"),document.getElementById("tblRecPagPaymentsTable").innerHTML=""):2!=e&&3!=e||(document.getElementById("tblRecPagCalPaymentsTable").innerHTML="");var m=new Date;m.setMinutes(m.getMinutes()-m.getTimezoneOffset()),document.getElementById("txtVDFactExpeditionDate").value=setLocalDate(new Date,10),document.getElementById("txtVDFactExpeditionTime").value="15:00",document.getElementById("tblVDFactMainTable").innerHTML="";var d=invoiceDucumentSerie(r,t);(INVOICE_NEW=new _invoice).userId=a,INVOICE_NEW.customerId="",INVOICE_NEW.contractid="",INVOICE_NEW.cil="",INVOICE_NEW.invoiceType=r,INVOICE_NEW.invoiceSerie=d,INVOICE_NEW.invoiceSequence=1,INVOICE_NEW.invoiceNumber="",INVOICE_NEW.invoiceHash="",INVOICE_NEW.orderReference="",INVOICE_NEW.shelflife=5==e?365:BILLING_SETTING.shelflifedocument,INVOICE_NEW.taxGroup=o,INVOICE_NEW.companyId=i,INVOICE_NEW.dependencyid=SYSTEM_USER_STATUS.workplaceId,invoiceSelectContract(),INVOICE_LINES=[],INVOICE_PAYMENTS=[],INVOICE_PAYMENTS_SCHEDULE=[],invoiceCalculateTotal(""),invoiceCalculatePayment(""),hideNotification()}catch(e){showNotification(e.message,0)}}function invoiceAddProduct(e,t=-1,n=0){if(-1==t){var i=SYSTEM_USER_STATUS.companyId,o=document.getElementById("txtVDFactProduct");const e=document.getElementById("txtVDFactNote");t=reviewString(o);var a=reviewString(e);if(1==n){if(e.value="",e.focus(),""==a)return showNotification("Por favor, escreva uma nota válida",0),!1}else if(""==t)return showNotification("Por favor, indicar um código de barra válido",0),o.value="",o.focus(),!1}showNotification();var r=SYSTEM_USER_STATUS.workplaceId,l=new XMLHttpRequest,c="action=getProductFullDescription&companyId="+i+"&productId="+t+"&isNote="+n+"&isList=0&workplaceId="+r,s=URL_SA_INVOICE_X;l.open("POST",s,!0),l.setRequestHeader("Content-type","application/x-www-form-urlencoded"),l.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var i=this.responseText;try{const m=Number(INVOICE_LINES.length)+1;if(""==i)return document.getElementById("txtVDFactProduct").focus(),showNotification("Produto / serviço não encontrado",0),!1;var r=JSON.parse(this.responseText);if(t=r.id,!(n=Boolean(Number(n)))&&invoiceCheckItemOnLines(t))return hideNotification(),o.value="",o.focus(),!1;var l=n||0==BILLING_SETTING.checkstockonbilling?0:r.productstock,c=n?-1:Number(r.productstockactual);if(Number(r.pvp)<0)return showNotification("Produto / Serviço sem preço.",0),!1;if(0!=l&&5!=INVOICE_NEW_TYPE||(c=-1),5!=INVOICE_NEW_TYPE&&1==l)if(1==BILLING_SETTING.onlybillingproductinstock){if(Number(c)<=0)return showNotification("Sem estoque. "+r.productdescription,0),!1}else c=-1;if(invoiceAddSingleLine(r,a,c,m,n,e),-1!=e){let t=document.getElementById(e).insertRow(-1);t.setAttribute("class","borderGray"),t.setAttribute("id","trVDFactInvLine"+m),temporaryBackgroundGray(t.id),n&&(t.style.fontStyle="italic");let i=t.insertCell(-1);i.setAttribute("class","colRowNumber"),i.innerHTML=m,t.insertCell(-1).innerHTML=invoiceLine.productDescription;let o=t.insertCell(-1);if(o.setAttribute("class","colSimNao colHideSS"),o.innerHTML=invoiceLine.productUnit,n)o.setAttribute("colspan","7");else{let e=t.insertCell(-1),n=document.createElement("input");n.id="numVDFactInvQuant"+m,n.type="number",n.min="any",-1!=c&&(n.max=c),n.step="any",n.value=1,n.onchange=function(){invoiceRecaculateLine(m)},e.appendChild(n),e.style.textAlign="center",e.style.width="100px";let i=t.insertCell(-1),o=document.createElement("div"),a=document.createElement("button");a.setAttribute("class","button-in-invoice"),a.innerHTML="-",a.type="button",a.onclick=function(){n.value=Number(n.value)-1,n.dispatchEvent(new Event("change"))},o.appendChild(a);let r=document.createElement("button");r.id="btVdFactAddQuantToLine"+m,r.setAttribute("class","button-in-invoice"),r.innerHTML="+",r.type="button",r.onclick=function(){n.value=Number(n.value)+1,n.dispatchEvent(new Event("change"))},o.appendChild(r),i.appendChild(o),i.style.width="70px";let l=t.insertCell(-1);l.setAttribute("id","cellVDFactInvUnitPrice"+m),l.setAttribute("class","colHideSS"),l.style.textAlign="right",l.style.width="80px",l.style.whiteSpace="nowrap",l.style.paddingRight="5px";let u=t.insertCell(-1);var s=Number(invoiceLine.descount);let d=document.createElement("input");d.id="numVDFactInvDescount"+m,d.type="number",d.min=0,d.value=s.toFixed(1),d.max=s,d.step="any",0==BILLING_SETTING.opendescount&&(d.disabled="true"),d.onchange=function(){invoiceRecaculateLine(m)},u.appendChild(d),u.setAttribute("class","colHideSS"),u.style.textAlign="right",u.style.width="70px";let I=t.insertCell(-1);I.setAttribute("class","colHideSS"),I.setAttribute("id","cellVDFactIVA"+m),I.style.textAlign="center",I.style.width="50px";let N=t.insertCell(-1);N.setAttribute("id","cellVDFactInvPVP"+m),N.style.fontSize="large",N.style.textAlign="right",N.style.whiteSpace="nowrap",N.style.paddingRight="10px"}let a=t.insertCell(-1);var u=document.createElement("button");u.setAttribute("class","labelRemove"),u.type="button",u.onclick=function(){invoiceRemoveLine(m)},a.appendChild(u),a.style.textAlign="center",a.style.width="10px",setElementValue("txtVDFactProduct")}invoiceRecaculateLine(m,1,e),hideNotification()}catch(e){showNotification(e.message,0)}}},l.send(c)}function invoiceAddSingleLine(e,t,n,i,o,a=1){(invoiceLine=new _invoiceLine).productID=e.id,invoiceLine.productType=o?"O":e.producttype,invoiceLine.productDescription=o?t:e.productdescription,invoiceLine.productBarCode=o?"":e.productnumbercode,invoiceLine.productUnit=o?"":e.productunit,invoiceLine.productSection=o?1:e.productsection,invoiceLine.productIvaCategory=o?1:e.productivacategory,invoiceLine.productStock=o?0:e.productstock,invoiceLine.productWeight=o?0:e.productweight,invoiceLine.productNetWeight=o?0:e.productnetweight,invoiceLine.devolutiondays=o?0:e.devolutiondays,invoiceLine.productStockActual=n,invoiceLine.exemptionCode=(o||Number(e.iva))>0?"":e.productexemption,invoiceLine.exemptionReason=(o||Number(e.iva))>0?"":e.exemptionreason,invoiceLine.note=o,invoiceLine.gmelicense=o?0:e.gmelicense,invoiceLine.status=1,invoiceLine.quant=1,invoiceLine.warehousePrice=o?0:Number(e.warehouseprice),invoiceLine.indirectCost=o?0:Number(e.indirectcost),invoiceLine.commercialCost=o?0:Number(e.commercialcost),invoiceLine.estimatedProfit=o?0:Number(e.estimatedprofit),invoiceLine.sellerComission=o?0:Number(e.sellercomission),invoiceLine.managerComission=o?0:Number(e.managercomission),invoiceLine.fundInvestment=o?0:Number(e.fundinvestment),invoiceLine.fundReserve=o?0:Number(e.fundreserve),invoiceLine.fundSocialaction=o?0:Number(e.fundsocialaction),invoiceLine.descount=o?0:Number(e.descount),invoiceLine.iva=o?0:Number(e.iva),Number(SYSTEM_USER_STATUS.taxGroup)<=1&&(o||(invoiceLine.exemptionCode="M04",invoiceLine.exemptionReason="IVA – Regime de exclusão",invoiceLine.iva=0)),INVOICE_LINES[Number(i-1)]=invoiceLine,-1==a&&invoiceRecaculateLine(i,1,a)}function invoiceRemoveLine(e){document.getElementById("trVDFactInvLine"+e).innerHTML="",INVOICE_LINES[Number(e)-1].status=0,invoiceCalculateTotal(""),invoiceCalculatePayment("")}function invoiceRecaculateLine(e,t=-1,n=1){var i=_invoiceLine;i=INVOICE_LINES[Number(e)-1];var o=Number(i.descount);if(-1==t){var a=document.getElementById("numVDFactInvDescount"+e),r=document.getElementById("numVDFactInvQuant"+e);o=Number(a.value),t=r.value,isNaN(t)&&(r.value=1,t=1),t<=0&&(r.value=1,t=1),isNaN(o)&&(o=0),o<0&&(a.value=0,o=0),o>Number(a.max)&&(o=Number(a.max),a.value=o)}t=Number(t),-1!=i.productStockActual&&t>Number(i.productStockActual)&&(t=i.productStockActual,r.value=t),t.countDecimals()>2&&(t=t.toFixed(2),r.value=t),i.quant=t,i.descount=Number(o);var l=Number(i.warehousePrice)/100,c=Number(i.indirectCost)*l,s=Number(i.commercialCost)*l,u=(Number(i.warehousePrice)+c+s)*(Number(i.estimatedProfit)/100),m=(i.sellerComission+i.managerComission+i.fundInvestment+i.fundReserve+i.fundSocialaction)*l;i.priceWithComission=Number(i.warehousePrice+c+s+u+m).toFixed(2),i.creditAmount=Number(Number(i.priceWithComission)*Number(t)).toFixed(2),i.ivaWithoutDescountValue=Number(Number(i.priceWithComission)*(i.iva/100)).toFixed(2);var d=Number(Number(i.priceWithComission)*i.descount/100);i.ivaValue=Number((Number(i.priceWithComission)-d)*(i.iva/100)),i.subtotalLine=Number((Number(i.priceWithComission)-d+Number(i.ivaValue))*t).toFixed(2),invoiceCalculateTotal(n),-1!=n&&0==i.note&&(setElementInnerHtml("cellVDFactInvUnitPrice"+e,formatNumber(i.priceWithComission)),setElementInnerHtml("cellVDFactIVA"+e,formatNumber(i.iva)),setElementInnerHtml("cellVDFactInvPVP"+e,formatNumber(i.subtotalLine).bold()),invoiceCalculatePayment(""))}function invoiceCalculateTotal(e="1"){try{var t=0,n=0,i=0,o=0,a=0,r=0,l=0,c=0,s=0,u=0,m=0,d=0;INVOICE_LINES.forEach(e=>(function(e){let I=_invoiceLine;I=e;var N=Number(I.quant),E=Number(I.warehousePrice)/100,S=Number(I.indirectCost)*E,p=Number(I.commercialCost)*E,v=(Number(I.warehousePrice)+S+p)*(Number(I.estimatedProfit)/100);I.status&&(1!=I.note&&(t+=Number(N)),n+=Number(I.warehousePrice)*N,i+=Number(S*N),o+=Number(p*N),a+=Number(v*N),r+=Number(Number(I.sellerComission+ +I.managerComission)*E)*N,l+=Number(Number(I.fundInvestment+I.fundReserve+I.fundSocialaction)*E)*N,c+=Number(I.creditAmount),s+=Number(I.descount*I.priceWithComission/100)*N,u+=Number(I.ivaValue)*N,m+=Number(I.ivaWithoutDescountValue)*N,d+=Number(I.subtotalLine),Number(I.productWeight)*N,Number(I.productNetWeight)*N)})(e)),INVOICE_NEW.totalItems=t,INVOICE_NEW.subtotalUnitPrice=n,INVOICE_NEW.subtotalIndirectCost=i,INVOICE_NEW.subtotalCommercialCost=o,INVOICE_NEW.subtotalEstimateProfit=a,INVOICE_NEW.subtotalColaborateComission=r,INVOICE_NEW.subtotalFund=l,INVOICE_NEW.subtotalDescount=s,INVOICE_NEW.subtotalIva=u,INVOICE_NEW.subtotalIvaWithoutDescount=m.toFixed(2),INVOICE_NEW.totalInvoice=Math.round(100*(d+Number.EPSILON))/100,INVOICE_NEW.grosstotal=Number(c+m).toFixed(2),-1!=e&&(document.getElementById("lbVDFactSubItems").innerHTML=formatNumber(t),document.getElementById("lbVDFactSubUnitPrice").innerHTML=formatNumber(n+i+o+a+r+l),document.getElementById("lbVDFactSubDescount").innerHTML=formatNumber(s),document.getElementById("lbVDFactSubIva").innerHTML=formatNumber(u),document.getElementById("lbVDFactSubPVP").innerHTML=formatNumber(d),document.getElementById("lbVDFactAmountToPay").innerHTML=formatNumber(d))}catch(e){showNotification(e.message,0)}}function invoiceCheckItemOnLines(e){var t=!1,n=0;return INVOICE_LINES.forEach(i=>(function(i){if(n+=1,(i.productID==e||i.productBarCode==e)&&1==i.status){temporaryBackgroundGray("trVDFactInvLine"+n);var o=document.getElementById("btVdFactAddQuantToLine"+n);return validateUserControl(o)&&o.click(),t=!0,!0}})(i)),t}function invoiceCheckPeriodicServiceItemOnLines(){var e=!1;return INVOICE_LINES.forEach(t=>(function(t){if(1==t.periodicService)return e=!0,!0})(t)),e}function invoiceCanFinishDocument(e){var t=!0,n="";const i=document.getElementById("lbVDCustomerMissing"),o=document.getElementById("lbVDEmptyDocument"),a=document.getElementById("lbVDTotalAmountIsZero"),r=document.getElementById("lbVDPaymentMissing"),l=document.getElementById("lbVDPaymentHigher");if(i.style.display="none",o.style.display="none",a.style.display="none",r.style.display="none",l.style.display="none",""==Number(INVOICE_NEW.customerId)&&(t=!1,n="Deve indicar o cliente. <br>","btFinish"==e&&(showParts("divVDFactCustomer"),hideParts("divVDFactFinish")),i.style.display="block"),INVOICE_NEW.totalItems<=0&&(t=!1,n+="Documento vazio. <br>",o.style.display="block"),INVOICE_NEW.totalInvoice<=0&&(t=!1,n+="O valor total do documento deve ser superior a zero. <br>",a.style.display="block"),1==INVOICE_NEW_TYPE&&(INVOICE_NEW.diference<0&&(t=!1,n+="Valor do pagamento insuficiente. <br>","btFinish"==e&&(showParts("divVDFactPayment"),hideParts("divVDFactFinish")),r.style.display="block"),INVOICE_NEW.balance>0&&(checkPermission("0206")?showNotification("Atenção: Está a gerar adiantamento (saldo em conta corrente)"):(t=!1,n+="Valor do pagamento superior ao valor do documento. <br>",l.style.display="block"))),2==INVOICE_NEW_TYPE||3==INVOICE_NEW_TYPE){var c=0;INVOICE_PAYMENTS_SCHEDULE.forEach(e=>(function(e){c+=Number(e.paymentAmount)})(e)),c<Number(INVOICE_NEW.totalInvoice)-Number(INVOICE_NEW.WithholdingTaxAmount)&&(t=!1,n+="Deve indicar as condições de pagamento. <br>","btFinish"==e&&(showParts("divVDFactPayment"),hideParts("divVDFactFinish")),r.innerHTML="Deve indicar as condições de pagamento.",r.style.display="block")}2!=INVOICE_NEW_TYPE&&3!=INVOICE_NEW_TYPE&&5!=INVOICE_NEW_TYPE||9999==INVOICE_NEW.customerId&&(t=!1,n+="Não deve emitir Encomenda, Venda a crédito ou Factura em nome de 'Consumidor final'. <br>",i.style.display="block"),INVOICE_NEW.extraNote=reviewString(document.getElementById("txtVDFactFinalNote")),""!=INVOICE_NEW.extraNote&&(INVOICE_NEW.extraNote=BILLING_SETTING.extranoteprefix+" "+INVOICE_NEW.extraNote);var s=document.getElementById("txtVDFactExpeditionDate").value+" "+document.getElementById("txtVDFactExpeditionTime").value;return INVOICE_NEW.expeditiondate=s,document.getElementById("lbVDFactMessage").innerHTML=n,"btFinish"==e&&(1==ST_SA_WAITING_SERVER&&(n+="Aguardando resposta do servidor. <br>"),""!=n&&showNotification(n,0)),t}function invoiceFinishDocument(e){if(0!=invoiceCanFinishDocument("btFinish")){var t=document.getElementById("selVDFactShipLocation").value,n=document.getElementById("lbHearderCompanyName").innerHTML,i=getElementInnerHtml("lbVDFacCustomerName"),o=getElementInnerHtml("lbVDFacCustomerEmail"),a=getElementInnerHtml("lbVDFacCustomerPhone1");""==a&&(a=getElementInnerHtml("lbVDFacCustomerPhone2")),""==a&&(a=getElementInnerHtml("lbVDFacCustomerPhone3")),invoiceSaveDocument("VD",t,n,i,o,a)}}function invoiceSaveDocument(e,t,n,i="",o="",a=""){var r="&&movimentLines={",l="&&invoiceLines={",c=0,s=0;INVOICE_LINES.forEach(e=>(function(e){0!=e.status&&(0!=c&&(l+=","),l+='"'+c+'":'+JSON.stringify(e),c+=1,Number(INVOICE_NEW_TYPE)<=3&&1==BILLING_SETTING.checkstockonbilling&&1==BILLING_SETTING.descountstockonbilling&&1==e.productStock&&(INVOICE_NEW.descountStockOnBilling=1,0!=s&&(r+=","),e.serialnumber="",e.lotenumber="",r+='"'+s+'":'+JSON.stringify(e),s+=1))})(e)),l+="}",r+="}",l+="&&newInvoice="+JSON.stringify(INVOICE_NEW),l+="&&invoicePayments={",c=0,INVOICE_PAYMENTS.forEach(e=>(function(e){Number(e.amount)>0&&(0!=c&&(l+=","),l+='"'+c+'":'+JSON.stringify(e),c+=1)})(e)),l+="}",l+="&&invoicePaymentsSchedule={",c=0,INVOICE_PAYMENTS_SCHEDULE.forEach(e=>(function(e){0!=c&&(l+=",");l+='"'+c+'":'+JSON.stringify(e),c+=1})(e)),l+="}",showNotification(),ST_SA_WAITING_SERVER=1;var u=new XMLHttpRequest,m="action=saveInvoiceNew&&shipLocation="+t+l;l=URL_SA_INVOICE_X,u.open("POST",l,!0),u.setRequestHeader("Content-type","application/x-www-form-urlencoded"),u.onreadystatechange=function(){if(4==u.readyState&&200==u.status){ST_SA_WAITING_SERVER=0;try{var t=JSON.parse(this.responseText)}catch(e){showHttpResponseText(u)}if(1==t.status){var l=t.invoiceNumber,c=t.in,s=DOCUMENT_TYPE[c.slice(0,2)]+" nº"+c;showPrintOptions(function(){invoicePrintReceipt(l)},function(){invoicePrintA4(l)},function(){var e=document.getElementById("txtPriPrevCustomerEmail").value;invoiceSendByEmail(l,n,s,i,e)},function(){var e=document.getElementById("btPriPrevSendWhatsApp").value;invoiceSendByWhatsApp(l,s,i,e)},o,a),setTimeout(function(){if(Number(INVOICE_NEW_TYPE)<=3&&1==BILLING_SETTING.checkstockonbilling)if(1==BILLING_SETTING.descountstockonbilling)1==INVOICE_NEW.descountStockOnBilling&&invoiceDescountStockOnBilling(t.in,r);else if(1==BILLING_SETTING.movimentafterbilling&&checkPermission("0306"));hideParts("divVDFactFinish"),invoiceSetNew(INVOICE_NEW_TYPE,10,e)},2e3)}else showNotification(t.msg,0)}},u.send(m)}function invoiceDescountStockOnBilling(e,t){movimentSetNew("",INVOICE_NEW.customerId,"VD"),MOVIMENT_OF_GOODS_NEW.invoiceUser=SYSTEM_USER_STATUS.userId,MOVIMENT_OF_GOODS_NEW.invoiceSellerUser=INVOICE_NEW.sellerUser,MOVIMENT_OF_GOODS_NEW.invoiceManagerUser=INVOICE_NEW.managerUser,MOVIMENT_OF_GOODS_NEW.invoicePartnershipUser=INVOICE_NEW.partnershipUser,MOVIMENT_OF_GOODS_NEW.movimenttargettype=1,MOVIMENT_OF_GOODS_NEW.invoicetype="GR",MOVIMENT_OF_GOODS_NEW.invoiceserie=invoiceDucumentSerie("GR"),MOVIMENT_OF_GOODS_NEW.originatingon=e,MOVIMENT_OF_GOODS_NEW.stocksource=SYSTEM_USER_STATUS.billingStockId,t+="&&movimentNew="+JSON.stringify(MOVIMENT_OF_GOODS_NEW),showNotification();var n=new XMLHttpRequest,i="action=saveMovimentNew"+t;n.open("POST","_aqconections/movimentOfGoos_crud.php",!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){4==n.readyState&&200==n.status&&(1==JSON.parse(this.responseText).status?showNotification("Aguardar pelo PDF",1):hideNotification())},n.send(i)}function paymentSelectDetails(e){var t=document.getElementById("selRecPagPaymentMecanism").value;let n=document.getElementById("divRecPagSourceBank"),i=document.getElementById("divRecPagSourceAccount"),o=document.getElementById("divRecPagTargetAccount"),a=document.getElementById("divRecPagTpaTerminal"),r=document.getElementById("divRecPagReference"),l=document.getElementById("divRecPagCreditAccount");if(hideParts(n.id),hideParts(i.id),hideParts(o.id),hideParts(a.id),hideParts(r.id),hideParts(l.id),4!=t&&8!=t||showParts(n.id),5==t&&showParts(l.id),2!=t&&7!=t||showParts(a.id),2!=t&&3!=t&&4!=t&&6!=t&&7!=t&&8!=t||showParts(o.id),2==t||3==t||4==t||6==t||7==t||8==t){let e=document.getElementById("lbRecPagReference");e.innerHTML="Referência (Per. Tr. M.):",3==t&&(e.innerHTML="Borderoux:"),4==t&&(e.innerHTML="Operação:"),6==t&&(e.innerHTML="Referência:"),8==t&&(e.innerHTML="Cheque nº:"),showParts(r.id)}if("VD"==e||"VDREC"==e){var c="VD"==e?Number(INVOICE_NEW.diference):Number(PAYMENT_NEW.diference);c<=0?(c=Math.abs(c),document.getElementById("numRecPagPaymentAmount").value=c.toFixed(2)):showNotification("Já igualou ou excedeu o valor do documento",0)}}function invoiceValidatePayment(e){var t=document.getElementById("selRecPagPaymentMecanism").value;let n=document.getElementById("selRecPagPaymentMecanism");var i=n.options[n.selectedIndex].text,o=-1,a="",r=-1,l=-1,c="",s=document.getElementById("txtRecPagPaymentDate").value,u=document.getElementById("numRecPagPaymentAmount").value;if((4==t||8==t)&&(o=document.getElementById("selRecPagBankSource").value,Number(o<1)))return showNotification("Deve indicar o banco de origem do valor a ser pago.",0),document.getElementById("selRecPagBankSource").focus(),!1;if((4==t||8==t)&&""==(a=reviewString(document.getElementById("txtRecPagAccountSource"))))return showNotification("Deve indicar conta bancária de origem do valor a ser pago.",0),document.getElementById("txtRecPagAccountSource").focus(),!1;if((2==t||7==t)&&(l=document.getElementById("selRecPagTpaTerminal").value,Number(l)<1))return showNotification("Deve indicar o TPA a qual foi feito o pagamento.",0),document.getElementById("selRecPagTpaTerminal").focus(),!1;if((2==t||3==t||4==t||6==t||7==t||8==t)&&(r=document.getElementById("selRecPagAccountTarget").value,Number(r)<1))return showNotification("Deve indicar a conta bancária a qual foi feito o pagamento.",0),document.getElementById("selRecPagAccountTarget").focus(),!1;if(2==t||3==t||4==t||6==t||7==t||8==t){c=reviewString(document.getElementById("txtRecPagReference"));var m="Referência (Per. Tr. M.):";if(3==t&&(m="Borderoux:"),4==t&&(m="Operação:"),6==t&&(m="Referência:"),8==t&&(m="Cheque nº:"),""==c.length)return showNotification("Deve indicar "+m+" do pagamento.",0),document.getElementById("txtRecPagReference").focus(),!1}if(isNaN(u))return showNotification("O valor pago dever ser numérico.",0),document.getElementById("numRecPagPaymentAmount").focus(),!1;if(Number(u)<=0)return showNotification("O valor pago dever ser superior a zero.",0),document.getElementById("numRecPagPaymentAmount").focus(),!1;if(5==t){if(isNaN(INVOICE_NEW.customerCredit))return showNotification("Não pode escolher este mecanismo enquanto não indicar o cliente.",0),!1;if(Number(u)>Number(INVOICE_NEW.customerCredit))return showNotification("Valor pago é superior ao saldo.",0),!1}function d(){var n=new _invoicePayment;n.mechanism=t,n.banksource=o,n.accountsource=a,n.accounttarget=r,n.tpaterminal=l,n.reference=c,n.date=s,n.amount=u,INVOICE_PAYMENTS[INVOICE_PAYMENTS.length]=n;let m=document.getElementById("tblRecPagPaymentsTable").insertRow(-1);m.setAttribute("class","borderGray"),m.setAttribute("id","trRecPagPaymentLine"+INVOICE_PAYMENTS.length);let d=m.insertCell(0);d.setAttribute("class","colRowNumber"),d.innerHTML=INVOICE_PAYMENTS.length;let I=m.insertCell(1);I.style.fontSize="smaller",I.style.paddingRight="5px",I.innerHTML=i;let N=m.insertCell(2);N.style.textAlign="right",N.style.paddingRight="5px",N.innerHTML=formatNumber(u).bold();let E=m.insertCell(3);var S=document.createElement("button");S.setAttribute("class","labelRemove"),S.type="button",S.style.height="20px",S.value="X",S.name=INVOICE_PAYMENTS.length,S.onclick=function(){invoicePaymentRemoveLine(S.name)},E.appendChild(S),"VDREC"==e?paymentCalculatePayment(""):invoiceCalculatePayment(""),document.getElementById("numRecPagPaymentAmount").value=0}3!=t||0==BILLING_SETTING.validatepaymentreference?d():invoiceValidatePaymentReference(r,c,d)}function invoiceValidatePaymentReference(e,t,n){var i={};i.companyId=SYSTEM_USER_STATUS.companyId,i.accountId=e,i.reference=t,showNotification("Verificando duplicidade de borderoux...");var o=new XMLHttpRequest,a="action=getInvoiceValidatePaymentReference&filterInfo="+JSON.stringify(i),r=URL_SA_INVOICE_X;o.open("POST",r,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(o.responseText);if(e.length>0){var t=JSON.parse(e[0]);t[""],setLocalDate(t[""],10);alert("Este borderoux já foi utilizado para pagamento anterior. <br><br><b>Contrato: </b>"+t.contractid+" <br><b>Cliente: </b>"+t.companyname+" ["+t.customerid+"] <br><b>Documento: </b>"+t.invoicenumber+" <br><b>Data do pagamento: </b>"+setLocalDate(t.PaymentDate,10)+" <br><b>Valor: </b>"+formatNumber(t.PaymentAmount)+" <br><b>Data de processamento: </b>"+setLocalDate(t.entrydate,16)+" <br>")}else n();hideNotification()}},o.send(a)}function invoiceCalculatePayment(e){var t=Number(INVOICE_NEW.WithholdingTaxAmount),n=0,i=0,o=0,a=Number(INVOICE_NEW.totalInvoice);INVOICE_PAYMENTS.forEach(e=>(function(e){n+=Number(e.amount),1!=e.mechanism?o+=Number(e.amount):i+=Number(e.amount)})(e));var r=n+t-a,l=0,c=0;if(r>0&&(o>a-t?(c=o-a+t,l=i):l=r>i?i:r),"undefined"!=typeof PAYMENT_NEW&&"NA"==PAYMENT_NEW.invoicetype&&(PAYMENT_NEW.balance=n),INVOICE_NEW.diference=Math.round(100*(r+Number.EPSILON))/100,INVOICE_NEW.change=l,INVOICE_NEW.balance=c,INVOICE_NEW.paymentamount=n,1==INVOICE_NEW_TYPE){document.getElementById("lbRecPagPaymentAmount").innerHTML=formatNumber(n),document.getElementById("lbVDFactWithholdingTaxAmount").innerHTML=formatNumber(t),document.getElementById("lbVDFactAmountPayed").innerHTML=formatNumber(n),document.getElementById("lbRecPagDocumentAmount").innerHTML=formatNumber(a),document.getElementById("lbVDFactChange").innerHTML=formatNumber(l),document.getElementById("lbVDFactBalance").innerHTML=formatNumber(c),document.getElementById("lbRecPagChange").innerHTML=formatNumber(l),document.getElementById("lbRecPagBalance").innerHTML=formatNumber(c);var s=document.getElementById("lbRecPagDiference");s.innerHTML=formatNumber(r),Number(r)<0?s.style.color="red":s.style.color="blue",document.getElementById("lbVDFactDiference").innerHTML=formatNumber(r)}invoiceCanFinishDocument("")}function invoicePaymentRemoveLine(e){document.getElementById("trRecPagPaymentLine"+e).innerHTML="",INVOICE_PAYMENTS[Number(e)-1].amount=0,invoiceCalculatePayment("")}function invoiceCalculatePaymentConditions(e){document.getElementById("lbVDFactWithholdingTaxAmount").innerHTML=formatNumber(INVOICE_NEW.WithholdingTaxAmount);var t=Number(Number(INVOICE_NEW.totalInvoice)-Number(INVOICE_NEW.WithholdingTaxAmount));const n=document.getElementById("numRecPagCalNumberOfInstallments"),i=document.getElementById("tblRecPagCalPaymentsTable");var o=n.value;if(INVOICE_PAYMENTS_SCHEDULE=[],document.getElementById("lbRecPagCalDocumentAmount").innerHTML=formatNumber(t),i.innerHTML="",t<=0)return n.value=1,!1;isNaN(o)&&(n.value=1),Number(o<1)&&(n.value=1,o=1);for(var a=Number(t/Number(o)),r=0,l=1;l<=o;l++){r+=1;var c=new Date;c.setDate(c.getDate()+30*l),c=c.toISOString().slice(0,10);let e=new _invoicePaymentSchedule;e.installment="Prestação "+l,e.installmentDate=c,e.paymentAmount=a,INVOICE_PAYMENTS_SCHEDULE[l-1]=e;let n=i.insertRow(-1);n.setAttribute("class","borderGray"),n.setAttribute("id","trRecPagCalPaymentLine"+INVOICE_PAYMENTS_SCHEDULE.length);let o=n.insertCell(0);o.setAttribute("class","colRowNumber"),o.innerHTML=INVOICE_PAYMENTS_SCHEDULE.length;let s=n.insertCell(1);s.style.paddingRight="5px",s.innerHTML=e.installment;let u=n.insertCell(2),m=document.createElement("input");m.id="txtRecPagCalInstallmentDate"+INVOICE_PAYMENTS_SCHEDULE.length,m.type="date",m.value=c,m.name=r;const d=r.toString();m.onchange=function(){invoiceCalculatePaymentConditionsManuel(d,1)},u.appendChild(m);let I=n.insertCell(3),N=document.createElement("input");N.id="numRecPagCalPaymentAmount"+INVOICE_PAYMENTS_SCHEDULE.length,N.type="number",N.min=0,N.value=Number(e.paymentAmount).toFixed(2),N.max=t,N.step="any",N.name=r,N.onchange=function(){invoiceCalculatePaymentConditionsManuel(d,2)},I.appendChild(N)}invoiceCanFinishDocument("")}function invoiceCheckLicenseLimit(){return Number(LICENSE_STATUS.maxinvoices)>-1&&Number(LICENSE_STATUS.currentInvoices)>=Number(LICENSE_STATUS.maxinvoices)?(showParts("divVDFactLicenseLimit"),!1):!(Number(LICENSE_STATUS.saleamount)>-1&&Number(LICENSE_STATUS.currentAmount)>=Number(LICENSE_STATUS.saleamount))||(showParts("divVDFactLicenseLimit"),!1)}function invoiceCalculatePaymentConditionsManuel(e,t){if(1==t){if(INVOICE_PAYMENTS_SCHEDULE[Number(e)-1].installmentDate=document.getElementById("txtRecPagCalInstallmentDate"+e).value,Number(e)<INVOICE_PAYMENTS_SCHEDULE.length)for(var n=Number(e);n<INVOICE_PAYMENTS_SCHEDULE.length;n++){var i=nwDate;i.setDate(i.getDate()+30),i=i.toISOString().slice(0,10),INVOICE_PAYMENTS_SCHEDULE[n].installmentDate=i,document.getElementById("txtRecPagCalInstallmentDate"+(n+1)).value=i}}else{var o=Number(document.getElementById("numRecPagCalPaymentAmount"+e).value),a=Number(Number(INVOICE_NEW.totalInvoice)-Number(INVOICE_NEW.WithholdingTaxAmount));if(isNaN(o))return!1;o>a&&(o=a),INVOICE_PAYMENTS_SCHEDULE[Number(e)-1].paymentAmount=o;var r=0;if(Number(e)>1)for(n=0;n<Number(e)-1;n++)r+=Number(INVOICE_PAYMENTS_SCHEDULE[n].paymentAmount);Number(r+o)>a&&(o=Number(a-r),INVOICE_PAYMENTS_SCHEDULE[Number(e)-1].paymentAmount=o,document.getElementById("numRecPagCalPaymentAmount"+e).value=o.toFixed(2));var l=Number(a-r-o);if(Number(e)<INVOICE_PAYMENTS_SCHEDULE.length){var c=Number(l/Number(INVOICE_PAYMENTS_SCHEDULE.length-Number(e)));for(n=Number(e);n<INVOICE_PAYMENTS_SCHEDULE.length;n++)INVOICE_PAYMENTS_SCHEDULE[n].paymentAmount=c,document.getElementById("numRecPagCalPaymentAmount"+(n+1)).value=c.toFixed(2)}}}function invoiceValidateWithholdingTax(e){var t=document.getElementById("selPayHoldTaxTaxType").value;let n=reviewString(document.getElementById("txtPayHoldTaxHoldingReason"));var i=Number(document.getElementById("numPayHoldTaxAmount").value),o=document.getElementById("lbPayHoldTaxMsg");return o.innerHTML="",""==t?(showNotification("Deve indicar o tipo de imposto retido.",0),!1):isNaN(i)?(showNotification("O valor pago dever ser numérico.",0),!1):Number(i)<0?(showNotification("O valor pago dever ser superior a zero.",0),!1):i>Number(INVOICE_NEW.totalInvoice)?(showNotification("Valor retido superior ao valor do documento.",0),!1):(i>0&&(o.innerHTML="Valor retido: "+formatNumber(i)),void("VDREC"==e?(PAYMENT_NEW.WithholdingTaxType=t,PAYMENT_NEW.WithholdingTaxDescription=n,PAYMENT_NEW.WithholdingTaxAmount=i,paymentCalculatePayment("")):(INVOICE_NEW.WithholdingTaxType=t,INVOICE_NEW.WithholdingTaxDescription=n,INVOICE_NEW.WithholdingTaxAmount=i,invoiceCalculatePayment(""))))}function invoiceBillingSettingOnLoad(e){showNotification(),checkUserStatusAfterExecute(function(){fillSelectDependencyFull("selSalBillSetDependency",-1,1),hideNotification()})}function invoiceBillingSettingGet(e="",t=0){var n=SYSTEM_USER_STATUS.companyId,i=SYSTEM_USER_STATUS.workplaceId,o=LICENSE_STATUS.licenselevel;"SALBILLSET"==e&&(i=document.getElementById("selSalBillSetDependency").value),showNotification();var a=new XMLHttpRequest,r="action=getSaleBillingSetting&companyId="+n+"&dependencyId="+i+"&licenseLevel="+o,l=URL_SA_INVOICE_X;a.open("POST",l,!0),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var n=JSON.parse(a.responseText);if(BILLING_SETTING.saletype=n.saletype,BILLING_SETTING.workingdocumenttype=n.workingdocumenttype,BILLING_SETTING.opendescount=n.opendescount,BILLING_SETTING.extranoteprefix=n.extranoteprefix,BILLING_SETTING.shelflifedocument=n.shelflifedocument,BILLING_SETTING.checkstockonbilling=n.checkstockonbilling,BILLING_SETTING.onlybillingproductinstock=n.onlybillingproductinstock,BILLING_SETTING.descountstockonbilling=n.descountstockonbilling,BILLING_SETTING.movimentafterbilling=n.movimentafterbilling,BILLING_SETTING.validatepaymentreference=n.validatepaymentreference,"SALBILLSET"==e){document.getElementById("selSalBillSetSaleDocument").value=n.saletype,document.getElementById("selSalBillSetWorkingDocumentType").value=n.workingdocumenttype,document.getElementById("rangeSalBillSetOpenDescount").value=n.opendescount,document.getElementById("txtSalBillSetExtraNotePrefix").value=n.extranoteprefix,document.getElementById("numSalBillSetShelflifeDocument").value=n.shelflifedocument;const e=document.getElementById("rangeSalBillSetCheckStock"),t=document.getElementById("rangeSalBillSetOnlyBillProductStock"),i=document.getElementById("rangeSalBillSetDescountStock"),o=document.getElementById("rangeSalBillSetMovimentAfterBilling"),a=document.getElementById("rangeSalBillSetValidatePaymentReference");e.value=n.checkstockonbilling,t.value=n.onlybillingproductinstock,i.value=n.descountstockonbilling,o.value=n.movimentafterbilling,a.value=n.validatepaymentreference,Number(LICENSE_STATUS.licenselevel)<=2&&(e.disabled="true",t.disabled="true",i.disabled="true",o.disabled="true")}else"VD"==e&&(document.getElementById("tdVDFactExtraNote").innerHTML=n.extranoteprefix,invoiceSetNew(t));hideNotification()}},a.send(r)}function invoiceBillingSettingSave(e){if(BILLING_SETTING.companyid=SYSTEM_USER_STATUS.companyId,BILLING_SETTING.dependencyid=document.getElementById("selSalBillSetDependency").value,BILLING_SETTING.saletype=document.getElementById("selSalBillSetSaleDocument").value,BILLING_SETTING.workingdocumenttype=document.getElementById("selSalBillSetWorkingDocumentType").value,BILLING_SETTING.opendescount=document.getElementById("rangeSalBillSetOpenDescount").value,BILLING_SETTING.extranoteprefix=document.getElementById("txtSalBillSetExtraNotePrefix").value,BILLING_SETTING.shelflifedocument=document.getElementById("numSalBillSetShelflifeDocument").value,BILLING_SETTING.checkstockonbilling=document.getElementById("rangeSalBillSetCheckStock").value,BILLING_SETTING.onlybillingproductinstock=document.getElementById("rangeSalBillSetOnlyBillProductStock").value,BILLING_SETTING.descountstockonbilling=document.getElementById("rangeSalBillSetDescountStock").value,BILLING_SETTING.movimentafterbilling=document.getElementById("rangeSalBillSetMovimentAfterBilling").value,BILLING_SETTING.validatepaymentreference=getElementValue("rangeSalBillSetValidatePaymentReference"),isNaN(BILLING_SETTING.dependencyid)||Number(BILLING_SETTING.dependencyid)<=0)return alert("Deve indicar a filial"),!1;if(1==ST_SA_WAITING_SERVER)return alert("Aguardando resposta do servidor. <br>"),!1;showNotification(),ST_SA_WAITING_SERVER=1;var t=new XMLHttpRequest,n="action=saveSaleBillingSetting&billingSetting="+JSON.stringify(BILLING_SETTING),i=URL_SA_INVOICE_X;t.open("POST",i,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){if(4==this.readyState&&200==this.status){ST_SA_WAITING_SERVER=0;var e=JSON.parse(t.responseText);1==e.status?showNotification(e.msg,1):showNotification(e.msg,0)}},t.send(n)}function invoiceBillingSettingDependencyOnChange(e){-1!=e.value?(showParts("divFilter"),invoiceBillingSettingGet("SALBILLSET")):hideParts("divFilter")}function invoiceSetNewFromProform(e,t,n,i){hideParts("btVDFactCustomerSearch"),document.getElementById("tblVDFactMainTable").innerHTML="",INVOICE_LINES=[],INVOICE_PAYMENTS=[],INVOICE_PAYMENTS_SCHEDULE=[],invoiceGetDocumentDetail(n),invoiceGetDocumentLines(e,t)}function invoiceGetDocumentDetail(e){var t=new XMLHttpRequest,n="action=getPostSaleInvoiceDetails&invoiceNumber="+e,i=URL_SA_POST_SALE_X;t.open("POST",i,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){if(4==t.readyState&&200==t.status){var e=JSON.parse(t.responseText);5==INVOICE_NEW_TYPE?(INVOICE_NEW.justUpdateOrder=1,INVOICE_NEW.invoiceNumber=e.invoicenumber):INVOICE_NEW.orderReference=e.invoicenumber,INVOICE_NEW.customerId=e.customerid,INVOICE_NEW.contractid=e.contractid,INVOICE_NEW.cil=e.cil,INVOICE_NEW.customerCredit=CUSTOMER_CREDIT_ACCOUNT,INVOICE_NEW.sellerUser=e.sellerUser,INVOICE_NEW.dependencyid=SYSTEM_USER_STATUS.workplaceId,setElementInnerHtml("lbRecPagSourceAccountBalance",formatNumber(INVOICE_NEW.customerCredit)),setElementInnerHtml("lbVDFacContractId",INVOICE_NEW.contractid),setElementInnerHtml("lbVDFacCIL",INVOICE_NEW.cil),setElementInnerHtml("lbVDFacCustomerName",e.customername),setElementInnerHtml("lbVDFactCliente",e.customername),setElementInnerHtml("lbVDFacCustomerTaxId",e.customertaxid),setElementInnerHtml("lbVDFacCustomerEmail",""),setElementInnerHtml("lbVDFacCustomerPhone1",""),setElementInnerHtml("lbVDFacCustomerPhone2",""),setElementInnerHtml("lbVDFacCustomerPhone3","");var n=setLocalDate(e.expeditiondate);document.getElementById("txtVDFactExpeditionDate").value=n.toISOString().slice(0,10),document.getElementById("txtVDFactExpeditionTime").value=n.toISOString().slice(11,16),customerGetCreditAccount(INVOICE_NEW.customerId)}},t.send(n)}function invoiceGetDocumentLines(e,t){var n=new XMLHttpRequest,i="action=getInvoiceDocumentLines&invoiceNumber="+e+"&invoiceStatus="+t,o=URL_SA_INVOICE_X;n.open("POST",o,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==n.readyState&&200==n.status)try{var e=JSON.parse(n.responseText),t=0;e.forEach(e=>(function(e){invoiceAddProductByDocument(JSON.parse(e),t+=1)})(e)),invoiceCalculateTotal(""),invoiceCalculatePayment(""),invoiceCanFinishDocument("")}catch(e){showNotification(e.message,0)}},n.send(i)}function invoiceAddProductByDocument(e,t){var n=Boolean(Number(e.note)),i=Number(e.quantity),o=n||0==BILLING_SETTING.checkstockonbilling?0:e.productStock,a=n?-1:Number(e.productstockactual);if(Number(e.warehousePrice)<0)return showNotification("Produto / Serviço sem preço.",0),!1;if(0!=o&&5!=INVOICE_NEW_TYPE||(a=-1),5!=INVOICE_NEW_TYPE&&1==o)if(1==BILLING_SETTING.onlybillingproductinstock){if(Number(a)<=0)return showNotification("Sem estoque. "+e.productDescription,0),!1;Number(a)<i&&(i=a)}else a=-1;(invoiceLine=new _invoiceLine).productID=e.productId,invoiceLine.productType=e.productType,invoiceLine.productDescription=e.productDescription,invoiceLine.productBarCode=e.productBarCode,invoiceLine.productUnit=e.unitOfMeasure,invoiceLine.productSection=e.productSection,invoiceLine.productIvaCategory=e.productIvaCategory,invoiceLine.productStock=e.productStock,invoiceLine.productWeight=e.productWeight,invoiceLine.productNetWeight=e.productNetWeight,invoiceLine.devolutiondays=n?0:3,invoiceLine.productStockActual=a,invoiceLine.exemptionCode=e.taxExemptionCode,invoiceLine.exemptionReason=e.taxExemptionReason,invoiceLine.note=n,invoiceLine.gmelicense=e.gmelicense,invoiceLine.status=1,invoiceLine.quant=i,invoiceLine.warehousePrice=Number(e.warehousePrice),invoiceLine.indirectCost=Number(e.indirectCost),invoiceLine.commercialCost=Number(e.commercialCost),invoiceLine.estimatedProfit=Number(e.estimatedProfit),invoiceLine.sellerComission=Number(e.sellerComission),invoiceLine.managerComission=Number(e.managerComission),invoiceLine.fundInvestment=Number(e.fundInvestment),invoiceLine.fundReserve=Number(e.fundReserve),invoiceLine.fundSocialaction=Number(e.fundSocialaction),invoiceLine.descount=Number(e.settlementAmount),invoiceLine.iva=Number(e.iva),Number(SYSTEM_USER_STATUS.taxGroup)<=1&&(n||(invoiceLine.exemptionCode="M04",invoiceLine.exemptionReason="IVA – Regime de exclusão",invoiceLine.iva=0));INVOICE_LINES[Number(t-1)]=invoiceLine;let r=document.getElementById("tblVDFactMainTable").insertRow(-1);r.setAttribute("class","borderGray"),r.setAttribute("id","trVDFactInvLine"+t),n&&(r.style.fontStyle="italic");let l=r.insertCell(-1);l.setAttribute("class","colRowNumber"),l.innerHTML=t,r.insertCell(-1).innerHTML=invoiceLine.productDescription;let c=r.insertCell(-1);if(c.setAttribute("class","colSimNao colHideSS"),c.innerHTML=invoiceLine.productUnit,n)c.setAttribute("colspan","7");else{let e=r.insertCell(-1),n=document.createElement("input");n.id="numVDFactInvQuant"+t,n.type="number",n.min="any",-1!=a&&(n.max=a),n.step="any",n.value=i,n.onchange=function(){invoiceRecaculateLine(t)},e.appendChild(n),e.style.textAlign="center",e.style.width="100px";let o=r.insertCell(-1),l=document.createElement("div"),c=document.createElement("button");c.setAttribute("class","button-in-invoice"),c.innerHTML="-",c.type="button",c.onclick=function(){n.value=Number(n.value)-1,n.dispatchEvent(new Event("change"))},l.appendChild(c);let u=document.createElement("button");u.setAttribute("class","button-in-invoice"),u.innerHTML="+",u.type="button",u.onclick=function(){n.value=Number(n.value)+1,n.dispatchEvent(new Event("change"))},l.appendChild(u),o.appendChild(l),o.style.width="70px";let m=r.insertCell(-1);m.setAttribute("id","cellVDFactInvUnitPrice"+t),m.setAttribute("class","colHideSS"),m.style.textAlign="right",m.style.width="80px",m.style.whiteSpace="nowrap",m.style.paddingRight="5px";let d=r.insertCell(-1);var s=Number(invoiceLine.descount);let I=document.createElement("input");I.id="numVDFactInvDescount"+t,I.type="number",I.min=0,I.value=s.toFixed(1),I.max=s,I.step="any",0==BILLING_SETTING.opendescount&&(I.disabled="true"),I.onchange=function(){invoiceRecaculateLine(t)},d.appendChild(I),d.setAttribute("class","colHideSS"),d.style.textAlign="right",d.style.width="70px";let N=r.insertCell(-1);N.setAttribute("class","colHideSS"),N.setAttribute("id","cellVDFactIVA"+t),N.style.textAlign="center",N.style.width="50px";let E=r.insertCell(-1);E.setAttribute("id","cellVDFactInvPVP"+t),E.style.fontSize="large",E.style.textAlign="right",E.style.whiteSpace="nowrap",E.style.paddingRight="10px"}let u=r.insertCell(-1);var m=document.createElement("button");m.setAttribute("class","labelRemove"),m.type="button",m.onclick=function(){invoiceRemoveLine(t)},u.appendChild(m),u.style.textAlign="center",u.style.width="10px",invoiceRecaculateLine(t,i,"tblVDFactMainTable")}function invoiceClearSearsher(e){setElementValue(e),document.getElementById(e).focus()}function invoiceSelectContract(e=null){null==e?(INVOICE_NEW.contractid="",INVOICE_NEW.cil="",INVOICE_NEW.customerId="",INVOICE_NEW.customerCredit=0,setElementInnerHtml("lbVDFacContractId","..."),setElementInnerHtml("lbVDFacCIL","..."),setElementInnerHtml("lbVDFacCustomerName","..."),setElementInnerHtml("lbVDFactCliente","..."),setElementInnerHtml("lbVDFacCustomerTaxId","...")):(INVOICE_NEW.contractid=e.contractid,INVOICE_NEW.cil=e.cil,INVOICE_NEW.customerId=e.customerid,INVOICE_NEW.customerCredit=Number(e.creditaccount),setElementInnerHtml("lbVDFacContractId",INVOICE_NEW.contractid),setElementInnerHtml("lbVDFacCIL",INVOICE_NEW.cil),setElementInnerHtml("lbVDFacCustomerName",e.companyname),setElementInnerHtml("lbVDFactCliente",e.companyname),setElementInnerHtml("lbVDFacCustomerTaxId",e.customertaxid),setElementInnerHtml("lbVDFacCustomerEmail",e.email),setElementInnerHtml("lbVDFacCustomerPhone1",e.telephone1),setElementInnerHtml("lbVDFacCustomerPhone2",e.telephone2),setElementInnerHtml("lbVDFacCustomerPhone3",e.telephone3)),setElementInnerHtml("lbRecPagSourceAccountBalance",formatNumber(INVOICE_NEW.customerCredit)),customerGetCreditAccount(INVOICE_NEW.customerId),Number(INVOICE_NEW.totalInvoice)>0&&(Number(INVOICE_NEW_TYPE)<=3?showDivPayment("divVDFactPayment","VD"):showParts("divVDFactFinish"))}function checkboxDonShowAgainOnClick(){var e=getElementChecked("chbSaleConsuAleDontShow"),t=SYSTEM_USER_STATUS.userId+"DONTSHOW_SALE_CONSUMPTION_START_ALERT";setCookie(t,e,3600)}function saleConsumptionGroupOnLoad(){checkUserStatusAfterExecute(function(){invoiceBillingSettingGet("SALECONSU"),fillSelectMonth("selSaleConsuGroMonth",1,(new Date).getMonth()+1),fillSelectDependencyFull("selSaleConsuGroDependency",-1,1),fillSelectConsumerTypeAqua("selSaleConsuGroConsumerType"),fillSelectMunicipality("selSaleConsuGroMunicipality",SYSTEM_USER_STATUS.provinceId,-1),fillSelectNeiborhood("selSaleConsuGroNeiborhood",3,-1),1!=getCookie(SYSTEM_USER_STATUS.userId+"DONTSHOW_SALE_CONSUMPTION_START_ALERT")&&showParts("divSaleConsumptionAlert")})}var SALE_CONSUMPTION_GROUP_INVOICE_IN_PROCESS=0,SALE_CONSUMPTION_GROUP_TOTAL_SOCESSFULL=0;function saleConsumptionGroupShow(e=null,t=!1){showParts("divSaleConsumptionGroup"),SALE_CONSUMPTION_GROUP_INVOICE_IN_PROCESS=1e9,saleConsumptionGroupDisableElements("");const n=document.getElementById("txtSaleConsuGroContractId");if(null==e)n.value="-1",document.getElementById("fldsSaleConsuGroContractsGroup").style.display="flex",hideParts("divSaleConsuGroIndividualInfo"),hideParts("divSaleCOnsuGroHistoric"),setElementInnerHtml("lbSaleConsuGroHeader","Facturação de consumo em grupo");else if(hideParts("fldsSaleConsuGroContractsGroup"),showParts("divSaleConsuGroIndividualInfo"),showParts("divSaleCOnsuGroHistoric"),setElementInnerHtml("lbSaleConsuGroHeader","Facturação de consumo individual"),n.value=e.contractid,setElementValue("txtSaleConsuGroCIL",e.cil),setElementValue("txtSaleConsuGroCustomerID",e.customerid),setElementValue("txtSaleConsuGroCompanyName",e.companyname),t){var i=new Date(e.recorddate);setElementValue("numSaleConsuGroYear",i.getFullYear()),setElementValue("selSaleConsuGroMonth",i.getMonth()+1)}else{var o=new Date(e.lastConsuptionInvoice);if(o.getFullYear()>=2e3){var a=o.getFullYear();(r=o.getMonth()+2)>12&&(r=1,a+=1)}else{var r;a=(o=new Date).getFullYear();(r=o.getMonth())<1&&(r=12,a-=1)}setElementValue("numSaleConsuGroYear",a),setElementValue("selSaleConsuGroMonth",r),saleConsumptionGroupHistoric(e.contractid)}saleConsumptionGroupGetContracts()}function saleConsumptionGroupMonthChange(){var e=Number(getElementValue("numSaleConsuGroYear")),t=Number(getElementValue("selSaleConsuGroMonth"));setElementInnerHtml("lbSaleConsuGroDays",daysInMonth(t,e))}function saleConsumptionGroupGetContracts(){try{saleConsumptionGroupMonthChange(),setElementInnerHtml("lbSaleConsuGroSucessStatus","0/0"),document.getElementById("divSaleConsuGroProgress").style.width="0%",cleanElement("tblSaleConsuGroInvoiceStatus");var e={};e.companyId=SYSTEM_USER_STATUS.companyId,e.dependencyId=getElementValue("selSaleConsuGroDependency"),e.contractid=getElementValue("txtSaleConsuGroContractId"),e.consumertype=getElementValue("selSaleConsuGroConsumerType"),e.municipalityId=getElementValue("selSaleConsuGroMunicipality"),e.neiborhood=getElementValue("selSaleConsuGroNeiborhood"),e.days=getElementInnerHtml("lbSaleConsuGroDays");var t=getElementValue("numSaleConsuGroYear"),n=getElementValue("selSaleConsuGroMonth");Number(n)<10&&(n="0"+n.toString()),e.estimateddate1=t+"-"+n+"-01",e.estimateddate2=t+"-"+n+"-"+e.days,showNotification();var i=new XMLHttpRequest,o="action=getSaleConsumptionContractNumber&filterInfo="+JSON.stringify(e),a=URL_SA_INVOICE_X;i.open("POST",a,!0),i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.onreadystatechange=function(){if(4==i.readyState&&200==i.status){var e=JSON.parse(this.responseText);setElementInnerHtml("lbSaleConsuGroContracts",e.ct),setElementInnerHtml("lbSaleConsuGroConsumptions",e.co),hideNotification()}},i.send(o)}catch(e){showNotification(e.message,0)}}function saleConsumptionGroupSave(e){try{cleanElement("tblSaleConsuGroInvoiceStatus");var t={};t.companyId=SYSTEM_USER_STATUS.companyId,t.dependencyId=getElementValue("selSaleConsuGroDependency"),t.contractid=getElementValue("txtSaleConsuGroContractId"),t.consumertype=getElementValue("selSaleConsuGroConsumerType"),t.municipalityId=getElementValue("selSaleConsuGroMunicipality"),t.neiborhood=getElementValue("selSaleConsuGroNeiborhood"),t.days=getElementInnerHtml("lbSaleConsuGroDays"),t.year=getElementValue("numSaleConsuGroYear"),t.month=getElementValue("selSaleConsuGroMonth"),Number(t.month)<10&&(t.month="0"+t.month.toString()),t.billingdate1=t.year+"-"+t.month+"-01",t.billingdate2=t.year+"-"+t.month+"-"+t.days,t.statususer=SYSTEM_USER_STATUS.userId,t.invoiceSerie=invoiceDucumentSerie("FT",10),t.shelflife=BILLING_SETTING.shelflifedocument,t.taxGroup=SYSTEM_USER_STATUS.taxGroup;var n=new Date,i=new Date(t.billingdate2);if(n.getTime()<=i.getTime())return alert("Não pode facturar um período superior a data corrente. <br>"),!1;if(1==ST_SA_WAITING_SERVER)return alert("Aguardando resposta do servidor. <br>"),!1;var o="Tem a certeza que deseja processar facturas para o mês "+t.year+"/"+t.month+"?";showConfirm(o,function(){saleConsumptionGroupDisableElements("true"),showNotification("Esta operação pode demorar alguns minutos."),ST_SA_WAITING_SERVER=1;var e=new XMLHttpRequest,n="action=getSaleConsumptionContractList&filterInfo="+JSON.stringify(t),i=URL_SA_INVOICE_X;e.open("POST",i,!0),e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.onreadystatechange=function(){if(4==e.readyState&&200==e.status){ST_SA_WAITING_SERVER=0;var n=JSON.parse(e.responseText),i=n.length;setElementInnerHtml("lbSaleConsuGroSucessStatus","0/"+i),i>0?(SALE_CONSUMPTION_GROUP_INVOICE_IN_PROCESS=-1,SALE_CONSUMPTION_GROUP_TOTAL_SOCESSFULL=0,saleConsumptionProcessInvoice(n,t),document.getElementById("lbSaleConsuGroSucessStatus").focus()):(saleConsumptionGroupDisableElements(),showNotification("Não foram encontrados facturas.",0))}},e.send(n)})}catch(e){showNotification(e.message,0)}}function saleConsumptionProcessInvoice(e,t){SALE_CONSUMPTION_GROUP_INVOICE_IN_PROCESS+=1,document.getElementById("divSaleConsuGroProgress").style.width=Math.round((SALE_CONSUMPTION_GROUP_INVOICE_IN_PROCESS+1)/e.length*100)+"%";var n=JSON.parse(e[SALE_CONSUMPTION_GROUP_INVOICE_IN_PROCESS]);let i=document.getElementById("tblSaleConsuGroInvoiceStatus");var o=i.rows.length+1;let a=i.insertRow(-1);a.setAttribute("class","borderGray");let r=a.insertCell(-1);r.setAttribute("class","colRowNumber"),r.innerHTML=o,r.style.width="10px";let l=a.insertCell(-1);l.setAttribute("class","colProductId"),l.innerHTML=n.contractid;let c=a.insertCell(-1);c.setAttribute("class","colProductId"),c.innerHTML=n.cil,a.insertCell(-1).innerHTML=n.companyname;let s=a.insertCell(-1);s.innerHTML="Processando...";var u=new XMLHttpRequest,m="action=getSaleConsumptionContractSaveInvoice&contractInfo="+JSON.stringify(n)+"&filterInfo="+JSON.stringify(t),d=URL_SA_INVOICE_X;u.open("POST",d,!0),u.setRequestHeader("Content-type","application/x-www-form-urlencoded"),u.onreadystatechange=function(){if(4==u.readyState&&200==u.status){try{var i=JSON.parse(u.responseText)}catch(e){showHttpResponseText(u)}var o="Não processado.";if(1==i.status){o=i.in,SALE_CONSUMPTION_GROUP_TOTAL_SOCESSFULL+=1,setElementInnerHtml("lbSaleConsuGroSucessStatus",SALE_CONSUMPTION_GROUP_TOTAL_SOCESSFULL+"/"+e.length);let t=a.insertCell(-1);t.setAttribute("class","colAmount"),t.innerHTML=formatNumber(i.co);let n=a.insertCell(-1);n.setAttribute("class","colAmount"),n.innerHTML=formatNumber(i.ftax);let r=a.insertCell(-1);r.setAttribute("class","colAmount"),r.innerHTML=formatNumber(i.vtax);let l=a.insertCell(-1);l.setAttribute("class","colAmount"),l.innerHTML=formatNumber(i.iva)}s.innerHTML=o,SALE_CONSUMPTION_GROUP_INVOICE_IN_PROCESS<e.length-1?saleConsumptionProcessInvoice(e,t):(saleConsumptionGroupDisableElements(),hideNotification(),setElementValue("numSaleConsuLisYear",t.year),setElementValue("selSaleConsuLisMonth",getElementValue("selSaleConsuGroMonth")),1==e.length?(saleConsumptionListDetails(n.customerid),saleConsumptionGroupHistoric(n.contractid)):saleConsumptionListDetails())}},u.send(m)}function saleConsumptionGroupDisableElements(e=""){document.getElementById("selSaleConsuGroDependency").disabled=e,document.getElementById("selSaleConsuGroConsumerType").disabled=e,document.getElementById("selSaleConsuGroMunicipality").disabled=e,document.getElementById("selSaleConsuGroNeiborhood").disabled=e,document.getElementById("numSaleConsuGroYear").disabled=e,document.getElementById("selSaleConsuGroMonth").disabled=e}function saleConsumptionListOnLoad(){try{showNotification(),checkUserStatusAfterExecute(function(){setDocumentType(""),setPaymentMechanism(""),setLinkRequestStatus(),fillSelectDependencyFull("selSaleConsuLisDependency",-1,1),fillSelectMonth("selSaleConsuLisMonth",1,(new Date).getMonth()),fillSelectConsumerTypeAqua("selSaleConsuLisConsumerType",-1),fillSelectMunicipality("selSaleConsuLisMunicipality",SYSTEM_USER_STATUS.provinceId,-1,-1),fillSelectNeiborhood("selSaleConsuLisNeiborhood",3,-1),document.getElementById("chbSaleConsuLisShowDate").onclick=function(){setEnableDisableByCheckBox(this.id,"numSaleConsuLisYear","selSaleConsuLisMonth")},checkPermission("0202")?(showParts("btSaleConsuLisNewSaleConsumptionSingle",!0),showParts("btSaleConsuLisNewSaleConsumptionGroup",!0)):(hideParts("btSaleConsuLisNewSaleConsumptionSingle"),hideParts("btSaleConsuLisNewSaleConsumptionGroup")),checkPermission("3210")?showParts("btSaleConsuLisRecordList",!0):hideParts("btSaleConsuLisRecordList"),checkPermission("3220")?showParts("btSaleConsuLisEstimatedList",!0):hideParts("btSaleConsuLisEstimatedList");var e=sessionStorage.getItem("hydrometerRecordDetail");if(null!=e&&""!=e){var t=document.getElementById("btSaleConsuListPending");showParts(t.id,!0),t.onclick=function(){saleConsumptionGroupShow(JSON.parse(e),!0),hideParts(t.id)},sessionStorage.setItem("hydrometerRecordDetail","")}saleConsumptionListDetails(),hideNotification()})}catch(e){showNotification(e.message,0)}}function saleConsumptionListDetails(e=-1,t=-1){try{if(1==ST_SA_LISTING_SERVER)return showNotification("Procurando...",1),!1;var n={};if(n.companyId=SYSTEM_USER_STATUS.companyId,n.dependencyId=getElementValue("selSaleConsuLisDependency"),n.dependencyId<=0&&Number(SYSTEM_USER_STATUS.billingprofile)<BILLING_PROFILE_PARTNER_INDEX)return showNotification("Seleccionar uma filial.",0),!1;n.filterByDate=getElementChecked("chbSaleConsuLisShowDate");var i=getElementValue("numSaleConsuLisYear"),o=getElementValue("selSaleConsuLisMonth");Number(o)<10&&(o="0"+o.toString()),n.billingDate=i+"-"+o+"-01",n.consumertype=getElementValue("selSaleConsuLisConsumerType"),n.municipalityId=getElementValue("selSaleConsuLisMunicipality"),n.neiborhood=getElementValue("selSaleConsuLisNeiborhood"),n.customerid=e,n.userId=t,n.onlynumber=1,n.startIdx=0,n.endIdx=0,showNotification(),ST_SA_LISTING_SERVER=1;var a=new XMLHttpRequest,r="action=getSaleConsumptionListDetails&filterInfo="+JSON.stringify(n),l=URL_SA_INVOICE_X;a.open("POST",l,!0),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){ST_SA_LISTING_SERVER=0;try{var e=JSON.parse(this.responseText)}catch(e){return showHttpResponseText(a),!1}var t=e.n;t<=0?showNotification("Não encontrado.",0):hideDivFilter(),cleanElement("tblSaleConsuLisListTable");var i=document.getElementById("numResultPageNumber"),o=document.getElementById("numResultItems");function r(){var e=Number(i.value),a=Number(o.value),r=(e-1)*a,l=r+a;l>t&&(l=t);var c=n;c.onlynumber=0,c.totalItems=t,c.startIdx=r,c.endIdx=l,saleConsumptionListDetailsFilter(c)}i.value=1,setResultTotalPages(i.id,o.id,t),i.onchange=function(){r()},o.onchange=function(){setResultTotalPages(i.id,o.id,t),r()},r()}},a.send(r)}catch(e){showNotification(e.message,0)}}function saleConsumptionListDetailsFilter(e){var t=new XMLHttpRequest,n="action=getSaleConsumptionListDetails&filterInfo="+JSON.stringify(e),i=URL_SA_INVOICE_X;t.open("POST",i,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){if(4==t.readyState&&200==t.status){ST_SA_LISTING_SERVER=0;var n=JSON.parse(this.responseText),i={},o={};setElementInnerHtml("lbResultOnList",e.endIdx+" / "+e.totalItems);let t=document.getElementById("tblSaleConsuLisListTable");t.innerHTML="";for(var a=e.startIdx,r=0;r<n.length;r++){var l=n[r];let e=JSON.parse(l);const I=e.invoicenumber,N=e.printnumber;e.customerid;var c=CONSUMER_TYPE_AQUA[Number(e.consumertype)],s=e.billingneiborhood,u=getOperatorName(e.operatorName,e.Sourceidstatus);addAmountResume(i,c,1),addAmountResume(o,s,1),a+=1;let E=t.insertRow(-1);E.id="trSaleConsuList"+I,E.setAttribute("class","borderGray"+setSelectedRowBackground("SELECTED_ROW_SALE_CONSUMPTION_LIST",E.id));let S=E.insertCell(-1);S.setAttribute("class","colRowNumber"),S.innerHTML=a;let p=E.insertCell(-1);p.setAttribute("class","colProductId"),p.innerHTML=dateYearMonthExtension(e.billingstartdate),E.insertCell(-1).innerHTML=e.invoicenumber;let v=E.insertCell(-1);v.setAttribute("class","colAmount"),v.innerHTML=formatNumber(e.totalInvoice);let C=E.insertCell(-1);C.setAttribute("class","colProductId"),C.innerHTML=e.contractid,E.insertCell(-1).innerHTML=e.cil,E.insertCell(-1).innerHTML=e.companyname+" ["+e.customerid+"]",E.insertCell(-1).innerHTML=e.billingMunicipality,E.insertCell(-1).innerHTML=s;var m="black",d=e.invoicestatus;"A"==d&&(m="red");let h=E.insertCell(-1);h.setAttribute("class","c "),h.innerHTML=getDocumentStatus(d),h.style.color=m;let b=E.insertCell(-1);b.setAttribute("class","colProductId"),b.innerHTML=setLocalDate(e.invoiceStatusDate,16);let g=E.insertCell(-1);g.setAttribute("class","colProductId"),g.innerHTML=u;let y=E.insertCell(-1);if(y.setAttribute("class","noPrint"),checkPermission("0205")){let t=document.createElement("button");t.type="button",t.innerHTML="Recibo",t.setAttribute("class","labelPayment"),t.onclick=function(){setSelectedRowOnClick(E,"SELECTED_ROW_SALE_CONSUMPTION_LIST"),e.companyid=SYSTEM_USER_STATUS.companyId,e.newCustomerName=e.companyname,e.newTaxId=e.customertaxid,e.transactiondate=e.invoicedate,sessionStorage.setItem("invoiceInvoiceInvoiceNumber",JSON.stringify(e)),window.location.assign("SalePayment.php")},y.appendChild(t)}let T=document.createElement("button");T.type="button",T.setAttribute("class","labelDetail"),T.onclick=function(){setSelectedRowOnClick(E,"SELECTED_ROW_SALE_CONSUMPTION_LIST"),postSaleViewDetail(N)},y.appendChild(T);let f=document.createElement("button");if(f.setAttribute("class","labelPrint"),f.type="button",f.onclick=function(){var t=document.getElementById("lbHearderCompanyName").innerHTML,n=e.companyname,i=DOCUMENT_TYPE[I.slice(0,2)]+" nº"+I,o=e.email,a=e.telephone1;showPrintOptions(function(){invoicePrintReceipt(N,2)},function(){invoicePrintA4(N,2)},function(){var e=getElementValue("txtPriPrevCustomerEmail");invoiceSendByEmail(N,t,i,n,e)},function(){var e=getElementValue("btPriPrevSendWhatsApp");invoiceSendByWhatsApp(N,i,n,e)},o,a),setSelectedRowOnClick(E,"SELECTED_ROW_SALE_CONSUMPTION_LIST")},y.appendChild(f),checkPermission("0202")){let t=document.createElement("button");t.type="button",t.innerHTML="Dívida",t.onclick=function(){setSelectedRowOnClick(E,"SELECTED_ROW_SALE_CONSUMPTION_LIST"),sessionStorage.setItem("customerid",JSON.stringify(e)),window.location.assign("SaleReportInvoiceMissingPayment.php")},y.appendChild(t)}}var I=document.getElementById("tblSaleConsuLisResumeTable");for(var l in I.innerHTML="",a=0,i)a+=1,resume(I,a,"Tipo de consumidor",i,l,"Facturas");for(var l in a=0,o)a+=1,resume(I,a,"Bairro",o,l,"Facturas");hideNotification()}},t.send(n)}function saleConsumptionGroupHistoric(e){var t={};t.contractid=e;var n=new XMLHttpRequest,i="action=getSaleConsumptionGroupHistoric&filterInfo="+JSON.stringify(t),o=URL_SA_INVOICE_X;n.open("POST",o,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==n.readyState&&200==n.status){var e=JSON.parse(this.responseText);let n=document.getElementById("tblSaleConsuGroHistoric");n.innerHTML="";for(var t=0;t<e.length;t++){var i=e[t];let r=JSON.parse(i);r.invoicenumber;let l=n.insertRow(-1);l.setAttribute("class","borderGray");let c=l.insertCell(-1);c.setAttribute("class","colProductId"),c.innerHTML=setLocalDate(r.billingstartdate,10);let s=l.insertCell(-1);s.setAttribute("class","colProductId"),s.innerHTML=setLocalDate(r.billingenddate,10);let u=l.insertCell(-1);u.setAttribute("class","colProductId"),u.innerHTML=formatNumber(r.consumptionamount);let m=l.insertCell(-1);m.setAttribute("class","colProductId colAmount"),m.innerHTML=formatNumber(r.totalInvoice);var o="black",a=r.invoicestatus;"A"==a&&(o="red");let d=l.insertCell(-1);d.setAttribute("class","c "),d.innerHTML=getDocumentStatus(a),d.style.color=o}}},n.send(i)}var INVOICE_IMPORT_LINES=[];function saleInvoiceImportLoteOnLoad(e){showNotification(),checkUserStatusAfterExecute(function(){INVOICE_IMPORT_LINES=[],"GME"==e?showParts("divSaleInvImpLoteNUS"):hideParts("divSaleInvImpLoteNUS"),hideNotification()})}function saleInvoiceImportLoteCleanTable(){INVOICE_IMPORT_LINES=[],cleanElement("tblSaleInvImpLoteMainTable")}function saleInvoiceImportLoteAddInvoice(e=0){showNotification();let t=document.getElementById("tblSaleInvImpLoteMainTable");var n=Number(t.rows.length)+1,i=new _invoiceImport;0!=e?i=e:i.invoicedate=setLocalDate(new Date,10),i.status=1,INVOICE_IMPORT_LINES[Number(n-1)]=i;let o=t.insertRow(-1);o.setAttribute("class","borderGray"),o.setAttribute("id","rowSaleInvImpLote"+n);let a=o.insertCell(-1);a.style.width="10px",a.setAttribute("class","colRowNumber"),a.innerHTML=n;let r=o.insertCell(-1);r.style.width="100px";let l=document.createElement("input");l.setAttribute("class","textUpperUcase"),l.id="txtSaleInvImpLoteCustomerId"+n,l.type="text",l.maxlength="95",l.value=i.customertid,l.onchange=function(){saleInvoiceImportLoteOnChange(n,this,"customertid")},r.appendChild(l);let c=o.insertCell(-1);c.style.width="150px";let s=document.createElement("input");s.setAttribute("class","textUpperUcase"),s.id="txtSaleInvImpLoteCompanyName"+n,s.type="text",s.maxlength="95",s.value=i.companyname,s.onchange=function(){saleInvoiceImportLoteOnChange(n,this,"companyname")},c.appendChild(s);let u=o.insertCell(-1);u.style.width="50px";let m=document.createElement("input");m.setAttribute("class","textUpperUcase"),m.id="txtSaleInvImpLoteInvoiceNumber"+n,m.type="text",m.maxlength="95",m.value=i.invoiceNumber,m.onchange=function(){saleInvoiceImportLoteOnChange(n,this,"invoiceNumber")},u.appendChild(m);let d=o.insertCell(-1);d.style.width="70px";let I=document.createElement("input");I.id="txtSaleInvImpLoteInvDate"+n,I.type="date",I.value=i.invoicedate,I.onchange=function(){saleInvoiceImportLoteOnChange(n,this,"invoicedate")},d.appendChild(I);let N=o.insertCell(-1);N.style.width="150px";let E=document.createElement("input");E.setAttribute("class","textUpperUcase"),E.id="txtSaleInvImpLoteTotalInvoice"+n,E.type="number",E.min="0",E.value=i.totalinvoice,E.onchange=function(){saleInvoiceImportLoteOnChange(n,this,"totalinvoice")},N.appendChild(E);let S=o.insertCell(-1);var p=document.createElement("button");p.setAttribute("class","labelRemove"),p.type="button",p.onclick=function(){INVOICE_IMPORT_LINES[Number(n-1)].status=0,o.innerHTML=""},S.appendChild(p),S.style.textAlign="center",S.style.width="10px",hideNotification()}function saleInvoiceImportLoteOnChange(e,t,n,i=!1){var o=t.value;i||(o=reviewString(t).toString().toUpperCase(),t.value=o),INVOICE_IMPORT_LINES[Number(e)-1][n]=o}function saleInvoiceImportLoteAddInvoiceFromCSV(){document.getElementById("txtSaleInvImpLoteCSV").value.split("/-.").forEach(e=>(function(e){var t=new _invoiceImport,n=e.split(";");t.customertid=n[0].trim().toUpperCase(),t.companyname=n[1].toUpperCase(),t.invoiceNumber=n[2].toUpperCase(),t.invoicedate=setLocalDate(n[3],10),t.totalinvoice=n[4],saleInvoiceImportLoteAddInvoice(t)})(e))}function saleInvoiceImportLoteSave(e){if(saleInvoiceImporteLoteCheckMandatoryField())return!1;if(saleInvoiceImportLoteCheckDucplicateInfo("invoiceNumber","Nº da factura"))return!1;var t=SYSTEM_USER_STATUS.companyId,n=SYSTEM_USER_STATUS.workplaceId;if("GME"==e){if(t=reviewString(document.getElementById("txtSaleInvImpLoteNUS")),isNaN(t)||""==t)return alert("Deve indicar o código NUS da empresa"),!1;if(n=reviewString(document.getElementById("txtSaleInvImpLoteDependency")),isNaN(n)||""==n)return alert("Deve indicar a filial de destino."),!1}if(1==ST_SA_WAITING_SERVER)return alert("Aguardando resposta do servidor. <br>"),!1;var i=document.getElementById("divSaleInvImpLoteResulte");i.innerHTML="",showNotification("Esta operação pode demorar alguns minutos.");for(var o=0;o<INVOICE_IMPORT_LINES.length;o++){var a=o+1,r=_invoiceImport;(r=INVOICE_IMPORT_LINES[o]).companyid=t,r.dependencyid=n,r.userId=SYSTEM_USER_STATUS.userId,1==r.status&&l(r,a)}function l(e,t){ST_SA_WAITING_SERVER=1;var n=new XMLHttpRequest,o="action=saveInvoiceImportLote&invoiceInfo="+JSON.stringify(e),a=URL_SA_INVOICE_X;n.open("POST",a,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==this.readyState&&200==this.status){ST_SA_WAITING_SERVER=0;try{var o=JSON.parse(n.responseText)}catch(e){return showHttpResponseText(n),!1}let a=document.createElement("span");a.innerHTML="Linha "+t+", Cliente "+e.customertid+", nome "+e.companyname+", Factura "+e.invoiceNumber+". Mensagem: "+o.msg,i.appendChild(a),1!=o.status?(document.getElementById("rowSaleInvImpLote"+t).style.color="red",a.style.color="red"):(document.getElementById("rowSaleInvImpLote"+t).style.color="gray",e.status=0),hideNotification()}},n.send(o)}}function saleInvoiceImporteLoteCheckMandatoryField(){if(INVOICE_IMPORT_LINES.length<=0)return alert("Não foram adicionadas linhas."),!1;for(var e=!1,t="",n=0;n<INVOICE_IMPORT_LINES.length;n++){var i,o="";if(1==(i=INVOICE_IMPORT_LINES[n]).status){""==i.customertid&&(o+="Deve indicar o cliente. "),""==i.invoiceNumber&&(o+="Deve indicar o número da factura. ");var a=new Date(i.invoicedate);validateDate(a)||(o+="Data da factura fora do formato. "),isNaN(i.totalinvoice)||""==i.totalinvoice?o+="O valor da factura deve ser numérico. ":Number(i.totalinvoice)<=0&&(o+="O valor da factura deve ser superior a zero. "),""!=o&&(e=!0,t+=o="Linha "+Number(n+1)+": "+o+" <br>")}}return e&&alert(t),e}function saleInvoiceImportLoteCheckDucplicateInfo(e,t){if(INVOICE_IMPORT_LINES.length<=0)return alert("Não foram adicionadas linhas."),!1;for(var n=!1,i="",o=[],a=0;a<INVOICE_IMPORT_LINES.length;a++){var r=INVOICE_IMPORT_LINES[a];if(1==r.status&&!o.includes(r[e])){o[a]=r[e];for(var l=0;l<INVOICE_IMPORT_LINES.length;l++)if(a!=l){var c=INVOICE_IMPORT_LINES[l];1==c.status&&r[e]==c[e]&&(i+="Duplicado "+t+" "+r[e]+" Linhas "+Number(a+1)+" / "+Number(l+1)+" <br>",n=!0)}}}return n&&alert(i),n}