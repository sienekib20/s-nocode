class _movimentOfGoods{constructor(e,t=0,n="GR",i="2021",o=1,r=-1,s=-1,a=-1,d=-1,c=-1,l=-1,u="",m="",p="",S=0,E=0,v=0,O=1,y=-1,h=-1,g="",_=1,T=-1,N=-1,M="",I="",P="",f="",b="",D="",L="",C="",w="",B="",G=-1,R=-1,x=-1,A=-1,V=-1,W=-1,F=-1){this.companyid=e,this.dependencyid=t,this.invoicetype=n,this.invoiceserie=i,this.invoicesequence=o,this.sourceid=r,this.customerid=s,this.movimenttargettype=a,this.stocksource=d,this.supplierid=c,this.dependencyidtarget=l,this.department=u,this.movimentreason=m,this.originatingon=p,this.totalItems=S,this.productWeight=E,this.productNetWeight=v,this.countryshipfrom=O,this.provinceshipfrom=y,this.municipalityshipfrom=h,this.deliveryIdShipto=g,this.countryshipto=_,this.provinceshipto=T,this.municipalityshipto=N,this.cityshipto=M,this.districtshipto=I,this.comunashipto=P,this.neiborhoodshipto=f,this.streetnameshipto=b,this.buildingnumbershipto=D,this.postalcodeshipto=L,this.phoneshipto=C,this.email=w,this.extraNote=B,this.sellerUser=G,this.managerUser=R,this.partnershipUser=x,this.invoiceUser=A,this.invoiceSellerUser=V,this.invoiceManagerUser=W,this.invoicePartnershipUser=F}}class _movimentOfGoodsLine{constructor(e,t,n,i,o,r,s,a,d,c,l="",u="",m=1,p=0,S=0,E=0,v=0,O=0,y=0,h=0,g=0,_=0,T=0,N=0,M=0,I=0,P=0,f=0,b=0,D=0,L=0,C="M02",w="Transmissão de bens e serviço não sujeita",B=0,G=1){this.productID=e,this.productType=t,this.productDescription=n,this.productBarCode=i,this.productUnit=o,this.productSection=r,this.productIvaCategory=s,this.productStock=a,this.productWeight=d,this.productNetWeight=c,this.serialnumber=l,this.lotenumber=u,this.devolutiondays=m,this.productStockActual=p,this.quant=S,this.quantityPending=E,this.warehousePrice=v,this.indirectCost=O,this.commercialCost=y,this.estimatedProfit=h,this.sellerComission=g,this.managerComission=_,this.fundInvestment=T,this.fundReserve=N,this.fundSocialaction=M,this.priceWithComission=I,this.descount=P,this.iva=f,this.ivaValue=b,this.ivaWithoutDescountValue=D,this.subtotalLine=L,this.exemptionCode=C,this.exemptionReason=w,this.note=B,this.status=G}}var MOVIMENT_OF_GOODS_NEW=new _movimentOfGoods,MOVIMENT_OF_GOODS_LINES=[];function movimentOnLoad(e){try{showNotification(),checkUserStatusAfterExecute(function(){SYSTEM_USER_STATUS.companyId,setDocumentType(""),setMovimentTargetType("");const e=document.getElementById("selProdEstSaiMovimentTargetType");e.onchange=function(){movimentTargetTypeOnChange("")},fillSelectMovimentTargetType("selProdEstSaiMovimentTargetType",-1),fillSelectSupplier("selProdEstSaiSupplier",-1),document.getElementById("selProdEstSaiSupplier").onchange=function(){movimentGetSupplierInfo(this.value)},fillSelectProductStock("selProdEstSaiStockSource",1,-1),document.getElementById("selProdEstSaiStockSource").onclick=function(){movimentTargetTypeOnChange("")},fillSelectDependencyFull("selProdEstSaiDependency",-1),fillSelectCountry("selProdEstSaiShipCountry",-1),fillSelectProvince("selProdEstSaiShipProvince",-1);const t=document.getElementById("selProdEstSaiShipProvince");t.onchange=function(){fillSelectMunicipality("selProdEstSaiShipMunicipality",t.value,-1)},selectCountryChange("selProdEstSaiShipCountry","selProdEstSaiShipProvince","selProdEstSaiShipMunicipality","lbProdEstSaiShipCity"),checkPermission("0301")||hideParts("btProdEstSaiProductRegister");var n=sessionStorage.getItem("movimentPendingInvoiceNumber");if(null!=n&&""!=n){var i=sessionStorage.getItem("movimentPendingCustomerId");const t=document.getElementById("btProdEstSaiFromPending");t.style.display="inline",t.onclick=function(){e.value=1,movimentTargetTypeOnChange(""),movimentSetNew(n,i),t.style.display="none"},sessionStorage.setItem("movimentPendingInvoiceNumber",""),sessionStorage.setItem("movimentPendingCustomerId","")}else movimentSetNew();productAutocompleteList("txtProdEstSaiProduct"),setTriggerButtonByText("txtProdEstSaiProduct","btProdEstSaiAddProduct"),setTriggerButtonByText("txtProdEstSaiNote","btProdEstSaiAddNote"),hideNotification()})}catch(e){showNotification(e.message,0)}}function movimentSetNew(e="",t=-1,n=""){showNotification(),(MOVIMENT_OF_GOODS_NEW=new _movimentOfGoods).companyid=SYSTEM_USER_STATUS.companyId,MOVIMENT_OF_GOODS_NEW.dependencyid=SYSTEM_USER_STATUS.workplaceId,MOVIMENT_OF_GOODS_NEW.sourceid=SYSTEM_USER_STATUS.userId,MOVIMENT_OF_GOODS_NEW.customerid=t,MOVIMENT_OF_GOODS_NEW.originatingon=e,MOVIMENT_OF_GOODS_NEW.countryshipfrom=1,MOVIMENT_OF_GOODS_NEW.provinceshipfrom=SYSTEM_USER_STATUS.provinceId,MOVIMENT_OF_GOODS_NEW.municipalityshipfrom=SYSTEM_USER_STATUS.municipalityId,MOVIMENT_OF_GOODS_NEW.sellerUser=SYSTEM_USER_STATUS.userId,MOVIMENT_OF_GOODS_NEW.managerUser=SYSTEM_USER_STATUS.managerUser,MOVIMENT_OF_GOODS_NEW.partnershipUser=SYSTEM_USER_STATUS.partnershipUser,MOVIMENT_OF_GOODS_LINES=[],"VD"!=n&&(""!=e&&(movimentGetInvoiceDetail(e),movimentGetInvoicePendingLines(e)),-1!=t&&movimentGetCustomerInfo(t),document.getElementById("lbProdEstSaiInvoiceNumber").innerHTML=e,document.getElementById("tblProdEstSaiMainTable").innerHTML="",document.getElementById("lbProdEstSaiItems").innerHTML=0,hideNotification())}function movimentGetInvoiceDetail(e){var t=new XMLHttpRequest,n="action=getPostSaleInvoiceDetails&invoiceNumber="+e,i=URL_SA_POST_SALE_X;t.open("POST",i,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){if(4==t.readyState&&200==t.status){var e=JSON.parse(t.responseText);MOVIMENT_OF_GOODS_NEW.invoiceUser=e.sourceid,MOVIMENT_OF_GOODS_NEW.invoiceSellerUser=e.sellerUser,MOVIMENT_OF_GOODS_NEW.invoiceManagerUser=e.managerUser,MOVIMENT_OF_GOODS_NEW.invoicePartnershipUser=e.partnershipUser}},t.send(n)}function movimentGetInvoicePendingLines(e){var t=document.getElementById("selProdEstSaiStockSource").value,n=new XMLHttpRequest,i="action=getPostSaleInvoicePendingLines&invoiceNumber="+e+"&stockSource="+t,o=URL_SA_POST_SALE_X;n.open("POST",o,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==n.readyState&&200==n.status)try{JSON.parse(n.responseText).forEach(e=>(function(e){var t=JSON.parse(e),n=new _movimentOfGoodsLine;n.productID=t.productId,n.productType=t.productType,n.productDescription=t.productDescription,n.productBarCode=t.productBarCode,n.productUnit=t.unitOfMeasure,n.productSection=t.productSection,n.productIvaCategory=t.productIvaCategory,n.productStock=t.productStock,n.productWeight=t.productWeight,n.productNetWeight=t.productNetWeight,n.devolutiondays=t.devolutiondays,n.productStockActual=t.productstockactual,n.quantityPending=t.quantityPending,n.quant=Number(t.quantityPending)>Number(t.productstockactual)?t.productstockactual:t.quantityPending,n.warehousePrice=t.warehousePrice,n.indirectCost=t.indirectCost,n.commercialCost=t.commercialCost,n.estimatedProfit=t.estimatedProfit,n.sellerComission=t.sellerComission,n.managerComission=t.managerComission,n.fundInvestment=t.fundInvestment,n.fundReserve=t.fundReserve,n.fundSocialaction=t.fundSocialaction,n.priceWithComission=t.priceWithComission,n.descount=t.settlementAmount,n.iva=t.iva,n.ivaValue=t.ivaValue,n.ivaWithoutDescountValue=t.ivaWithoutDescountValue,n.subtotalLine=t.subtotalLine,n.exemptionCode=t.taxExemptionCode,n.exemptionReason=t.taxExemptionReason,n.note=t.note,n.invoiceManagerNationalUser=t.managerNationalUser,n.invoiceDirectorUser=t.directorGeneralUser;const i=document.getElementById("tblProdEstSaiMainTable").rows.length;MOVIMENT_OF_GOODS_LINES[Number(i)]=n,movimentAddLineOnTable("")})(e)),movimentCalculateTotal("")}catch(e){showNotification(e.message,0)}},n.send(i)}function movimentAddProduct(e=0){try{var t=SYSTEM_USER_STATUS.companyId,n=document.getElementById("selProdEstSaiStockSource").value;const c=document.getElementById("txtProdEstSaiProduct"),l=document.getElementById("txtProdEstSaiNote");var i=reviewString(c),o=reviewString(l);if(1==e){if(l.value="",l.focus(),""==o)return showNotification("Por favor, escreva uma nota válida",0),!1}else{if(""==i)return showNotification("Por favor, indicar um código de barra válido",0),c.value="",c.focus(),!1;if(-1==n)return showNotification("Deve indicar o estoque / armazém de origem.",0),!1}showNotification();var r=SYSTEM_USER_STATUS.workplaceId,s=new XMLHttpRequest,a="action=getProductFullDescription&companyId="+t+"&productId="+i+"&isNote="+e+"&stockId="+n+"&workplaceId="+r,d=URL_SA_PRODUCT_SALE_X;s.open("POST",d,!0),s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.onreadystatechange=function(){if(4==this.readyState&&200==this.status)try{if(""==this.responseText)return document.getElementById("txtProdEstSaiProduct").focus(),showNotification("Produto / serviço não encontrado",0),!1;var t=JSON.parse(this.responseText),n=t.id,i=e?o:t.productdescription,r=e?"":t.productunit,s=e?1:t.productsection,a=e?1:t.productivacategory,d=e?0:t.productstock,l=e?0:t.productstockactual;if(0==e){if(1==d&&Number(l)<=0)return showNotification("Sem estoque. - "+i,0),!1;if(movimentCheckItemOnLines(n))return showNotification("Produto já adicionado",0),c.value="",c.focus(),!1}var u=new _movimentOfGoodsLine;u.productID=n,u.productType=t.producttype,u.productDescription=i,u.productBarCode=t.productnumbercode,u.productUnit=r,u.productSection=s,u.productIvaCategory=a,u.productStock=d,u.productWeight=t.productweight,u.productNetWeight=t.productnetweight,u.devolutiondays=t.devolutiondays,u.productStockActual=l,u.quantityPending=-1,u.quant=1,u.warehousePrice=t.warehouseprice,u.indirectCost=t.indirectcost,u.commercialCost=t.commercialcost,u.estimatedProfit=t.estimatedprofit,u.sellerComission=t.sellercomission,u.managerComission=t.managercomission,u.fundInvestment=t.fundinvestment,u.fundReserve=t.fundreserve,u.fundSocialaction=t.fundsocialaction,u.descount=t.descount,u.iva=t.iva,u.exemptionCode=t.productexemption,u.exemptionReason=t.exemptionreason,u.note=e,u.managerNationalUser=t.managernationaluser,u.directorUser=t.directoruser;const m=document.getElementById("tblProdEstSaiMainTable").rows.length;MOVIMENT_OF_GOODS_LINES[Number(m)]=u,movimentAddLineOnTable(""),movimentCalculateTotal(""),hideNotification()}catch(e){alert(e.message)}},s.send(a)}catch(e){e.message}}function movimentAddLineOnTable(e){try{let e=document.getElementById("tblProdEstSaiMainTable"),i=e.rows.length;var t;t=MOVIMENT_OF_GOODS_LINES[Number(i)],i+=1;let o=e.insertRow(-1);o.setAttribute("class","borderGray"),o.setAttribute("id","trPROESTSAILine"+i),1==t.note&&(o.style.fontStyle="italic");let r=o.insertCell(o.cells.length);r.setAttribute("class","colRowNumber"),r.innerHTML=i;let s=o.insertCell(o.cells.length);s.setAttribute("class","colProductId colHideSS"),s.innerHTML=1==t.note?"-":t.productID;let a=o.insertCell(o.cells.length);if(a.innerHTML=t.productDescription,0==t.note){let e=o.insertCell(o.cells.length);e.setAttribute("class","colSimNao colHideSS"),e.innerHTML=t.productUnit;let n=o.insertCell(o.cells.length);n.style.textAlign="center",n.style.width="70px",n.style.whiteSpace="nowrap",n.style.paddingRight="5px",n.innerHTML=formatNumber(t.productStockActual).italics();let r=o.insertCell(o.cells.length);r.innerHTML=formatNumber(t.quantityPending).italics(),r.style.textAlign="center",r.style.width="70px",r.style.whiteSpace="nowrap",r.style.paddingRight="5px";let s=o.insertCell(o.cells.length),a=document.createElement("input");a.id="numProdEstSaiQuant"+i,a.type="number",a.min="0",1==t.productStock&&(a.max=Number(t.quantityPending)>Number(t.productStockActual)||-1==t.quantityPending?t.productStockActual:t.quantityPending),a.step="any",a.name=i,a.value=t.quant,a.onchange=function(){movimentRecaculateLine(a.name)},s.appendChild(a),s.style.textAlign="center",s.style.width="100px";let d=o.insertCell(o.cells.length),c=document.createElement("input");c.id="txtProdEstSaiSerialNumber"+i,c.type="text",c.onchange=function(){movimentRecaculateLine(a.name)},d.appendChild(c);let l=o.insertCell(o.cells.length),u=document.createElement("input");u.id="txtProdEstSaiLoteNumber"+i,u.type="text",u.onchange=function(){movimentRecaculateLine(a.name)},l.appendChild(u)}else a.setAttribute("colSpan","7");let d=o.insertCell(o.cells.length);var n=document.createElement("button");n.setAttribute("class","labelRemove"),n.type="button",n.name=i,n.onclick=function(){movimentRemoveLine(n.name)},d.appendChild(n),d.style.textAlign="center",d.style.width="10px"}catch(e){alert(e.message)}}function movimentCheckItemOnLines(e){var t=!1;return MOVIMENT_OF_GOODS_LINES.forEach(n=>(function(n){if(n.productID==e&&1==n.status)return t=!0,!0})(n)),t}function movimentCalculateTotal(e){try{var t=0,n=0,i=0;MOVIMENT_OF_GOODS_LINES.forEach(e=>(function(e){let o=_movimentOfGoodsLine;o=e;var r=Number(o.quant);o.status&&(1!=o.note&&(t+=Number(r)),n+=Number(o.productWeight)*r,i+=Number(o.productNetWeight)*r)})(e)),MOVIMENT_OF_GOODS_NEW.totalItems=t,MOVIMENT_OF_GOODS_NEW.productWeight=n,MOVIMENT_OF_GOODS_NEW.productNetWeight=i,document.getElementById("lbProdEstSaiItems").innerHTML=formatNumber(t),document.getElementById("lbProdEstSaiWeight").innerHTML=formatNumber(n),document.getElementById("lbProdEstSaiNetWeight").innerHTML=formatNumber(i)}catch(e){showNotification(e.message,0)}}function movimentRemoveLine(e){try{document.getElementById("trPROESTSAILine"+e).innerHTML="",MOVIMENT_OF_GOODS_LINES[Number(e)-1].status=0,movimentCalculateTotal("")}catch(e){showNotification(e.message,0)}}function movimentRecaculateLine(e){var t=document.getElementById("numProdEstSaiQuant"+e),n=t.value;isNaN(n)&&(n=1),n<0&&(n=0),n=Number(n);var i=_movimentOfGoodsLine;1==(i=MOVIMENT_OF_GOODS_LINES[Number(e)-1]).productStock&&(n>Number(i.productStockActual)&&(n=i.productStockActual),-1!=i.quantityPending&&n>Number(i.quantityPending)&&(n=i.quantityPending)),i.quant=Number(n),i.serialnumber=reviewString(document.getElementById("txtProdEstSaiSerialNumber"+e)),i.lotenumber=reviewString(document.getElementById("txtProdEstSaiLoteNumber"+e)),t.value=n,movimentCalculateTotal("")}function movimentGetCustomerInfo(e){var t=new XMLHttpRequest,n="action=getCustomerInfo&&customerId="+e,i=URL_SA_CUSTOMER_X;t.open("POST",i,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(this.responseText);document.getElementById("selProdEstSaiShipCountry").value=e.shipcountry,document.getElementById("selProdEstSaiShipProvince").value=e.shipprovince,fillSelectMunicipality("selProdEstSaiShipMunicipality",e.shipprovince,-1,e.shipmunicipality),document.getElementById("txtProdEstSaiShipCity").value=e.shipcity,document.getElementById("txtProdEstSaiShipDistrict").value=e.shipdistrict,document.getElementById("txtProdEstSaiShipComuna").value=e.shipcomuna,document.getElementById("txtProdEstSaiShipNeiborhood").value=e.shipneiborhood,document.getElementById("txtProdEstSaiShipStreet").value=e.shipstreetname,document.getElementById("txtProdEstSaiShipBuildNumber").value=e.shipbuildingnumber,document.getElementById("txtProdEstSaiShipPostal").value=e.shippostalcode,document.getElementById("txtProdEstSaiShipPhone").value=e.telephone1+" / "+e.telephone2,MOVIMENT_OF_GOODS_NEW.email=e.email,document.getElementById("lbProdEstSaiCustomerName").innerHTML=e.companyname,document.getElementById("lbProdEstSaiCustomerTaxId").innerHTML=e.customertaxid}},t.send(n)}function movimentGetSupplierInfo(e){if(-1==e)return!1;var t=SYSTEM_USER_STATUS.companyId,n=new XMLHttpRequest,i="action=getSupplierList&companyId="+t+"&supplierId="+e,o=URL_SA_SUPPLIER_X;n.open("POST",o,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==this.readyState&&200==this.status){JSON.parse(this.responseText).forEach(e=>(function(e){var t=JSON.parse(e);document.getElementById("selProdEstSaiShipCountry").value=t.billingcountry,document.getElementById("selProdEstSaiShipProvince").value=t.billingprovince,fillSelectMunicipality("selProdEstSaiShipMunicipality",t.billingprovince,-1,t.billingmunicipality),document.getElementById("txtProdEstSaiShipCity").value=t.billingcity,document.getElementById("txtProdEstSaiShipDistrict").value=t.billingdistrict,document.getElementById("txtProdEstSaiShipComuna").value=t.billingcomuna,document.getElementById("txtProdEstSaiShipNeiborhood").value=t.billingneiborhood,document.getElementById("txtProdEstSaiShipStreet").value=t.billingstreetname,document.getElementById("txtProdEstSaiShipBuildNumber").value=t.billingbuildingnumber,document.getElementById("txtProdEstSaiShipPostal").value=t.billingpostalcode,document.getElementById("txtProdEstSaiShipPhone").value=t.telephone1+" / "+t.telephone2,MOVIMENT_OF_GOODS_NEW.email=t.email})(e))}},n.send(i)}function movimentFinishDocument(e){MOVIMENT_OF_GOODS_NEW.movimenttargettype=document.getElementById("selProdEstSaiMovimentTargetType").value,MOVIMENT_OF_GOODS_NEW.invoicetype=document.getElementById("selProdEstSaiDocumentType").value,MOVIMENT_OF_GOODS_NEW.invoiceserie=invoiceDucumentSerie(MOVIMENT_OF_GOODS_NEW.invoicetype),MOVIMENT_OF_GOODS_NEW.stocksource=document.getElementById("selProdEstSaiStockSource").value,MOVIMENT_OF_GOODS_NEW.supplierid=document.getElementById("selProdEstSaiSupplier").value,MOVIMENT_OF_GOODS_NEW.dependencyidtarget=document.getElementById("selProdEstSaiDependency").value,MOVIMENT_OF_GOODS_NEW.department=reviewString(document.getElementById("txtProdEstSaiDepartment")),MOVIMENT_OF_GOODS_NEW.movimentreason=reviewString(document.getElementById("txtProdEstSaiReason")),MOVIMENT_OF_GOODS_NEW.deliveryIdShipto=reviewString(document.getElementById("txtProdEstSaiShipDelivery")),MOVIMENT_OF_GOODS_NEW.countryshipto=document.getElementById("selProdEstSaiShipCountry").value,MOVIMENT_OF_GOODS_NEW.provinceshipto=document.getElementById("selProdEstSaiShipProvince").value,MOVIMENT_OF_GOODS_NEW.municipalityshipto=document.getElementById("selProdEstSaiShipMunicipality").value,MOVIMENT_OF_GOODS_NEW.cityshipto=reviewString(document.getElementById("txtProdEstSaiShipCity")),MOVIMENT_OF_GOODS_NEW.districtshipto=reviewString(document.getElementById("txtProdEstSaiShipDistrict")),MOVIMENT_OF_GOODS_NEW.comunashipto=reviewString(document.getElementById("txtProdEstSaiShipComuna")),MOVIMENT_OF_GOODS_NEW.neiborhoodshipto=reviewString(document.getElementById("txtProdEstSaiShipNeiborhood")),MOVIMENT_OF_GOODS_NEW.streetnameshipto=reviewString(document.getElementById("txtProdEstSaiShipStreet")),MOVIMENT_OF_GOODS_NEW.buildingnumbershipto=reviewString(document.getElementById("txtProdEstSaiShipBuildNumber")),MOVIMENT_OF_GOODS_NEW.postalcodeshipto=reviewString(document.getElementById("txtProdEstSaiShipPostal")),MOVIMENT_OF_GOODS_NEW.phoneshipto=reviewString(document.getElementById("txtProdEstSaiShipPhone"));var t=!1,n="";if(Number(MOVIMENT_OF_GOODS_NEW.totalItems)<=0&&(t=!0,n+="Documento vazio. <br>"),Number(MOVIMENT_OF_GOODS_NEW.movimenttargettype<=0)?(t=!0,n+="Deve indicar o destino dos produtos. <br>"):(Number(MOVIMENT_OF_GOODS_NEW.stocksource<=0)&&(t=!0,n+="Deve indicar o estoque de origem dos produtos. <br>"),Number(MOVIMENT_OF_GOODS_NEW.movimenttargettype)<=2?-1==MOVIMENT_OF_GOODS_NEW.customerid&&(t=!0,n+="Deve indicar o cliente. <br>"):3==MOVIMENT_OF_GOODS_NEW.movimenttargettype?Number(MOVIMENT_OF_GOODS_NEW.dependencyidtarget)<=0&&(t=!0,n+="Deve indicar a dependência (posto), de destino dos produtos. <br>"):4==MOVIMENT_OF_GOODS_NEW.movimenttargettype||5==MOVIMENT_OF_GOODS_NEW.movimenttargettype?""==MOVIMENT_OF_GOODS_NEW.department&&(t=!0,n+="Deve indicar o departamento que vai receber os produtos. <br>"):6!=MOVIMENT_OF_GOODS_NEW.movimenttargettype&&7!=MOVIMENT_OF_GOODS_NEW.movimenttargettype||(""==MOVIMENT_OF_GOODS_NEW.movimentreason&&(t=!0,n+="Deve indicar o motivo. <br>"),7==MOVIMENT_OF_GOODS_NEW.movimenttargettype&&Number(MOVIMENT_OF_GOODS_NEW.supplierid)<=0&&(t=!0,n+="Deve indicar o forncedor dos produtos. <br>"))),"GT"!=MOVIMENT_OF_GOODS_NEW.invoicetype&&"GD"!=MOVIMENT_OF_GOODS_NEW.invoicetype||(""==MOVIMENT_OF_GOODS_NEW.deliveryIdShipto&&(t=!0,n+="Deve indicar o meio de expedição. <br>"),1==MOVIMENT_OF_GOODS_NEW.countryshipto&&(Number(MOVIMENT_OF_GOODS_NEW.provinceshipto)<=0&&(t=!0,n+="Deve indicar a província de destino. <br>"),Number(MOVIMENT_OF_GOODS_NEW.municipalityshipto)<=0&&(t=!0,n+="Deve indicar o município de destino. <br>")),""==MOVIMENT_OF_GOODS_NEW.cityshipto&&(t=!0,n+="Deve indicar o cidade de destino. <br>")),1==ST_SA_WAITING_SERVER&&(t=!0,n+="Aguardando resposta do servidor. <br>"),1==t)return alert(n),!1;showConfirm("Tem a certeza que deseja finalizar esta saída de estoque?",function(){var e="&movimentNew="+JSON.stringify(MOVIMENT_OF_GOODS_NEW);e+="&movimentLines={";var t=0;MOVIMENT_OF_GOODS_LINES.forEach(n=>(function(n){0!=n.status&&(0!=t&&(e+=","),e+='"'+t+'":'+JSON.stringify(n),t+=1)})(n)),e+="}",showNotification(),ST_SA_WAITING_SERVER=1;var n=new XMLHttpRequest,i="action=saveMovimentNew"+e;e=URL_SA_MOVIMENT_OF_GOODS_X,n.open("POST",e,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==n.readyState&&200==n.status){ST_SA_WAITING_SERVER=0;var e=JSON.parse(this.responseText);if(1==e.status){var t=document.getElementById("lbHearderCompanyName").innerHTML,i=document.getElementById("lbProdEstSaiCustomerName").innerHTML,o=e.invoiceNumber,r=e.in,s=DOCUMENT_TYPE[r.slice(0,2)]+" nº"+r,a=MOVIMENT_OF_GOODS_NEW.email,d=MOVIMENT_OF_GOODS_NEW.phoneshipto;showPrintOptions(function(){movimentPrintReceipt(o)},function(){movimentPrintA4(o)},function(){var e=document.getElementById("txtPriPrevCustomerEmail").value;movimentSendByEmail(o,t,s,i,e)},function(){var e=document.getElementById("btPriPrevSendWhatsApp").value;movimentSendByWhatsApp(o,s,i,e)},a,d),setTimeout(function(){movimentTargetTypeOnChange(),hideParts("divProdEstSaiFinish")},2e3)}else showNotification(e.msg,0)}},n.send(i)})}function movimentTargetTypeOnChange(e){movimentSetNew(e);const t=document.getElementById("selProdEstSaiMovimentTargetType").value,n=document.getElementById("divProdEstSaiDocumentType"),i=document.getElementById("selProdEstSaiDocumentType"),o=document.getElementById("divProdEstSaiSupplier"),r=document.getElementById("selProdEstSaiSupplier"),s=document.getElementById("divProdEstSaiDependency"),a=document.getElementById("selProdEstSaiDependency"),d=document.getElementById("divProdEstSaiDepartment"),c=document.getElementById("txtProdEstSaiDepartment"),l=document.getElementById("divProdEstSaiReason"),u=document.getElementById("txtProdEstSaiReason"),m=document.getElementById("btProdEstSaiCustomerSearch"),p=document.getElementById("btProdEstSaiInvoiceSearch"),S=document.getElementById("divProdEstSaiCustomerInformation"),E=document.getElementById("divProdEstSaiInvoiceNumber"),v=document.getElementById("divProdEstSaiAddProduct");if(n.style.display="none",i.innerHTML="",o.style.display="none",r.value=-1,s.style.display="none",a.value=-1,d.style.display="none",c.value="",l.style.display="none",u.value="",m.style.display="none",p.style.display="none",S.style.display="none",document.getElementById("lbProdEstSaiCustomerName").innerHTML="",document.getElementById("lbProdEstSaiCustomerTaxId").innerHTML="",document.getElementById("lbProdEstSaiInvoiceNumber").innerHTML="",v.style.display="block",1==t||2==t){n.style.display="block";let e=document.createElement("option");e.value="GR",e.innerHTML=DOCUMENT_TYPE.GR,i.appendChild(e);let o=document.createElement("option");o.value="GT",o.innerHTML=DOCUMENT_TYPE.GT,i.appendChild(o),i.value=e.value,S.style.display="inline-flex",1==t?(p.style.display="inline",E.style.display="block",v.style.display="none"):(m.style.display="inline",E.style.display="none")}else if(3==t||4==t){let e=document.createElement("option");e.value="GA",e.innerHTML=DOCUMENT_TYPE.GA,i.appendChild(e),i.value=e.value,3==t?s.style.display="block":d.style.display="block"}else if(5==t){let e=document.createElement("option");e.value="CI",e.innerHTML=DOCUMENT_TYPE.CI,i.appendChild(e),i.value=e.value,d.style.display="block"}else if(6==t){let e=document.createElement("option");e.value="AE",e.innerHTML=DOCUMENT_TYPE.AE,i.appendChild(e),i.value=e.value,l.style.display="block"}else if(7==t){let e=document.createElement("option");e.value="GD",e.innerHTML=DOCUMENT_TYPE.GD,i.appendChild(e),i.value=e.value,o.style.display="block",l.style.display="block"}}function fillSelectMovimentTargetType(e,t=1,n=0){const i=document.getElementById(e);if(!validateUserControl(i))return!1;if(i.innerHTML="",-1==t){var o=document.createElement("option");o.value="-1",o.setAttribute("class","selectPlaceHolder"),o.innerHTML="Seleccionar",i.appendChild(o)}for(var r=1;r<MOVIMENT_TARGET_TYPE.length;r++){var s=MOVIMENT_TARGET_TYPE[r];1==n&&(1==r?s="Cliente":3==r&&(s="Movimento interno / entre depedência (posto)"));let e=document.createElement("option");e.value=r,e.innerHTML=s,(0==n||1==n&&2!=r&&4!=r)&&i.appendChild(e)}}function movimentDocumentTypeChange(e){const t=document.getElementById("selProdEstSaiDocumentType").value,n=document.getElementById("divProdEstSaiDelivery"),i=document.getElementById("fldsProdEstSaiShipto");"GT"==t||"GD"==t?(n.style.display="block",i.style.display="inline-flex"):(n.style.display="none",i.style.display="none")}function movimentListOnLoad(e){showNotification(),checkUserStatusAfterExecute(function(){setSystemUserBillingProfile(""),setDocumentType(""),setMovimentTargetType(""),fillSelectMovimentTargetType("selProdEstSaiLisTargetType",-1,1),setAutoCompleteToFiel("txtProdEstSaiLisDocumentNumber",23,1),setAutoCompleteToFiel("txtProdEstSaiLisSerialNumber",24),setAutoCompleteToFiel("txtProdEstSaiLisLoteNumber",25),hideNotification()})}function movimentListGet(e=-1,t=-1,n=-1,i=-1,o=-1,r=-1,s=-1,a=-1){var d=SYSTEM_USER_STATUS.companyId,c=Number(SYSTEM_USER_STATUS.billingprofile)>=BILLING_PROFILE_PARTNER_INDEX?-1:SYSTEM_USER_STATUS.workplaceId,l=document.getElementById("selProdEstSaiLisTargetType").value;-1!=e&&(e=document.getElementById("txtProdEstSaiLisDocumentNumber").value),-1!=t&&(t=document.getElementById("txtProdEstSaiLisEmissionDate").value),-1!=r&&(r=document.getElementById("txtProdEstSaiLisSerialNumber").value),-1!=s&&(s=document.getElementById("txtProdEstSaiLisLoteNumber").value),showNotification();var u=new XMLHttpRequest,m="action=getMovimentList&companyId="+d+"&dependencyId="+c+"&docType="+l+"&docNumber="+e+"&docDate="+t+"&customerId="+n+"&supplierId="+i+"&operatorId="+o+"&serialNumber="+r+"&loteNumber="+s+"&productId="+a,p=URL_SA_MOVIMENT_OF_GOODS_X;u.open("POST",p,!0),u.setRequestHeader("Content-type","application/x-www-form-urlencoded"),u.onreadystatechange=function(){if(4==u.readyState&&200==u.status){var e=JSON.parse(this.responseText);e.length<=0?showNotification("Não encontrado.",0):hideDivFilter();var t=e.length,n=document.getElementById("numResultPageNumber"),i=document.getElementById("numResultItems");function o(){var o=Number(n.value),r=Number(i.value),s=(o-1)*r,a=s+r;a>t&&(a=t),setElementInnerHtml("lbResultOnList",a+" / "+t);let d=document.getElementById("tblProdEstSaiLisMainTable");d.innerHTML="";for(var c=s,u=s;u<a;u++){var m=e[u];c+=1;let t=JSON.parse(m);const n=t.invoicenumber;let i=d.insertRow(-1);i.id="trProductMovimentList"+n,i.setAttribute("class","borderGray"+setSelectedRowBackground("SELECTED_ROW_MOVIMENT_LIST",i.id));let o=i.insertCell(-1);o.setAttribute("class","colRowNumber"),o.innerHTML=c,i.insertCell(-1).innerHTML=n;let r=i.insertCell(-1);var p=t.customerid;"GA"==(l=t.invoicetype)?(p=t.dependencyid,-1==t.dependencyid&&(p="")):"GD"==l&&(p=t.supplierid),p="CI"==l||"AE"==l||"GA"==l&&-1==t.dependencyid?"":" ("+p+")",r.innerHTML=t.customername+p,i.insertCell(-1).innerHTML=t.stockOut+" ("+t.stocksource+")",i.insertCell(-1).innerHTML=getFirtLastName(t.operatorName)+" ("+t.sourceid+")";let s=i.insertCell(-1);s.style.textAlign="center",s.innerHTML=setLocalDate(t.invoicedate,16);let a=i.insertCell(-1);a.style.textAlign="center",a.innerHTML=getDocumentStatus(t.invoicestatus),a.style.color="A"==t.invoicestatus?"red":"black";let S=i.insertCell(-1);S.setAttribute("class","noPrint");let E=document.createElement("button");E.type="button",E.setAttribute("class","labelDetail");const v=t.printnumber;E.onclick=function(){movimentViewDetail(v),setSelectedRowOnClick(i,"SELECTED_ROW_MOVIMENT_LIST")},S.appendChild(E),S.style.textAlign="center";let O=document.createElement("button");O.setAttribute("class","labelPrint"),O.type="button",O.onclick=function(){var e=document.getElementById("lbHearderCompanyName").innerHTML,n=t.customername,i=t.invoicenumber,o=DOCUMENT_TYPE[i.slice(0,2)]+" nº"+i,r=t.newEmail,s=t.phoneshipto;showPrintOptions(function(){movimentPrintReceipt(v)},function(){movimentPrintA4(v)},function(){var t=document.getElementById("txtPriPrevCustomerEmail").value;movimentSendByEmail(v,e,o,n,t)},function(){var e=document.getElementById("btPriPrevSendWhatsApp").value;movimentSendByWhatsApp(v,o,n,e)},r,s)},S.appendChild(O)}hideNotification()}n.value=1,setResultTotalPages(n.id,i.id,t),n.onchange=function(){o()},i.onchange=function(){setResultTotalPages(n.id,i.id,t),o()},o()}},u.send(m)}function movimentPendingOnLoad(e){showNotification(),checkUserStatusAfterExecute(function(){setAutoCompleteToFiel("txtProdStcMovPendDocumentNumber",26,1),movimentPendingList(),setSessionResultSearch("numProdStcMovPendResults"),hideNotification()})}function movimentPendingList(e=-1,t=-1,n=-1,i=-1){var o=SYSTEM_USER_STATUS.companyId,r=SYSTEM_USER_STATUS.workplaceId;-1!=e&&(e=document.getElementById("txtProdStcMovPendDocumentNumber").value),-1!=t&&(t=document.getElementById("txtProdStcMovPendEmissionDate").value),showNotification();var s=new XMLHttpRequest,a="action=getMovimentPending&companyId="+o+"&docNumber="+e+"&docDate="+t+"&customerId="+n+"&operatorId="+i+"&dependencyId="+r,d=URL_SA_MOVIMENT_OF_GOODS_X;s.open("POST",d,!0),s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.onreadystatechange=function(){if(4==s.readyState&&200==s.status){var e=JSON.parse(this.responseText);e.length<=0?showNotification("Não encontrado.",0):hideDivFilter();var t=e.length,n=document.getElementById("numResultPageNumber"),i=document.getElementById("numResultItems");function o(){var o=Number(n.value),r=Number(i.value),s=(o-1)*r,a=s+r;a>t&&(a=t),setElementInnerHtml("lbResultOnList",a+" / "+t);let d=document.getElementById("tblProdStcMovPendMainTable");d.innerHTML="";for(var c=s,l=s;l<a;l++){var u=e[l];c+=1;let t=JSON.parse(u);const n=t.invoicenumber;let i=d.insertRow(-1);i.id="trInvoicePending"+n,i.setAttribute("class","borderGray"+setSelectedRowBackground("SELECTED_ROW_INVOICE_PENDING",i.id));let o=i.insertCell(-1);o.setAttribute("class","colRowNumber"),o.innerHTML=c,i.insertCell(-1).innerHTML=n;let r=i.insertCell(-1);const s=t.customerid;r.innerHTML=t.customername+" ("+t.customerid+")",i.insertCell(-1).innerHTML=getFirtLastName(t.operatorName)+" ("+t.sourceid+")";let a=i.insertCell(-1);a.style.textAlign="center",a.innerHTML=t.invoicedate;let m=i.insertCell(-1);m.setAttribute("class","noPrint");let p=document.createElement("button");p.type="button",p.innerHTML="Emitir Guia",p.setAttribute("class","labelStock"),p.onclick=function(){sessionStorage.setItem("movimentPendingInvoiceNumber",n),sessionStorage.setItem("movimentPendingCustomerId",s),window.location.assign("ProductStockMoviment.php"),setSelectedRowOnClick(i,"SELECTED_ROW_INVOICE_PENDING")},checkPermission("0306")&&m.appendChild(p),m.style.textAlign="center"}hideNotification()}n.value=1,setResultTotalPages(n.id,i.id,t),n.onchange=function(){o()},i.onchange=function(){setResultTotalPages(n.id,i.id,t),o()},o(),setTimeout(function(){movimentPendingList()},3e5)}},s.send(a)}function movimentViewDetail(e){try{showNotification();const o=document.getElementById("btMovDetCancelMoviment");o.style.display="none",cleanElement("tblMovDetMainTable");var t=new XMLHttpRequest,n="action=movimentGetDetail&printNumber="+e,i=URL_SA_MOVIMENT_OF_GOODS_X;t.open("POST",i,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var n=JSON.parse(t.responseText);document.getElementById("lbMovDetDocumentNumber").innerHTML=n.invoicenumber,document.getElementById("lbMovDetEntryDate").innerHTML=n.invoicedate,document.getElementById("lbMovDetEntryUser").innerHTML=getFirtLastName(n.operatorName)+" ("+n.sourceid+")",document.getElementById("lbEntrDetInvoiceStatus").innerHTML=getDocumentStatus(n.invoicestatus),document.getElementById("lbMovDetInvoiceStatusDate").innerHTML=n.invoiceStatusDate,document.getElementById("lbMovDetInvoiceStatusReason").innerHTML=n.invoicestatusreason,document.getElementById("lbMovDetInvoiceStatusUser").innerHTML=getFirtLastName(n.operatorStatusName)+" ("+n.Sourceidstatus+")";var i="GD"==n.invoicetype?"supplierid":"customerid";i="GA"==n.invoicetype||"CI"==n.invoicetype||"AE"==n.invoicetype?"":" ("+n[i]+")",document.getElementById("lbMovDetMovimentTarget").innerHTML=MOVIMENT_TARGET_TYPE[n.movimenttargettype],document.getElementById("lbMovDetReceptor").innerHTML=n.customername+i,document.getElementById("lbMovDetDevolutionReason").innerHTML=n.movimentreason,document.getElementById("lbMovDetOrigemOn").innerHTML=n.originatingon,document.getElementById("lbMovDetStockSource").innerHTML=n.stocksource+" - "+n.productstock,movimentViewDetailLines(n.invoicenumber,n.invoicestatus),checkPermission("0307")&&"A"!=n.invoicestatus&&(o.style.display="inline"),document.getElementById("btMovDetPrint").onclick=function(){showPrintOptions(function(){movimentPrintReceipt(e)},function(){movimentPrintA4(e)},function(){},function(){},"","",!0)},document.getElementById("btMovDetRealCancel").onclick=function(){movimentCancelMoviment(n.invoicenumber)},showParts("divProdEstSaiMovimentDetails"),hideNotification()}},t.send(n)}catch(e){showNotification(e.message,0)}}function movimentViewDetailLines(e,t){showNotification();var n=new XMLHttpRequest,i="action=movimentGetDetailLines&invoiceNumber="+e+"&invoiceStatus="+t,o=URL_SA_MOVIMENT_OF_GOODS_X;n.open("POST",o,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(n.responseText);let i=document.getElementById("tblMovDetMainTable");i.innerHTML="";var t=0;e.forEach(e=>(function(e){t+=1;let n=JSON.parse(e),o=i.insertRow(-1);o.setAttribute("class","borderGray");let r=o.insertCell(-1);r.setAttribute("class","colRowNumber"),r.innerHTML=t,o.insertCell(-1).innerHTML=n.productId,o.insertCell(-1).innerHTML=n.productDescription,o.insertCell(-1).innerHTML=n.unitOfMeasure,o.insertCell(-1).innerHTML=n.serialnumber,o.insertCell(-1).innerHTML=n.lotenumber,o.insertCell(-1).innerHTML=formatNumber(n.quantity)})(e))}},n.send(i)}function movimentCancelMoviment(e,t="",n=!1){if(!n){t=reviewString(document.getElementById("txtMoviDetCancelMovimentReason")).toUpperCase();var i=document.getElementById("lbMovDetOrigemOn").innerHTML;if(""==t)return alert("Deve indicar o motivo da anulação."),!1}function o(){showNotification();var o=SYSTEM_USER_STATUS.userId,r=new XMLHttpRequest,s="action=movimentCancelEntrance&invoiceNumber="+e+"&originationOn="+i+"&reason="+t+"&userId="+o+"&fromOriginationOn="+n,a=URL_SA_MOVIMENT_OF_GOODS_X;r.open("POST",a,!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(r.responseText);1==e.status?(showNotification(e.msg,1),document.getElementById("txtMoviDetCancelMovimentReason").value="",hideParts("divMocDetCancelMoviment"),hideParts("divProdEstSaiMovimentDetails")):showNotification("Não foi possível cancelar")}},r.send(s)}n?o():showConfirm("Tem a certeza que deseja anular esta guia?",o)}