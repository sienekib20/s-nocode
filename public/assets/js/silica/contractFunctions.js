class _contract{constructor(t=5e3,e=-1,n="CN",i=1,o="NOVO*",a="",r="",l="",s="",c=1,u="",d="2021-07-01",m=1,C=1,g=1,p="2000-01-01",S=18,R=-1,h="",T="",E="",L="",b="",y="",I=0,f=1){this.companyid=t,this.dependencyid=e,this.serie=n,this.sequencenumber=i,this.contractid=o,this.oldcontractnumber=a,this.customerid=r,this.companyname=l,this.cilserie=s,this.cilsequencenumber=c,this.cil=u,this.contractdate=d,this.consumertype=m,this.contractstatus=C,this.contractsituation=g,this.lastinvoicedate=p,this.billingprovince=S,this.billingmunicipality=R,this.billingcomuna=h,this.billingneiborhood=T,this.billingstreetname=E,this.billingblock=L,this.billingbuildingnumber=b,this.billingpostalcode=y,this.statususer=I,this.status=f}}function contractRegisterOnLoad(){checkUserStatusAfterExecute(function(){fillSelectConsumerTypeAqua("selContrRegWaterTax"),fillSelectLinkRequestStatus("selContrRegContractStatus"),fillSelectCustomerType("selContrRegCustomerType"),fillSelectProvince("selContrRegProvince",1,SYSTEM_USER_STATUS.provinceId),fillSelectMunicipality("selContrRegMunicipality",SYSTEM_USER_STATUS.provinceId,-1),fillSelectZoneBlock("selContrRegBlock",-1),maskInputByPlaceHold("txtContrRegPostalCode")})}function contractListOnLoad(){try{showNotification(),checkUserStatusAfterExecute(function(){setLinkRequestStatus(),fillSelectDependencyFull("selContrLisDependency",-1,1),fillSelectConsumerTypeAqua("selContrLisWaterTax",-1),fillSelectLinkRequestStatus("selContrLisContracStatus",-1),fillSelectMunicipality("selContrLisMunicipality",SYSTEM_USER_STATUS.provinceId,-1,-1),fillSelectNeiborhood("selContrLisNeiborhood",3,-1),setTriggerButtonByText("txtContrLisInitialDate","btContrLisViewAll"),setTriggerButtonByText("txtContrLisEndDate","btContrLisViewAll"),document.getElementById("chbContrLisShowDate").onclick=function(){setEnableDisableByCheckBox(this.id,"txtContrLisInitialDate","txtContrLisEndDate")},checkPermission("3101")?showParts("btContrLisNewContract",!0):hideParts("btContrLisNewContract");var t=sessionStorage.getItem("customer_to_contract");if(null!=t&&""!=t){var e=document.getElementById("btContrLisPending");showParts(e.id,!0),e.onclick=function(){contractNewContract(JSON.parse(t)),hideParts(e.id)},sessionStorage.setItem("customer_to_contract","")}contractListDetails(),hideNotification()})}catch(t){showNotification(t.message,0)}}function contractNewContract(t){showParts("divContrDetail"),contractGetContractDetails(-1,t)}function contractGetContractDetails(t,e=null){const n=document.getElementById("lbContrRegHeader"),i=document.getElementById("txtContrRegSerie"),o=document.getElementById("txtContrRegContractId"),a=document.getElementById("txtContrRegOldContractNumber"),r=document.getElementById("txtContrRegContractDate"),l=document.getElementById("selContrRegWaterTax"),s=document.getElementById("selContrRegContractStatus"),c=document.getElementById("selContrRegContractSituation"),u=document.getElementById("txtContrRegCIL"),d=document.getElementById("txtContrRegCustomerID"),m=document.getElementById("selContrRegCustomerType"),C=document.getElementById("txtContrRegCompanyName"),g=document.getElementById("txtContrRegCompanyTaxId"),p=document.getElementById("selContrRegMunicipality"),S=document.getElementById("txtContrRegComuna"),R=document.getElementById("txtContrRegStreet"),h=document.getElementById("selContrRegBlock"),T=document.getElementById("txtContrRegBuidNumber"),E=document.getElementById("txtContrRegPostalCode"),L=document.getElementById("lbContrRegUpdateBy");if(showParts("btContrDetSave",!0),hideParts("btContrDetCancel"),hideParts("btContrApprove"),-1==t){var b=new Date;n.innerHTML="NOVO Contrato DE LIGAÇÃO",i.value="CN",o.value="NOVO*",a.value="",r.value=setLocalDate(b,10),l.value=e.consumertype,s.value=1,c.value=1,u.value="",d.value=e.customerid,m.value=e.customertype,C.value=e.companyname,g.value=e.customertaxid,p.value=e.billingmunicipality,S.value=e.billingcomuna,fillSelectNeiborhood("selContrRegNeiborhood",3,-1,e.billingneiborhood),R.value=e.billingstreetname,h.value=e.billingblock,T.value=e.billingbuildingnumber,E.value=e.billingpostalcode,L.innerHTML="Data de actualizaçao: "+setLocalDate(b,16),contractNeiborhoodOnChange()}else{n.innerHTML="DETALHES DO Contrato DE LIGAÇÃO";var y=new XMLHttpRequest,I="action=getContractDetails&contractId="+t,f=URL_SA_CONTRACT_X;y.open("POST",f,!0),y.setRequestHeader("Content-type","application/x-www-form-urlencoded"),y.onreadystatechange=function(){if(4==y.readyState&&200==y.status){var t=JSON.parse(this.responseText);i.value=t.serie,o.value=t.contractid,a.value=t.oldcontractnumber,r.value=setLocalDate(t.contractdate,10),l.value=t.consumertype,s.value=t.contractstatus,c.value=t.contractsituation,u.value=t.cil,d.value=t.customerid,m.value=t.customertype,C.value=t.companyname,g.value=t.customertaxid,p.value=t.billingmunicipality,S.value=t.billingcomuna,fillSelectNeiborhood("selContrRegNeiborhood",3,-1,t.billingneiborhood),R.value=t.billingstreetname,h.value=t.billingblock,T.value=t.billingbuildingnumber,E.value=t.billingpostalcode,L.innerHTML="Cadastrado por "+getOperatorName(t.operatorEntry,t.entryuser)+" em "+setLocalDate(t.entrydate,16)+". <br>Actualizado por "+getOperatorName(t.operatorName,t.statususer)+" em "+setLocalDate(t.statusdate,16);var e=t.contractstatus;3==e&&hideParts("btContrDetSave"),checkPermission("3102")&&3!=e&&showParts("btContrDetCancel",!0),checkPermission("3103")&&1==e&&showParts("btContrApprove",!0)}},y.send(I)}setAutoCompleteToFiel("txtContrRegComuna",54,1),setAutoCompleteToFiel("txtContrRegStreet",56,1),setAutoCompleteToFiel("txtContrRegBuidNumber",58,1),setAutoCompleteToFiel("txtContrRegPostalCode",59,1),dispatchOnInputChange()}function contractNeiborhoodOnChange(){var t="",e=getElementValue("selContrRegNeiborhood");if(e in NEIBORHOOD_CIL_SERIE){t=NEIBORHOOD_CIL_SERIE[e]+"-";var n=getElementValue("selContrRegBlock").split(" ");n.length>1&&(t+="Z"+Number(n[1])+"-")}setElementValue("txtContrRegSerieCil",t)}function contractRegisterSave(t,e=1){var n=!1,i="",o=new _contract;if(contractNeiborhoodOnChange(),o.companyid=SYSTEM_USER_STATUS.companyId,o.dependencyid=SYSTEM_USER_STATUS.workplaceId,o.serie=reviewString(document.getElementById("txtContrRegSerie")).toUpperCase(),o.contractid=document.getElementById("txtContrRegContractId").value,o.oldcontractnumber=document.getElementById("txtContrRegOldContractNumber").value,o.customerid=reviewString(document.getElementById("txtContrRegCustomerID")).toUpperCase(),o.cilserie=reviewString(document.getElementById("txtContrRegSerieCil")).toUpperCase(),o.contractdate=document.getElementById("txtContrRegContractDate").value,o.consumertype=document.getElementById("selContrRegWaterTax").value,o.contractstatus=document.getElementById("selContrRegContractStatus").value,o.contractsituation=getElementValue("selContrRegContractSituation"),o.billingprovince=document.getElementById("selContrRegProvince").value,o.billingmunicipality=document.getElementById("selContrRegMunicipality").value,o.billingcomuna=reviewString(document.getElementById("txtContrRegComuna")).toUpperCase(),o.billingneiborhood=getElementValue("selContrRegNeiborhood"),o.billingstreetname=reviewString(document.getElementById("txtContrRegStreet")).toUpperCase(),o.billingblock=reviewString(document.getElementById("selContrRegBlock")).toUpperCase(),o.billingbuildingnumber=reviewString(document.getElementById("txtContrRegBuidNumber")).toUpperCase(),o.billingpostalcode=reviewString(document.getElementById("txtContrRegPostalCode")).replace(/[^0-9\-]/g,""),o.nextStatus=e,2==o.contractstatus&&(o.cil=getElementValue("txtContrRegCIL").toUpperCase()),o.statususer=SYSTEM_USER_STATUS.userId,o.producttag=1==o.contractsituation?"300572":"300583",o.invoiceSerie=invoiceDucumentSerie("FT"),o.taxGroup=SYSTEM_USER_STATUS.taxGroup,o.shelflife=5,validateDate(new Date(o.contractdate))||(n=!0,i+="Data do Contrato fora do formato. <br>"),""==o.customerid&&(n=!0,i+="Deve indicar o cliente. <br>"),o.billingmunicipality<=0&&(n=!0,i+="Deve indicar o município. <br>"),""==o.billingneiborhood&&(n=!0,i+="Deve indicar o bairro. <br>"),1==ST_SA_WAITING_SERVER&&(n=!0,i+="Aguardando resposta do servidor. <br>"),n)return alert(i),!1;showNotification(),ST_SA_WAITING_SERVER=1;var a=new XMLHttpRequest,r="action=saveContractRegister&contractInfo="+JSON.stringify(o),l=URL_SA_CONTRACT_X;a.open("POST",l,!0),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.onreadystatechange=function(){if(4==this.readyState&&200==this.status){ST_SA_WAITING_SERVER=0;var e=JSON.parse(a.responseText);1==e.status?(showNotification(e.msg,1),"CONTRLIS"==t&&contractListDetails(o.customerid),hideParts("divContrDetail")):showNotification(e.msg,0)}},a.send(r)}function contractListDetails(t=-1,e=-1){if(1==ST_SA_LISTING_SERVER)return showNotification("Procurando...",1),!1;var n={};if(n.companyId=SYSTEM_USER_STATUS.companyId,n.dependencyId=getElementValue("selContrLisDependency"),n.dependencyId<=0&&Number(SYSTEM_USER_STATUS.billingprofile)<BILLING_PROFILE_PARTNER_INDEX)return showNotification("Seleccionar uma filial.",0),!1;n.filterByDate=getElementChecked("chbContrLisShowDate"),n.initialDate=getElementValue("txtContrLisInitialDate"),n.endDate=getElementValue("txtContrLisEndDate"),n.consumertype=getElementValue("selContrLisWaterTax"),n.contractStatus=getElementValue("selContrLisContracStatus"),n.municipalityId=getElementValue("selContrLisMunicipality"),n.neiborhood=getElementValue("selContrLisNeiborhood"),n.customerid=t,n.userId=e,n.onlynumber=1,n.startIdx=0,n.endIdx=0,showNotification(),ST_SA_LISTING_SERVER=1;var i=new XMLHttpRequest,o="action=getContractListDetails&filterInfo="+JSON.stringify(n),a=URL_SA_CONTRACT_X;i.open("POST",a,!0),i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.onreadystatechange=function(){if(4==i.readyState&&200==i.status){ST_SA_LISTING_SERVER=0;var t=JSON.parse(this.responseText),e=Number(t.n);e<=0?showNotification("Não encontrado.",0):hideDivFilter();var o=document.getElementById("numResultPageNumber"),a=document.getElementById("numResultItems");function r(){var t=Number(o.value),i=Number(a.value),r=(t-1)*i,l=r+i;l>e&&(l=e),n.totalItems=e,n.startIdx=r,n.endIdx=l,n.onlynumber=0,contractListFilter(n)}o.value=1,setResultTotalPages(o.id,a.id,e),o.onchange=function(){r()},a.onchange=function(){setResultTotalPages(o.id,a.id,e),r()},setElementInnerHtml("lbResultOnList",e),r()}},i.send(o)}function contractListFilter(t){try{showNotification();var e=document.getElementById("tblContrLisListTable");e.innerHTML="";var n=new XMLHttpRequest,i="action=getContractListDetails&filterInfo="+JSON.stringify(t),o=URL_SA_CONTRACT_X;n.open("POST",o,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==n.readyState&&200==n.status){ST_SA_LISTING_SERVER=0;var i=JSON.parse(this.responseText),o={},a={},r={};setElementInnerHtml("lbResultOnList",t.endIdx+" / "+t.totalItems);for(var l=t.startIdx,s=0;s<i.length;s++){var c=i[s];let t=JSON.parse(c);var u=CONSUMER_TYPE_AQUA[Number(t.consumertype)],d=LINK_REQUEST_STATUS[Number(t.contractstatus)],m=t.billingneiborhood,C=getOperatorName(t.operatorName,t.statususer);addAmountResume(o,u,1),addAmountResume(a,d,1),addAmountResume(r,m,1),l+=1;let n=e.insertRow(-1);n.id="trContrList"+t.contractid,n.setAttribute("class","borderGray"+setSelectedRowBackground("SELECTED_ROW_CONTRACT_LIST",n.id));let R=n.insertCell(-1);R.setAttribute("class","colRowNumber"),R.innerHTML=l;let h=n.insertCell(-1);h.setAttribute("class","colProductId"),h.innerHTML=t.contractid;let T=n.insertCell(-1);T.setAttribute("class","colProductId"),T.innerHTML=t.cil;let E=n.insertCell(-1);E.setAttribute("class","colProductId"),E.innerHTML=t.hydrometerid;let L=n.insertCell(-1);L.setAttribute("class","colProductId"),L.innerHTML=setLocalDate(t.contractdate,10),n.insertCell(-1).innerHTML=u,n.insertCell(-1).innerHTML=t.companyname+" ["+t.customerid+"]",n.insertCell(-1).innerHTML=t.billingMunicipality,n.insertCell(-1).innerHTML=m,n.insertCell(-1).innerHTML=t.telephone1+" / "+t.telephone2+" / "+t.telephone3;var g="black",p="c ",S=t.contractstatus;2==S?p="textUpperUcase textBold":3==S&&(g="red");let b=n.insertCell(-1);b.setAttribute("class",p),b.innerHTML=d,b.style.color=g;let y=n.insertCell(-1);y.setAttribute("class","colProductId"),y.innerHTML=setLocalDate(t.statusdate,16);let I=n.insertCell(-1);I.setAttribute("class","colProductId"),I.innerHTML=C;let f=n.insertCell(-1);f.setAttribute("class","noPrint");let N=document.createElement("button");N.type="button",N.setAttribute("class","labelDetail");const _=t.contractid;if(N.onclick=function(){contractEditContract(_),setSelectedRowOnClick(n,"SELECTED_ROW_CONTRACT_LIST")},f.appendChild(N),3!=S){let e=document.createElement("button");if(e.type="button",e.innerHTML="Contador",e.onclick=function(){setSelectedRowOnClick(n,"SELECTED_ROW_CONTRACT_LIST"),sessionStorage.setItem("contract_to_hydrometer",JSON.stringify(t)),window.location.assign("HydrometerList.php")},f.appendChild(e),checkPermission("0205")){let e=document.createElement("button");e.type="button",e.innerHTML="Recibo",e.setAttribute("class","labelPayment"),e.onclick=function(){setSelectedRowOnClick(n,"SELECTED_ROW_CONTRACT_LIST"),t.companyid=SYSTEM_USER_STATUS.companyId,t.newCustomerName=t.companyname,t.newTaxId=t.customertaxid,t.transactiondate=setLocalDate(new Date,10),t.invoicenumber="FT 0000/00",sessionStorage.setItem("invoiceInvoiceInvoiceNumber",JSON.stringify(t)),window.location.assign("SalePayment.php")},f.appendChild(e)}}let v=document.createElement("button");v.setAttribute("class","labelPrint"),v.type="button",v.onclick=function(){setSelectedRowOnClick(n,"SELECTED_ROW_CONTRACT_LIST"),document.getElementById("btContrLisPrintByVia").onclick=function(){t.obs=getElementValue("selContrLisContractPrintVia"),sessionStorage.setItem("contract_to_print",JSON.stringify(t)),window.open("printContractLayoutA4.php"),hideParts("divContractPrintVia")},showParts("divContractPrintVia")},f.appendChild(v)}var R=document.getElementById("tblContrLisResumeTable");for(var c in R.innerHTML="",l=0,o)l+=1,resume(R,l,"Tipo de consumidor",o,c,"Contratos");for(var c in l=0,a)l+=1,resume(R,l,"Estado do contrato",a,c,"Contratos");for(var c in l=0,r)l+=1,resume(R,l,"Bairro",r,c,"Contratos");hideNotification()}},n.send(i)}catch(t){showNotification(t.message,0)}}function contractEditContract(t){showParts("divContrDetail"),contractGetContractDetails(t)}function contractCancelContract(){showConfirm("Tem a certeza que deseja anular este Contrato de ligação?",function(){showNotification();var t=getElementValue("txtContrRegContractId"),e=SYSTEM_USER_STATUS.userId,n=new XMLHttpRequest,i="action=changeStatusContract&contractId="+t+"&status=3&userId="+e,o=URL_SA_CONTRACT_X;n.open("POST",o,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var t=JSON.parse(n.responseText);1==t.status?(showNotification(t.msg,1),contractListDetails(),hideParts("divContrDetail")):showNotification(t.msg,0)}},n.send(i)})}function contractApproveContract(){showConfirm("Tem a certeza que deseja APROVAR este Contrato de ligação?",function(){showNotification();var t=getElementValue("txtContrRegContractId"),e=SYSTEM_USER_STATUS.userId,n=new XMLHttpRequest,i="action=changeStatusContract&contractId="+t+"&status=2&userId="+e,o=URL_SA_CONTRACT_X;n.open("POST",o,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var t=JSON.parse(n.responseText);1==t.status?(showNotification(t.msg,1),contractListDetails(),hideParts("divContrDetail")):showNotification(t.msg,0)}},n.send(i)})}function contractWaterLinkOnLoad(){try{showNotification(),checkUserStatusAfterExecute(function(){setWaterLinkStatus(),fillSelectDependencyFull("selWtLinkDependency",-1,1),fillSelectConsumerTypeAqua("selWtLinkWaterTax",-1),fillSelectWaterLinkStatus("selWtLinkWaterLinkStatus",-1),fillSelectMunicipality("selWtLinkMunicipality",SYSTEM_USER_STATUS.provinceId,-1,-1),fillSelectNeiborhood("selWtLinkNeiborhood",3,-1),contractWaterLinkList(),hideNotification()})}catch(t){showNotification(t.message,0)}}function contractWaterLinkList(t=-1,e=-1){try{var n={};if(n.companyId=SYSTEM_USER_STATUS.companyId,n.dependencyId=getElementValue("selWtLinkDependency"),n.dependencyId<=0&&Number(SYSTEM_USER_STATUS.billingprofile)<BILLING_PROFILE_PARTNER_INDEX)return showNotification("Seleccionar uma filial.",0),!1;n.consumertype=getElementValue("selWtLinkWaterTax"),n.waterLinkStatus=getElementValue("selWtLinkWaterLinkStatus"),n.municipalityId=getElementValue("selWtLinkMunicipality"),n.neiborhood=getElementValue("selWtLinkNeiborhood"),n.customerid=t,n.userId=e,showNotification();var i=new XMLHttpRequest,o="action=getContractWaterLinkList&filterInfo="+JSON.stringify(n),a=URL_SA_CONTRACT_X;i.open("POST",a,!0),i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.onreadystatechange=function(){if(4==i.readyState&&200==i.status){var t=JSON.parse(this.responseText);t.length<=0?showNotification("Não encontrado.",0):hideDivFilter();var e=t.length,n=document.getElementById("numResultPageNumber"),o=document.getElementById("numResultItems");function a(){var i=Number(n.value),a=Number(o.value),r=(i-1)*a,l=r+a;l>e&&(l=e);var s={},c={},u={};setElementInnerHtml("lbResultOnList",l+" / "+e);let d=document.getElementById("tblWtLinkListTable");d.innerHTML="";for(var m=r,C=r;C<l;C++){var g=t[C];let e=JSON.parse(g);var p=CONSUMER_TYPE_AQUA[Number(e.consumertype)],S=WATER_LINK_STATUS[Number(e.waterlinkstatus)],R=e.billingneiborhood,h=getOperatorName(e.operatorName,e.waterlinkstatususer);addAmountResume(s,p,1),addAmountResume(c,S,1),addAmountResume(u,R,1),m+=1;let n=d.insertRow(-1);n.id="trWtLinkList"+e.contractid,n.setAttribute("class","borderGray"+setSelectedRowBackground("SELECTED_ROW_WATER_LINK",n.id));let i=n.insertCell(-1);i.setAttribute("class","colRowNumber"),i.innerHTML=m;let o=n.insertCell(-1);o.setAttribute("class","colProductId"),o.innerHTML=e.contractid;let a=n.insertCell(-1);a.setAttribute("class","colProductId"),a.innerHTML=e.cil;let r=n.insertCell(-1);r.setAttribute("class","colProductId"),r.innerHTML=e.hydrometerid,n.insertCell(-1).innerHTML=p,n.insertCell(-1).innerHTML=e.companyname+" ["+e.customerid+"]",n.insertCell(-1).innerHTML=e.billingMunicipality,n.insertCell(-1).innerHTML=R;var T="black",E="c ",L=e.waterlinkstatus;1==L?E="textUpperUcase textBold":3==L&&(T="red");let l=n.insertCell(-1);l.setAttribute("class",E),l.innerHTML=S,l.style.color=T;let b=n.insertCell(-1);b.setAttribute("class","colProductId"),b.innerHTML=e.waterlinkstatusreason;let y=n.insertCell(-1);y.setAttribute("class","colProductId"),y.innerHTML=setLocalDate(e.waterlinkstatusdate,16);let I=n.insertCell(-1);I.setAttribute("class","colProductId"),I.innerHTML=h;let f=n.insertCell(-1);if(f.setAttribute("class","noPrint"),0==L){if(checkPermission("3230")){let t=document.createElement("button");t.type="button",t.setAttribute("class","labelBrokenLink"),t.innerHTML="Activar ligação";e.contractid;t.onclick=function(){contractWaterLinkEdit(e,1),setSelectedRowOnClick(n,"SELECTED_ROW_WATER_LINK")},f.appendChild(t)}}else if(1==L){if(checkPermission("3230")){let t=document.createElement("button");t.type="button",t.setAttribute("class","labelBrokenLink"),t.innerHTML="Supender ligação";e.contractid;t.onclick=function(){contractWaterLinkEdit(e,3),setSelectedRowOnClick(n,"SELECTED_ROW_WATER_LINK")},f.appendChild(t)}}else if(3==L&&checkPermission("3231")){let t=document.createElement("button");t.type="button",t.setAttribute("class","labelLink"),t.innerHTML="Reactivar ligação";e.contractid;t.onclick=function(){contractWaterLinkEdit(e,1),setSelectedRowOnClick(n,"SELECTED_ROW_WATER_LINK")},f.appendChild(t)}}var b=document.getElementById("tblWtLinkResumeTable");for(var g in b.innerHTML="",m=0,s)m+=1,resume(b,m,"Tipo de consumidor",s,g,"Ligações");for(var g in m=0,c)m+=1,resume(b,m,"Estado da ligação",c,g,"Ligações");for(var g in m=0,u)m+=1,resume(b,m,"Bairro",u,g,"Ligações");hideNotification()}n.value=1,setResultTotalPages(n.id,o.id,e),n.onchange=function(){a()},o.onchange=function(){setResultTotalPages(n.id,o.id,e),a()},a()}},i.send(o)}catch(t){showNotification(t.message,0)}}function contractWaterLinkEdit(t,e){showParts("divWaterLinkStatus");var n=document.getElementById("lbWtLinkSttHeader"),i=document.getElementById("btWtLinkSttChangeStatus");1==e?(n.innerHTML="Activar ligação de água",i.innerHTML="Confirmar Activação",setElementValue("txtWtLinkSttReason",""),hideParts("divWtLinkSttReason")):3==e&&(n.innerHTML="Suspender ligação de água",i.innerHTML="Confirmar Supensão da ligação",showParts("divWtLinkSttReason")),setElementValue("txtWtLinkSttNextStatus",e),setElementValue("txtWtLinkSttContractId",t.contractid),setElementValue("txtWtLinkSttCIL",t.cil),setElementValue("txtWtLinkSttCompanyName",t.companyname)}function contractWaterLinkChangeStatus(){var t=getElementValue("txtWtLinkSttContractId"),e=getElementValue("txtWtLinkSttNextStatus"),n=reviewString(document.getElementById("txtWtLinkSttReason")),i=SYSTEM_USER_STATUS.userId,o="ACTIVAR";if(3==e){if(""==n)return alert("Deve indicar o motivo da suspenção da ligação."),!1;o="SUSPENDER"}if(1==ST_SA_WAITING_SERVER)return alert("Aguardando resposta do servidor. <br>"),!1;showConfirm("Tem a certeza que deseja "+o+" esta ligação?",function(){showNotification(),ST_SA_WAITING_SERVER=1;var o=new XMLHttpRequest,a="action=changeWaterLinkStatus&contractId="+t+"&status="+e+"&reason="+n+"&userId="+i,r=URL_SA_CONTRACT_X;o.open("POST",r,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){if(4==this.readyState&&200==this.status){ST_SA_WAITING_SERVER=0;var t=JSON.parse(o.responseText);1==t.status?(showNotification(t.msg,1),contractWaterLinkList(),hideParts("divWaterLinkStatus")):showNotification(t.msg,0)}},o.send(a)})}var CONTRACT_REGISTER_LINES=[];function contractRegisterLoteOnLoad(t){showNotification(),checkUserStatusAfterExecute(function(){CONTRACT_REGISTER_LINES=[],contractRegisterLoteGetAddressOnChange(),"GME"==t?showParts("divContRegLoteNUS"):hideParts("divContRegLoteNUS"),hideNotification()})}function contractRegisterLoteAddContract(t=0){showNotification();let e=document.getElementById("tblContRegLoteMainTable");var n=Number(e.rows.length)+1,i=new _contract;0!=t?i=t:(i.billingmunicipality=SYSTEM_USER_STATUS.municipalityId,i.contractid=i.serie+i.sequencenumber,i.contractdate="2021-01-01",i.consumertype=1,i.contractstatus=2),i.status=1,i.billingprovince=SYSTEM_USER_STATUS.provinceId,CONTRACT_REGISTER_LINES[Number(n-1)]=i;let o=e.insertRow(-1);o.setAttribute("class","borderGray"),o.setAttribute("id","rowContRegLote"+n);let a=o.insertCell(-1);a.setAttribute("class","colRowNumber"),a.innerHTML=n;let r=o.insertCell(-1);r.style.width="50px";let l=document.createElement("input");l.setAttribute("class","textUpperUcase"),l.id="txtContRegLoteSerie"+n,l.type="text",l.maxlength="95",l.value=i.serie,l.onchange=function(){contractRegisterLoteOnChange(n,this,"serie"),i.contractid=i.serie+i.sequencenumber,setElementValue("txtContRegLoteContractId"+n,i.contractid)},r.appendChild(l);let s=o.insertCell(-1);s.style.width="80px";let c=document.createElement("input");c.setAttribute("class","textUpperUcase"),c.id="txtContRegLoteSequence"+n,c.type="number",c.min=1,c.value=i.sequencenumber,c.onchange=function(){contractRegisterLoteOnChange(n,this,"sequencenumber"),i.contractid=i.serie+i.sequencenumber,setElementValue("txtContRegLoteContractId"+n,i.contractid)},s.appendChild(c);let u=o.insertCell(-1);u.style.width="100px";let d=document.createElement("input");d.setAttribute("class","textUpperUcase"),d.id="txtContRegLoteContractId"+n,d.type="text",d.maxlength="95",d.value=i.contractid,d.disabled="true",d.onchange=function(){contractRegisterLoteOnChange(n,this,"contractid")},u.appendChild(d);let m=o.insertCell(-1);m.style.width="100px";let C=document.createElement("input");C.setAttribute("class","textUpperUcase"),C.id="txtContRegLoteOldContract"+n,C.type="text",C.maxlength="95",C.value=i.oldcontractnumber,C.onchange=function(){contractRegisterLoteOnChange(n,this,"oldcontractnumber")},m.appendChild(C);let g=o.insertCell(-1);g.style.width="70px";let p=document.createElement("input");p.setAttribute("class","textUpperUcase"),p.id="txtContRegLoteContractDate"+n,p.type="date",p.value=setLocalDate(i.contractdate,10),p.onchange=function(){contractRegisterLoteOnChange(n,this,"contractdate")},g.appendChild(p);let S=o.insertCell(-1);S.style.width="100px";let R=document.createElement("select");R.id="selContRegLoteConsumerType"+n,R.onchange=function(){contractRegisterLoteOnChange(n,this,"consumertype",!0)},S.appendChild(R),fillSelectConsumerTypeAqua(R.id,1,i.consumertype);let h=o.insertCell(-1);h.style.width="100px";let T=document.createElement("select");T.id="selContRegLoteContractStatus"+n,T.onchange=function(){contractRegisterLoteOnChange(n,this,"contractstatus",!0)},h.appendChild(T),fillSelectLinkRequestStatus(T.id,1,i.contractstatus);let E=o.insertCell(-1);E.style.width="50px";let L=document.createElement("input");L.setAttribute("class","textUpperUcase"),L.id="txtContRegLoteCilSerie"+n,L.type="text",L.maxlength="95",L.value=i.cilserie,L.onchange=function(){contractRegisterLoteOnChange(n,this,"cilserie"),i.cil=i.cilserie+i.cilsequencenumber,setElementValue("txtContRegLoteCIL"+n,i.cil)},E.appendChild(L);let b=o.insertCell(-1);b.style.width="80px";let y=document.createElement("input");y.setAttribute("class","textUpperUcase"),y.id="txtContRegLoteCilSequence"+n,y.type="number",y.min=1,y.value=i.cilsequencenumber,y.onchange=function(){contractRegisterLoteOnChange(n,this,"cilsequencenumber"),i.cil=i.cilserie+i.cilsequencenumber,setElementValue("txtContRegLoteCIL"+n,i.cil)},b.appendChild(y);let I=o.insertCell(-1);I.style.width="100px";let f=document.createElement("input");f.setAttribute("class","textUpperUcase"),f.id="txtContRegLoteCIL"+n,f.type="text",f.maxlength="95",f.value=i.cil,f.disabled="true",f.onchange=function(){contractRegisterLoteOnChange(n,this,"cil")},I.appendChild(f);let N=o.insertCell(-1);N.style.width="70px";let _=document.createElement("input");_.setAttribute("class","textUpperUcase"),_.id="txtContRegLoteContractDate"+n,_.type="date",_.value=setLocalDate(i.lastinvoicedate,10),_.onchange=function(){contractRegisterLoteOnChange(n,this,"contractdate")},N.appendChild(_);let v=o.insertCell(-1);v.style.width="100px";let A=document.createElement("input");A.setAttribute("class","textUpperUcase"),A.id="txtContRegLoteCustomerId"+n,A.type="text",A.maxlength="95",A.value=i.customerid,A.onchange=function(){contractRegisterLoteOnChange(n,this,"customerid")},v.appendChild(A);let x=o.insertCell(-1);x.style.width="150px";let w=document.createElement("input");w.setAttribute("class","textUpperUcase"),w.id="txtContRegLoteCompanyName"+n,w.type="text",w.maxlength="95",w.value=i.companyname,w.onchange=function(){contractRegisterLoteOnChange(n,this,"companyname")},x.appendChild(w);let O=o.insertCell(-1);O.setAttribute("class","depending-of-customer"),O.style.width="100px";let U=document.createElement("select");U.id="selContRegLoteMunicipality"+n,U.onchange=function(){contractRegisterLoteOnChange(n,this,"billingmunicipality",!0)},O.appendChild(U),fillSelectMunicipality(U.id,SYSTEM_USER_STATUS.provinceId,-1,i.billingmunicipality);let M=o.insertCell(-1);M.setAttribute("class","depending-of-customer"),M.style.width="80px";let D=document.createElement("input");D.setAttribute("class","textUpperUcase"),D.id="txtContRegLoteComuna"+n,D.type="text",D.maxlength="95",D.value=i.billingcomuna,D.onchange=function(){contractRegisterLoteOnChange(n,this,"billingcomuna")},M.appendChild(D);let H=o.insertCell(-1);H.setAttribute("class","depending-of-customer"),H.style.width="150px";let k=document.createElement("select");k.id="selContRegLoteNeiborhood"+n,k.onchange=function(){contractRegisterLoteOnChange(n,this,"billingneiborhood",!0)},H.appendChild(k),fillSelectNeiborhood(k.id,2,-1,i.billingneiborhood);let B=o.insertCell(-1);B.setAttribute("class","depending-of-customer"),B.style.width="80px";let W=document.createElement("input");W.setAttribute("class","textUpperUcase"),W.id="txtContRegLoteStreetName"+n,W.type="text",W.maxlength="95",W.value=i.billingstreetname,W.onchange=function(){contractRegisterLoteOnChange(n,this,"billingstreetname")},B.appendChild(W);let P=o.insertCell(-1);P.setAttribute("class","depending-of-customer"),P.style.width="80px";let V=document.createElement("select");V.id="selContRegLoteBlock"+n,V.onchange=function(){contractRegisterLoteOnChange(n,this,"billingneiborhood",!0)},P.appendChild(V),fillSelectZoneBlock(V.id,-1,i.billingblock);let q=o.insertCell(-1);q.setAttribute("class","depending-of-customer"),q.style.width="50px";let G=document.createElement("input");G.setAttribute("class","textUpperUcase"),G.id="txtContRegLoteBuildNumber"+n,G.type="text",G.maxlength="95",G.value=i.billingbuildingnumber,G.onchange=function(){contractRegisterLoteOnChange(n,this,"billingbuildingnumber")},q.appendChild(G);let Y=o.insertCell(-1);var J=document.createElement("button");J.setAttribute("class","labelRemove"),J.type="button",J.onclick=function(){CONTRACT_REGISTER_LINES[Number(n-1)].status=0,o.innerHTML=""},Y.appendChild(J),Y.style.textAlign="center",Y.style.width="10px",hideNotification()}function contractRegisterLoteOnChange(t,e,n,i=!1){var o=e.value;i||(o=reviewString(e).toString().toUpperCase(),e.value=o),CONTRACT_REGISTER_LINES[Number(t)-1][n]=o}function contractRegisterLoteGetAddressOnChange(){var t=1==getElementValue("rngContRegLoteGetAddressFromCustomer")?"none":"table-cell";document.querySelector(":root").style.setProperty("--forceHide",t)}function contractRegisterLoteCleanTable(){CONTRACT_REGISTER_LINES=[],cleanElement("tblContRegLoteMainTable")}function contractRegisterLoteAddContractFromCSV(){document.getElementById("txtContRegLoteCSV").value.split("/-.").forEach(t=>(function(t){var e=new _contract,n=t.split(";");e.contractid=n[0].trim().toUpperCase(),e.serie=e.contractid.replace(/[^A-Z]/g,""),e.sequencenumber=e.contractid.replace(/^\D+/g,""),e.oldcontractnumber=n[1].toUpperCase(),e.contractdate=setLocalDate(n[2],10),e.consumertype=n[3].toUpperCase(),(isNaN(e.consumertype)||""==e.consumertype)&&(e.consumertype=1);e.contractstatus=n[4].toUpperCase(),(isNaN(e.contractstatus)||""==e.contractstatus)&&(e.contractstatus=2);e.cil=n[5].toUpperCase();var i=cilToSerieSequence(e.cil);e.cilserie=i.serie,e.cilsequencenumber=i.seq,e.lastinvoicedate=setLocalDate(n[6],10),e.customerid=n[7].toUpperCase(),e.companyname=n[8].toUpperCase(),e.billingmunicipality=n[9].toUpperCase(),e.billingcomuna=n[10].toUpperCase(),e.billingneiborhood=n[11].toUpperCase(),e.billingstreetname=n[12].toUpperCase(),e.billingblock=n[13].toUpperCase(),e.billingbuildingnumber=n[14].toUpperCase(),contractRegisterLoteAddContract(e)})(t))}function contractRegisterLoteSave(t){if(contractRegisterLoteCheckMandatoryField())return!1;if(contractRegisterLoteCheckDucplicateInfo("contractid","contrato nº"))return!1;if(1==ST_SA_WAITING_SERVER)return alert("Aguardando resposta do servidor."),!1;var e=SYSTEM_USER_STATUS.companyId,n=SYSTEM_USER_STATUS.workplaceId;if("GME"==t){if(e=reviewString(document.getElementById("txtContRegLoteNUS")),isNaN(e)||""==e)return alert("Deve indicar o código NUS da empresa"),!1;if(n=reviewString(document.getElementById("txtContRegLoteDependency")),isNaN(n)||""==n)return alert("Deve indicar a filial de destino."),!1}var i=document.getElementById("divContRegLoteResulte");i.innerHTML="",showNotification("Esta operação pode demorar alguns minutos."),ST_SA_WAITING_SERVER=1;for(var o=0;o<CONTRACT_REGISTER_LINES.length;o++){var a=o+1,r=_contract;(r=CONTRACT_REGISTER_LINES[o]).companyid=e,r.dependencyid=n,r.statususer=SYSTEM_USER_STATUS.userId,1==r.status&&l(r,a)}function l(t,e){var n=new XMLHttpRequest,o="action=saveContractRegisterLote&contractInfo="+JSON.stringify(t),a=URL_SA_CONTRACT_X;n.open("POST",a,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==this.readyState&&200==this.status){ST_SA_WAITING_SERVER=0;try{var o=JSON.parse(n.responseText)}catch(t){return showHttpResponseText(n),!1}let a=document.createElement("span");a.innerHTML="Linha "+e+", contrato "+t.contractid+", nome "+t.companyname+". Mensagem: "+o.msg,i.appendChild(a),1!=o.status?(document.getElementById("rowContRegLote"+e).style.color="red",a.style.color="red"):(document.getElementById("rowContRegLote"+e).style.color="gray",t.status=0),hideNotification()}},n.send(o)}}function contractRegisterLoteCheckMandatoryField(){if(CONTRACT_REGISTER_LINES.length<=0)return alert("Não foram adicionadas linhas."),!1;for(var t=!1,e="",n=0;n<CONTRACT_REGISTER_LINES.length;n++){var i,o="";1==(i=CONTRACT_REGISTER_LINES[n]).status&&(""==i.contractid&&(o+="Deve indicar o nº de contrato. "),""==i.customerid&&(o+="Deve indicar o nº de cliente. "),""!=o&&(t=!0,e+=o="Linha "+Number(n+1)+": "+o+" <br>"))}return t&&alert(e),t}function contractRegisterLoteCheckDucplicateInfo(t,e){if(CONTRACT_REGISTER_LINES.length<=0)return alert("Não foram adicionadas linhas."),!1;for(var n=!1,i="",o=[],a=0;a<CONTRACT_REGISTER_LINES.length;a++){var r=CONTRACT_REGISTER_LINES[a];if(1==r.status&&!o.includes(r[t])){o[a]=r[t];for(var l=0;l<CONTRACT_REGISTER_LINES.length;l++)if(a!=l){var s=CONTRACT_REGISTER_LINES[l];1==s.status&&r[t]==s[t]&&(i+="Duplicado "+e+" "+r[t]+" Linhas "+Number(a+1)+" / "+Number(l+1)+" <br>",n=!0)}}}return n&&alert(i),n}function contractWithoutHydrometerListOnLoad(){try{showNotification(),checkUserStatusAfterExecute(function(){setLinkRequestStatus(),fillSelectDependencyFull("selContrWitHydDependency",-1,1),fillSelectConsumerTypeAqua("selContrWitHydWaterTax",-1),fillSelectMunicipality("selContrWitHydMunicipality",SYSTEM_USER_STATUS.provinceId,-1,-1),fillSelectNeiborhood("selContrWitHydNeiborhood",3,-1),setTriggerButtonByText("txtContrWitHydInitialDate","btContrWitHydViewAll"),setTriggerButtonByText("txtContrWitHydEndDate","btContrWitHydViewAll"),document.getElementById("chbContrWitHydShowDate").onclick=function(){setEnableDisableByCheckBox(this.id,"txtContrWitHydInitialDate","txtContrWitHydEndDate")},contractListDetails(),hideNotification()})}catch(t){showNotification(t.message,0)}}function contractWithouHydrometerListDetails(t=-1,e=-1){if(1==ST_SA_LISTING_SERVER)return showNotification("Procurando...",1),!1;var n={};if(n.companyId=SYSTEM_USER_STATUS.companyId,n.dependencyId=getElementValue("selContrWitHydDependency"),n.dependencyId<=0&&Number(SYSTEM_USER_STATUS.billingprofile)<BILLING_PROFILE_PARTNER_INDEX)return showNotification("Seleccionar uma filial.",0),!1;n.filterByDate=getElementChecked("chbContrWitHydShowDate"),n.initialDate=getElementValue("txtContrWitHydInitialDate"),n.endDate=getElementValue("txtContrWitHydEndDate"),n.consumertype=getElementValue("selContrWitHydWaterTax"),n.municipalityId=getElementValue("selContrWitHydMunicipality"),n.neiborhood=getElementValue("selContrWitHydNeiborhood"),n.customerid=t,n.userId=e,n.onlynumber=1,n.startIdx=0,n.endIdx=0,showNotification(),ST_SA_LISTING_SERVER=1;var i=new XMLHttpRequest,o="action=getContractWithoutHydrometerListDetails&filterInfo="+JSON.stringify(n),a=URL_SA_CONTRACT_X;i.open("POST",a,!0),i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.onreadystatechange=function(){if(4==i.readyState&&200==i.status){ST_SA_LISTING_SERVER=0;var t=JSON.parse(this.responseText),e=Number(t.n);e<=0?showNotification("Não encontrado.",0):hideDivFilter();var o=document.getElementById("numResultPageNumber"),a=document.getElementById("numResultItems");function r(){var t=Number(o.value),i=Number(a.value),r=(t-1)*i,l=r+i;l>e&&(l=e),n.totalItems=e,n.startIdx=r,n.endIdx=l,n.onlynumber=0,contractWithouHydrometerListFilter(n)}o.value=1,setResultTotalPages(o.id,a.id,e),o.onchange=function(){r()},a.onchange=function(){setResultTotalPages(o.id,a.id,e),r()},setElementInnerHtml("lbResultOnList",e),r()}},i.send(o)}function contractWithouHydrometerListFilter(t){try{showNotification();var e=document.getElementById("tblContrWitHydListTable");e.innerHTML="";var n=new XMLHttpRequest,i="action=getContractWithoutHydrometerListDetails&filterInfo="+JSON.stringify(t),o=URL_SA_CONTRACT_X;n.open("POST",o,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==n.readyState&&200==n.status){ST_SA_LISTING_SERVER=0;var i=JSON.parse(this.responseText),o={},a={},r={};setElementInnerHtml("lbResultOnList",t.endIdx+" / "+t.totalItems);for(var l=t.startIdx,s=0;s<i.length;s++){var c=i[s];let t=JSON.parse(c);var u=CONSUMER_TYPE_AQUA[Number(t.consumertype)],d=LINK_REQUEST_STATUS[Number(t.contractstatus)],m=t.billingneiborhood,C=getOperatorName(t.operatorName,t.statususer);addAmountResume(o,u,1),addAmountResume(a,d,1),addAmountResume(r,m,1),l+=1;let n=e.insertRow(-1);n.id="trContrList"+t.contractid,n.setAttribute("class","borderGray"+setSelectedRowBackground("SELECTED_ROW_CONTRACT_LIST",n.id));let R=n.insertCell(-1);R.setAttribute("class","colRowNumber"),R.innerHTML=l;let h=n.insertCell(-1);h.setAttribute("class","colProductId"),h.innerHTML=t.contractid;let T=n.insertCell(-1);T.setAttribute("class","colProductId"),T.innerHTML=t.cil;let E=n.insertCell(-1);E.setAttribute("class","colProductId"),E.innerHTML=setLocalDate(t.contractdate,10),n.insertCell(-1).innerHTML=u,n.insertCell(-1).innerHTML=t.companyname+" ["+t.customerid+"]",n.insertCell(-1).innerHTML=t.billingMunicipality,n.insertCell(-1).innerHTML=m,n.insertCell(-1).innerHTML=t.telephone1+" / "+t.telephone2+" / "+t.telephone3;var g="black",p="c ",S=t.contractstatus;2==S?p="textUpperUcase textBold":3==S&&(g="red");let L=n.insertCell(-1);L.setAttribute("class",p),L.innerHTML=d,L.style.color=g;let b=n.insertCell(-1);b.setAttribute("class","colProductId"),b.innerHTML=setLocalDate(t.statusdate,16);let y=n.insertCell(-1);y.setAttribute("class","colProductId"),y.innerHTML=C;let I=n.insertCell(-1);I.setAttribute("class","noPrint");let f=document.createElement("button");f.type="button",f.innerHTML="Contador";t.contractid;f.onclick=function(){setSelectedRowOnClick(n,"SELECTED_ROW_CONTRACT_LIST"),sessionStorage.setItem("contract_to_hydrometer",JSON.stringify(t)),window.location.assign("HydrometerList.php")},I.appendChild(f)}hideNotification()}},n.send(i)}catch(t){showNotification(t.message,0)}}